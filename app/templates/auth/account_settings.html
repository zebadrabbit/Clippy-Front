{% extends "base.html" %}

{% block content %}
<div class="container py-4">
    <div class="row">
        <!-- Sidebar -->
        <div class="col-md-3">
            {% set active = 'settings' %}
            {% include 'auth/_account_sidebar.html' with context %}
        </div>

        <!-- Main Content -->
        <div class="col-md-9">
            <h3 class="mb-4">
                <i class="bi bi-gear"></i>
                Account Settings
            </h3>

            <!-- Account Information Section -->
            <div class="card mb-4" id="account">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="bi bi-person-vcard"></i>
                        Account Information
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <h6 class="text-muted">Username</h6>
                            <p class="mb-0">{{ current_user.username }}</p>
                            <small class="text-muted">Username cannot be changed</small>
                        </div>
                        <div class="col-md-6">
                            <h6 class="text-muted">Member Since</h6>
                            <p class="mb-0">{{ current_user.created_at.strftime('%B %d, %Y') }}</p>
                        </div>
                    </div>

                    <hr>

                    <!-- Email Change Section -->
                    <div class="row">
                        <div class="col-md-12">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <div>
                                    <h6 class="text-muted mb-1">Email Address</h6>
                                    <p class="mb-0">
                                        {{ current_user.email }}
                                        {% if current_user.email_verified %}
                                            <span class="badge bg-success ms-2">
                                                <i class="bi bi-check-circle"></i> Verified
                                            </span>
                                        {% else %}
                                            <span class="badge bg-warning ms-2">
                                                <i class="bi bi-exclamation-triangle"></i> Unverified
                                            </span>
                                        {% endif %}
                                    </p>
                                </div>
                                <button class="btn btn-outline-primary btn-sm" data-bs-toggle="modal" data-bs-target="#changeEmailModal">
                                    <i class="bi bi-pencil"></i> Change Email
                                </button>
                            </div>
                            {% if not current_user.email_verified %}
                            <div class="alert alert-warning">
                                <i class="bi bi-exclamation-triangle"></i>
                                Your email address is not verified. Please check your inbox for a verification email.
                                <button class="btn btn-sm btn-outline-warning ms-2">Resend Verification Email</button>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Security Section -->
            <div class="card mb-4" id="security">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="bi bi-shield-check"></i>
                        Security
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6>Password</h6>
                            <p class="text-muted small">
                                Last changed:
                                {% if current_user.password_changed_at %}
                                    {{ current_user.password_changed_at.strftime('%B %d, %Y') }}
                                {% else %}
                                    Never
                                {% endif %}
                            </p>
                            <button class="btn btn-outline-primary btn-sm" data-bs-toggle="modal" data-bs-target="#changePasswordModal">
                                <i class="bi bi-key"></i> Change Password
                            </button>
                        </div>
                        <div class="col-md-6">
                            <h6>Two-Factor Authentication</h6>
                            <p class="text-muted small">
                                <i class="bi bi-x-circle text-danger"></i> Not enabled
                            </p>
                            <button class="btn btn-outline-secondary btn-sm" disabled>
                                <i class="bi bi-shield-plus"></i> Enable 2FA (Coming Soon)
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Privacy Section -->
            <div class="card mb-4" id="privacy">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="bi bi-eye-slash"></i>
                        Privacy
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-12">
                            <h6>Data Visibility</h6>
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="checkbox" id="profilePublic">
                                <label class="form-check-label" for="profilePublic">
                                    Make my profile public
                                </label>
                            </div>
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="checkbox" id="showProjects">
                                <label class="form-check-label" for="showProjects">
                                    Show my projects to other users
                                </label>
                            </div>
                            <div class="form-check mb-3">
                                <input class="form-check-input" type="checkbox" id="activityTracking" checked>
                                <label class="form-check-label" for="activityTracking">
                                    Allow activity tracking for service improvement
                                </label>
                            </div>
                            <button class="btn btn-primary btn-sm">Save Privacy Settings</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Notifications Section -->
            <div class="card mb-4" id="notifications">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="bi bi-bell"></i>
                        Notifications
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6>Email Notifications</h6>
                            <div class="form-check mb-2">
                                <input class="form-check-input notification-pref" type="checkbox" id="emailCompilationComplete" data-field="email_compilation_complete">
                                <label class="form-check-label" for="emailCompilationComplete">
                                    Compilation completed
                                </label>
                            </div>
                            <div class="form-check mb-2">
                                <input class="form-check-input notification-pref" type="checkbox" id="emailCompilationFailed" data-field="email_compilation_failed">
                                <label class="form-check-label" for="emailCompilationFailed">
                                    Compilation failed
                                </label>
                            </div>
                            <div class="form-check mb-2">
                                <input class="form-check-input notification-pref" type="checkbox" id="emailTeamInvitation" data-field="email_team_invitation">
                                <label class="form-check-label" for="emailTeamInvitation">
                                    Team invitations
                                </label>
                            </div>
                            <div class="form-check mb-2">
                                <input class="form-check-input notification-pref" type="checkbox" id="emailMemberAdded" data-field="email_team_member_added">
                                <label class="form-check-label" for="emailMemberAdded">
                                    Team member added
                                </label>
                            </div>
                            <div class="form-check mb-2">
                                <input class="form-check-input notification-pref" type="checkbox" id="emailProjectShared" data-field="email_project_shared">
                                <label class="form-check-label" for="emailProjectShared">
                                    Project shared with team
                                </label>
                            </div>
                            <div class="form-check mb-3">
                                <input class="form-check-input notification-pref" type="checkbox" id="emailMention" data-field="email_mention">
                                <label class="form-check-label" for="emailMention">
                                    Mentions and replies
                                </label>
                            </div>

                            <hr class="my-3">

                            <h6>Email Digest</h6>
                            <div class="form-check mb-2">
                                <input class="form-check-input notification-pref" type="checkbox" id="emailDigestEnabled" data-field="email_digest_enabled">
                                <label class="form-check-label" for="emailDigestEnabled">
                                    Enable daily/weekly digest emails
                                </label>
                            </div>
                            <div id="digestSettings" style="display: none;">
                                <div class="mb-2">
                                    <label for="digestFrequency" class="form-label small">Frequency</label>
                                    <select class="form-select form-select-sm notification-pref" id="digestFrequency" data-field="email_digest_frequency">
                                        <option value="daily">Daily</option>
                                        <option value="weekly">Weekly</option>
                                    </select>
                                </div>
                                <div class="mb-2">
                                    <label for="digestTime" class="form-label small">Time (24-hour format)</label>
                                    <input type="time" class="form-control form-control-sm notification-pref" id="digestTime" data-field="email_digest_time">
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <h6>In-App Notifications</h6>
                            <div class="form-check mb-2">
                                <input class="form-check-input notification-pref" type="checkbox" id="inappAllEnabled" data-field="inapp_all_enabled">
                                <label class="form-check-label" for="inappAllEnabled">
                                    Enable in-app notifications
                                </label>
                            </div>
                            <small class="text-muted">
                                In-app notifications appear in the notification bell at the top of the page.
                            </small>
                        </div>
                    </div>
                    <hr>
                    <div class="d-flex justify-content-end">
                        <button class="btn btn-primary" id="saveNotificationPrefs">
                            <i class="bi bi-check-lg"></i> Save Notification Preferences
                        </button>
                    </div>
                </div>
            </div>

            <script>
            // Load notification preferences on page load
            document.addEventListener('DOMContentLoaded', function() {
                loadNotificationPreferences();

                // Show/hide digest settings based on checkbox
                document.getElementById('emailDigestEnabled').addEventListener('change', function() {
                    document.getElementById('digestSettings').style.display = this.checked ? 'block' : 'none';
                });

                // Save preferences
                document.getElementById('saveNotificationPrefs').addEventListener('click', saveNotificationPreferences);
            });

            function loadNotificationPreferences() {
                fetch('/api/notification-preferences')
                    .then(response => response.json())
                    .then(data => {
                        const prefs = data.preferences;

                        // Set all checkboxes and fields
                        document.querySelectorAll('.notification-pref').forEach(elem => {
                            const field = elem.dataset.field;
                            if (field in prefs) {
                                if (elem.type === 'checkbox') {
                                    elem.checked = prefs[field];
                                } else if (elem.type === 'time') {
                                    elem.value = prefs[field] || '09:00';
                                } else {
                                    elem.value = prefs[field];
                                }
                            }
                        });

                        // Show digest settings if enabled
                        document.getElementById('digestSettings').style.display =
                            prefs.email_digest_enabled ? 'block' : 'none';
                    })
                    .catch(error => {
                        console.error('Error loading preferences:', error);
                        showToast('Error loading notification preferences', 'error');
                    });
            }

            function saveNotificationPreferences() {
                const preferences = {};

                document.querySelectorAll('.notification-pref').forEach(elem => {
                    const field = elem.dataset.field;
                    if (elem.type === 'checkbox') {
                        preferences[field] = elem.checked;
                    } else {
                        preferences[field] = elem.value;
                    }
                });

                fetch('/api/notification-preferences', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(preferences)
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showToast('Notification preferences saved successfully', 'success');
                    } else {
                        showToast(data.error || 'Error saving preferences', 'error');
                    }
                })
                .catch(error => {
                    console.error('Error saving preferences:', error);
                    showToast('Error saving notification preferences', 'error');
                });
            }

            function showToast(message, type) {
                // Create a simple toast notification
                const toastHtml = `
                    <div class="toast align-items-center text-white bg-${type === 'success' ? 'success' : 'danger'} border-0" role="alert">
                        <div class="d-flex">
                            <div class="toast-body">${message}</div>
                            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                        </div>
                    </div>
                `;

                // Append to body or toast container
                const container = document.querySelector('.toast-container') || document.body;
                container.insertAdjacentHTML('beforeend', toastHtml);

                // Show toast
                const toastEl = container.lastElementChild;
                const toast = new bootstrap.Toast(toastEl);
                toast.show();

                // Remove after hidden
                toastEl.addEventListener('hidden.bs.toast', () => toastEl.remove());
            }
            </script>

            <!-- Preferences Section -->
            <div class="card mb-4" id="preferences">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="bi bi-sliders"></i>
                        Preferences
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6>Video Processing Defaults</h6>
                            <div class="mb-3">
                                <label for="defaultResolution" class="form-label">Default Output Resolution</label>
                                <select class="form-select" id="defaultResolution">
                                    <option value="720p">720p HD</option>
                                    <option value="1080p" selected>1080p Full HD</option>
                                    <option value="1440p">1440p 2K</option>
                                    <option value="2160p">2160p 4K</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="defaultFormat" class="form-label">Default Output Format</label>
                                <select class="form-select" id="defaultFormat">
                                    <option value="mp4" selected>MP4</option>
                                    <option value="mov">MOV</option>
                                    <option value="avi">AVI</option>
                                    <option value="webm">WebM</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <h6>Interface Preferences</h6>
                            <div class="mb-3">
                                <label for="theme" class="form-label">Theme</label>
                                <select class="form-select" id="theme">
                                    <option value="light" selected>Light</option>
                                    <option value="dark">Dark</option>
                                    <option value="auto">Auto (System)</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="language" class="form-label">Language</label>
                                <select class="form-select" id="language">
                                    <option value="en" selected>English</option>
                                    <option value="es">Español</option>
                                    <option value="fr">Français</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="d-flex justify-content-end">
                        <button class="btn btn-primary">Save Preferences</button>
                    </div>
                </div>
            </div>

            <!-- Connected Services Section -->
            <div class="card mb-4" id="integrations">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="bi bi-link-45deg"></i>
                        Connected Services
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <div class="d-flex align-items-center">
                                <i class="bi bi-discord text-primary fs-3 me-3"></i>
                                <div class="flex-grow-1">
                                    <h6 class="mb-0">Discord</h6>
                                    {% if current_user.discord_user_id %}
                                        <small class="text-success">Connected (ID: {{ current_user.discord_user_id }})</small>
                                    {% else %}
                                        <small class="text-muted">Not connected</small>
                                    {% endif %}
                                </div>
                                <div>
                                    {% if current_user.discord_user_id %}
                                        <form method="POST" action="{{ url_for('auth.disconnect_discord') }}" class="d-inline">
                                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                            <button type="submit" class="btn btn-outline-danger btn-sm">Disconnect</button>
                                        </form>
                                    {% else %}
                                        <button class="btn btn-outline-primary btn-sm" data-bs-toggle="modal" data-bs-target="#connectDiscordModal">Connect</button>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <div class="d-flex align-items-center">
                                <i class="bi bi-twitch text-purple fs-3 me-3"></i>
                                <div class="flex-grow-1">
                                    <h6 class="mb-0">Twitch</h6>
                                    {% if current_user.twitch_username %}
                                        <small class="text-success">Connected (@{{ current_user.twitch_username }})</small>
                                    {% else %}
                                        <small class="text-muted">Not connected</small>
                                    {% endif %}
                                </div>
                                <div>
                                    {% if current_user.twitch_username %}
                                        <form method="POST" action="{{ url_for('auth.disconnect_twitch') }}" class="d-inline">
                                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                            <button type="submit" class="btn btn-outline-danger btn-sm">Disconnect</button>
                                        </form>
                                    {% else %}
                                        <button class="btn btn-outline-primary btn-sm" data-bs-toggle="modal" data-bs-target="#connectTwitchModal">Connect</button>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Active Sessions Section -->
            <div class="card mb-4" id="sessions">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="bi bi-clock-history"></i>
                        Active Sessions
                    </h5>
                </div>
                <div class="card-body">
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle"></i>
                        Session management coming soon. You'll be able to view and revoke active sessions from different devices.
                    </div>
                    <div class="mb-3">
                        <h6>Current Session</h6>
                        <p class="text-muted small mb-1">
                            <i class="bi bi-laptop"></i> This device
                        </p>
                        <p class="text-muted small mb-0">
                            Last activity: Just now
                        </p>
                    </div>
                </div>
            </div>

            <!-- Danger Zone -->
            <div class="card border-danger" id="danger">
                <div class="card-header bg-danger bg-opacity-10 border-danger">
                    <h5 class="mb-0 text-danger">
                        <i class="bi bi-exclamation-triangle"></i>
                        Danger Zone
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-8">
                            <h6>Delete Account</h6>
                            <p class="text-muted mb-0">
                                Once you delete your account, there is no going back. This will permanently delete
                                your account, all your projects, media files, and remove all associated data.
                            </p>
                        </div>
                        <div class="col-md-4 text-end">
                            <button class="btn btn-outline-danger" data-bs-toggle="modal" data-bs-target="#deleteAccountModal">
                                <i class="bi bi-trash"></i> Delete Account
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Change Email Modal -->
<div class="modal fade" id="changeEmailModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-envelope"></i> Change Email Address
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="{{ url_for('auth.change_email') }}">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <div class="modal-body">
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle"></i>
                        You'll need to verify your new email address before it becomes active.
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Current Email</label>
                        <input type="email" class="form-control" value="{{ current_user.email }}" disabled>
                    </div>
                    <div class="mb-3">
                        <label for="newEmail" class="form-label">New Email Address</label>
                        <input type="email" class="form-control" id="newEmail" name="new_email" required placeholder="Enter new email address">
                    </div>
                    <div class="mb-3">
                        <label for="currentPasswordEmail" class="form-label">Current Password</label>
                        <input type="password" class="form-control" id="currentPasswordEmail" name="current_password" required placeholder="Confirm your password">
                        <div class="form-text">For security, please enter your current password</div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Update Email</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Change Password Modal -->
<div class="modal fade" id="changePasswordModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-key"></i> Change Password
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="{{ url_for('auth.change_password') }}">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="currentPassword" class="form-label">Current Password</label>
                        <input type="password" class="form-control" id="currentPassword" name="current_password" required>
                    </div>
                    <div class="mb-3">
                        <label for="newPassword" class="form-label">New Password</label>
                        <input type="password" class="form-control" id="newPassword" name="new_password" required minlength="8">
                        <div class="form-text">Minimum 8 characters</div>
                    </div>
                    <div class="mb-3">
                        <label for="confirmPassword" class="form-label">Confirm New Password</label>
                        <input type="password" class="form-control" id="confirmPassword" name="confirm_password" required>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Change Password</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Delete Account Modal -->
<div class="modal fade" id="deleteAccountModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header border-danger">
                <h5 class="modal-title text-danger">
                    <i class="bi bi-exclamation-triangle"></i> Delete Account
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-danger">
                    <h6 class="alert-heading">Warning!</h6>
                    This action cannot be undone. This will permanently delete your account and remove all data.
                </div>
                <p>Please type your username <strong>{{ current_user.username }}</strong> to confirm:</p>
                <form method="POST" action="{{ url_for('auth.delete_account') }}" id="deleteAccountForm">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <div class="mb-3">
                        <input type="text" class="form-control" id="confirmUsername" name="confirm_username"
                               placeholder="Type your username here" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="submit" form="deleteAccountForm" class="btn btn-danger" id="deleteAccountBtn" disabled>
                    Delete Account
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Connect Discord Modal -->
<div class="modal fade" id="connectDiscordModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-discord"></i> Connect Discord</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="{{ url_for('auth.connect_discord') }}">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Discord User ID</label>
                        <input type="text" class="form-control" name="discord_user_id" placeholder="e.g. 123456789012345678" required>
                        <div class="form-text">Temporary placeholder until OAuth. You can find this via Discord settings (Developer Mode).</div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Connect</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Connect Twitch Modal -->
<div class="modal fade" id="connectTwitchModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-twitch"></i> Connect Twitch</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="{{ url_for('auth.connect_twitch') }}">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Twitch Username</label>
                        <input type="text" class="form-control" name="twitch_username" placeholder="e.g. yourchannel" required>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Connect</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script id="account-settings-config" type="application/json">{ "expectedUsername": "{{ current_user.username }}" }</script>
<script src="{{ url_for('static', filename='js/account_settings.js') }}"></script>
{% endblock %}

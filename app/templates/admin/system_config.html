{% extends "base.html" %}

{% block styles %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/admin-dark.css') }}">
{% endblock %}

{% block content %}
<div class="container py-4">
  <div class="row">
    <h2 class="mb-3"><i class="bi bi-gear"></i> Admin Dashboard</h2>
    <div class="col-12 col-lg-3 mb-3 mb-lg-0 admin-sidebar">
      {% set active_page = 'config' %}
      {% set config_section = section or (request.args.get('section') or '') %}
      {% include 'admin/_includes/sidebar.html' with context %}
    </div>
    <div class="col-12 col-lg-9 admin-content">
      {% if not section %}
      <!-- Configuration overview -->
      <div class="card mb-3">
        <div class="card-header d-flex align-items-center gap-2">
          <i class="bi bi-info-circle"></i> <strong>Configuration overview</strong>
        </div>
        <div class="card-body">
          <div class="row g-3">
            <div class="col-md-6">
              <div class="small text-muted">.env file</div>
              <div class="d-flex align-items-center gap-2">
                <code class="text-break">{{ config_info.env.path }}</code>
                {% if config_info.env.exists %}
                  <span class="badge bg-success-subtle text-success">exists</span>
                {% else %}
                  <span class="badge bg-warning-subtle text-warning">missing</span>
                {% endif %}
                <span class="badge bg-light text-muted">R: {{ 'yes' if config_info.env.read else 'no' }}</span>
                <span class="badge bg-light text-muted">W: {{ 'yes' if config_info.env.write else 'no' }}</span>
              </div>
            </div>
            <div class="col-md-6">
              <div class="small text-muted">settings.py</div>
              <div class="d-flex align-items-center gap-2">
                <code class="text-break">{{ config_info.settings_py.path }}</code>
                {% if config_info.settings_py.exists %}
                  <span class="badge bg-success-subtle text-success">exists</span>
                {% else %}
                  <span class="badge bg-warning-subtle text-warning">missing</span>
                {% endif %}
                <span class="badge bg-light text-muted">R: {{ 'yes' if config_info.settings_py.read else 'no' }}</span>
                <span class="badge bg-light text-muted">W: {{ 'yes' if config_info.settings_py.write else 'no' }}</span>
              </div>
            </div>
            <div class="col-md-6">
              <div class="small text-muted">Instance path</div>
              <div class="d-flex align-items-center gap-2">
                <code class="text-break">{{ config_info.instance_path.path }}</code>
                <span class="badge bg-light text-muted">R: {{ 'yes' if config_info.instance_path.read else 'no' }}</span>
                <span class="badge bg-light text-muted">W: {{ 'yes' if config_info.instance_path.write else 'no' }}</span>
              </div>
            </div>
            <div class="col-md-6">
              <div class="small text-muted">Uploads directory</div>
              <div class="d-flex align-items-center gap-2">
                <code class="text-break">{{ config_info.uploads_dir.path }}</code>
                {% if config_info.uploads_dir.exists %}
                  <span class="badge bg-success-subtle text-success">exists</span>
                {% else %}
                  <span class="badge bg-warning-subtle text-warning">missing</span>
                {% endif %}
                <span class="badge bg-light text-muted">R: {{ 'yes' if config_info.uploads_dir.read else 'no' }}</span>
                <span class="badge bg-light text-muted">W: {{ 'yes' if config_info.uploads_dir.write else 'no' }}</span>
              </div>
            </div>
          </div>
          <hr>
          <div class="row g-3">
            <div class="col-md-6">
              <div class="small text-muted">Database</div>
              <code class="text-break">{{ config_info.database }}</code>
            </div>
            <div class="col-md-6">
              <div class="small text-muted">Redis</div>
              <code class="text-break">{{ config_info.redis }}</code>
            </div>
            <div class="col-12">
              <div class="small text-muted">Environment</div>
              <span class="badge bg-light text-muted">DEBUG: {{ 'on' if config_info.environment.debug else 'off' }}</span>
              <span class="badge bg-light text-muted">TESTING: {{ 'on' if config_info.environment.testing else 'off' }}</span>
            </div>
          </div>
          {% if security_warnings %}
          <div class="alert alert-warning mt-3" role="alert">
            <div class="fw-semibold mb-1">Precautions</div>
            <ul class="mb-0">
              {% for w in security_warnings %}
                <li>{{ w }}</li>
              {% endfor %}
            </ul>
          </div>
          {% endif %}
        </div>
      </div>
      {% endif %}

      {% if section %}
      {% if section == 'logging' %}
      <!-- Logging Diagnostics -->
      <div class="card mb-3">
        <div class="card-header d-flex align-items-center gap-2">
          <i class="bi bi-file-earmark-text"></i> <strong>Logging Status</strong>
        </div>
        <div class="card-body">
          <div class="row g-3">
            <div class="col-md-6">
              <div class="small text-muted">Log Directory</div>
              <div class="d-flex align-items-center gap-2">
                <code class="text-break">{{ config_info.logging.log_dir }}</code>
                {% if config_info.logging.log_dir_exists %}
                  <span class="badge bg-success-subtle text-success">exists</span>
                {% else %}
                  <span class="badge bg-warning-subtle text-warning">missing</span>
                {% endif %}
                <span class="badge bg-light text-muted">W: {{ 'yes' if config_info.logging.log_dir_writable else 'no' }}</span>
              </div>
            </div>
            <div class="col-md-6">
              <div class="small text-muted">Current Log Level</div>
              <span class="badge bg-primary-subtle text-primary">{{ config_info.logging.current_level }}</span>
            </div>
            <div class="col-md-6">
              <div class="small text-muted">App Log</div>
              <div class="d-flex align-items-center gap-2">
                <code class="text-break">{{ config_info.logging.app_log }}</code>
                {% if config_info.logging.app_log_exists %}
                  <span class="badge bg-success-subtle text-success">exists</span>
                {% endif %}
              </div>
            </div>
            <div class="col-md-6">
              <div class="small text-muted">Worker Log</div>
              <div class="d-flex align-items-center gap-2">
                <code class="text-break">{{ config_info.logging.worker_log }}</code>
                {% if config_info.logging.worker_log_exists %}
                  <span class="badge bg-success-subtle text-success">exists</span>
                {% endif %}
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="alert alert-info small">
        <strong>Note:</strong> Log files rotate at 10 MB, keeping 5 backups. Change <code>LOG_LEVEL</code> to DEBUG/INFO/WARNING/ERROR as needed.
      </div>
      {% endif %}

      {% if section == 'ffmpeg' %}
      <!-- FFmpeg Diagnostics -->
      <div class="card mb-3">
        <div class="card-header d-flex align-items-center gap-2">
          <i class="bi bi-film"></i> <strong>FFmpeg Status</strong>
        </div>
        <div class="card-body">
          <div class="row g-3">
            <div class="col-md-6">
              <div class="small text-muted">FFmpeg Binary</div>
              <code class="text-break">{{ config_info.ffmpeg.binary }}</code>
              {% if config_info.ffmpeg.binary_exists is not none %}
                {% if config_info.ffmpeg.binary_exists %}
                  <span class="badge bg-success-subtle text-success ms-2">exists</span>
                {% else %}
                  <span class="badge bg-danger-subtle text-danger ms-2">not found</span>
                {% endif %}
              {% endif %}
            </div>
            <div class="col-md-6">
              <div class="small text-muted">NVENC Hardware Acceleration</div>
              {% if config_info.ffmpeg.nvenc_available %}
                <span class="badge bg-success-subtle text-success">Available</span>
                <small class="text-muted ms-2">{{ config_info.ffmpeg.nvenc_reason }}</small>
              {% else %}
                <span class="badge bg-warning-subtle text-warning">Not Available</span>
                <small class="text-muted ms-2">{{ config_info.ffmpeg.nvenc_reason }}</small>
              {% endif %}
            </div>
            <div class="col-md-6">
              <div class="small text-muted">Creator Overlay</div>
              {% if config_info.ffmpeg.overlay_enabled %}
                <span class="badge bg-success-subtle text-success">Enabled</span>
              {% else %}
                <span class="badge bg-secondary-subtle text-secondary">Disabled</span>
              {% endif %}
            </div>
            <div class="col-md-6">
              <div class="small text-muted">Font File (for overlay)</div>
              {% if config_info.ffmpeg.fontfile %}
                <code class="text-break">{{ config_info.ffmpeg.fontfile }}</code>
                {% if config_info.ffmpeg.fontfile_exists %}
                  <span class="badge bg-success-subtle text-success ms-2">exists</span>
                {% else %}
                  <span class="badge bg-danger-subtle text-danger ms-2">not found</span>
                {% endif %}
              {% else %}
                <span class="text-muted">None (overlay disabled)</span>
              {% endif %}
            </div>
          </div>
          <hr>
          <div class="row g-3">
            <div class="col-12"><strong class="small text-muted">Current Encoding Defaults</strong></div>
            <div class="col-md-3">
              <div class="small text-muted">Bitrate</div>
              <code>{{ config_info.ffmpeg.defaults.bitrate }}</code>
            </div>
            <div class="col-md-3">
              <div class="small text-muted">Audio Bitrate</div>
              <code>{{ config_info.ffmpeg.defaults.audio_bitrate }}</code>
            </div>
            <div class="col-md-3">
              <div class="small text-muted">CQ/CRF</div>
              <code>{{ config_info.ffmpeg.defaults.cq }}</code>
            </div>
            <div class="col-md-3">
              <div class="small text-muted">NVENC Preset</div>
              <code>{{ config_info.ffmpeg.defaults.nvenc_preset }}</code>
            </div>
            <div class="col-md-3">
              <div class="small text-muted">GOP Size</div>
              <code>{{ config_info.ffmpeg.defaults.gop }}</code>
            </div>
            <div class="col-md-3">
              <div class="small text-muted">RC Lookahead</div>
              <code>{{ config_info.ffmpeg.defaults.rc_lookahead }}</code>
            </div>
            <div class="col-md-3">
              <div class="small text-muted">AQ Strength</div>
              <code>{{ config_info.ffmpeg.defaults.aq_strength }}</code>
            </div>
          </div>
        </div>
      </div>
      <div class="alert alert-info small">
        <strong>NVENC:</strong> Hardware acceleration requires NVIDIA GPU with NVENC support and proper drivers.
        <strong>Overlay:</strong> Displays creator name and game info on clips (3-10 seconds).
      </div>
      {% endif %}

      {% if section == 'ytdlp' %}
      <!-- yt-dlp Diagnostics -->
      <div class="card mb-3">
        <div class="card-header d-flex align-items-center gap-2">
          <i class="bi bi-download"></i> <strong>yt-dlp Status</strong>
        </div>
        <div class="card-body">
          <div class="row g-3">
            <div class="col-md-6">
              <div class="small text-muted">yt-dlp Binary</div>
              <code class="text-break">{{ config_info.ytdlp.binary }}</code>
              {% if config_info.ytdlp.binary_exists is not none %}
                {% if config_info.ytdlp.binary_exists %}
                  <span class="badge bg-success-subtle text-success ms-2">exists</span>
                {% else %}
                  <span class="badge bg-danger-subtle text-danger ms-2">not found</span>
                {% endif %}
              {% endif %}
            </div>
            <div class="col-md-6">
              <div class="small text-muted">Cookies File</div>
              {% if config_info.ytdlp.cookies_path %}
                <code class="text-break">{{ config_info.ytdlp.cookies_path }}</code>
                {% if config_info.ytdlp.cookies_exists %}
                  <span class="badge bg-success-subtle text-success ms-2">exists</span>
                {% else %}
                  <span class="badge bg-warning-subtle text-warning ms-2">not found</span>
                {% endif %}
              {% else %}
                <span class="text-muted">Not configured</span>
              {% endif %}
            </div>
          </div>
        </div>
      </div>
      <div class="alert alert-info small">
        <strong>Cookies:</strong> Required for downloading age-restricted or member-only content. Export from browser using a cookie extension.
      </div>
      {% endif %}

      {% if section == 'email' %}
      <div class="alert alert-info small">
        For security, SMTP password must be set via environment (.env) as <code>SMTP_PASSWORD</code>.
        {% if config_info.email.smtp_password_set %}
          <span class="ms-2 badge bg-success-subtle text-success">Password present</span>
        {% else %}
          <span class="ms-2 badge bg-warning-subtle text-warning">Password missing</span>
        {% endif %}
      </div>
      <div class="card mb-3">
        <div class="card-header d-flex align-items-center gap-2">
          <i class="bi bi-envelope-paper"></i> <strong>Send Test Email</strong>
        </div>
        <div class="card-body">
          <form method="post" class="row g-3 align-items-end">
            <input type="hidden" name="action" value="send_test_email">
            <div class="col-md-8">
              <label class="form-label">To address</label>
              <input class="form-control" type="email" name="test_to" placeholder="name@example.com" required>
            </div>
            <div class="col-md-4">
              <button class="btn btn-outline-primary w-100" type="submit"><i class="bi bi-send"></i> Send Test</button>
            </div>
          </form>
          <div class="form-text mt-2">From: {{ values.get('EMAIL_FROM_ADDRESS') or config_info.email.from or 'no-reply@example.com' }}</div>
        </div>
      </div>
      {% endif %}
      {% if section == 'pagination' %}
      <!-- Watermark upload (Display section) -->
      <div class="card mb-3">
        <div class="card-header d-flex align-items-center gap-2">
          <i class="bi bi-image"></i> <strong>Watermark Image</strong>
        </div>
        <div class="card-body">
          <form method="post" enctype="multipart/form-data" class="d-flex flex-column gap-3">
            <input type="hidden" name="action" value="upload_watermark">
            <div>
              <label class="form-label">Upload Watermark</label>
              <input class="form-control" type="file" name="watermark" accept="image/*">
              {% if values.get('WATERMARK_PATH') %}
                <small class="text-muted">Current: {{ values.get('WATERMARK_PATH') }}</small>
              {% else %}
                <small class="text-muted">No watermark uploaded</small>
              {% endif %}
            </div>
            <div>
              <button class="btn btn-outline-primary" type="submit"><i class="bi bi-upload"></i> Upload Watermark</button>
            </div>
          </form>
        </div>
      </div>
      {% endif %}

      <form method="post">
        <input type="hidden" name="action" value="save">

        {% for section, items in groups.items() %}
        <div class="card mb-3">
          <div class="card-header"><strong>{{ section }}</strong></div>
          <div class="card-body">
            <div class="row g-3">
              {% for item in items %}
              <div class="col-md-6">
                <label class="form-label">{{ item.label }}</label>
                {% if item.type == 'bool' %}
                  {% set checked = values.get(item.key, '').lower() in ['1','true','yes','on'] %}
                  <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" name="setting_{{ item.key }}" {% if checked %}checked{% endif %}>
                    <span class="form-text">Enable/Disable</span>
                  </div>
                {% else %}
                  <input class="form-control" name="setting_{{ item.key }}" value="{{ values.get(item.key, '') }}">
                {% endif %}
              </div>
              {% endfor %}
            </div>
          </div>
        </div>
        {% endfor %}

        <div class="d-flex justify-content-end">
          <button class="btn btn-primary" type="submit"><i class="bi bi-save"></i> Save Changes</button>
        </div>
      </form>
      {% endif %}

      {% if not section %}
      <!-- Danger Zone: Restart controls -->
      <div class="card border-danger mt-4">
        <div class="card-header bg-danger-subtle text-danger d-flex align-items-center gap-2">
          <i class="bi bi-exclamation-triangle"></i> <strong>Danger Zone</strong>
        </div>
        <div class="card-body">
          <p class="text-muted small mb-3">Restarting may interrupt active jobs. Ensure background tasks are idle or safe to interrupt.</p>
          <div class="d-flex gap-2">
            <form method="post" action="{{ url_for('admin.restart', target='web') }}">
              <button class="btn btn-outline-danger" type="submit" onclick="return confirm('Restart web server?');"><i class="bi bi-arrow-repeat"></i> Restart Web</button>
            </form>
            <form method="post" action="{{ url_for('admin.restart', target='workers') }}">
              <button class="btn btn-outline-warning" type="submit" onclick="return confirm('Restart all workers?');"><i class="bi bi-cpu"></i> Restart Workers</button>
            </form>
          </div>
        </div>
      </div>
      {% endif %}
    </div>
  </div>
</div>
{% endblock %}

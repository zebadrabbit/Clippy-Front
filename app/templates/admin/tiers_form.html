{% extends "base.html" %}

{% block content %}
<div class="container py-4">
  <div class="row">
    <h2 class="mb-3"><i class="bi bi-gear"></i> Admin Dashboard</h2>
    <div class="col-12 col-lg-3 mb-3 mb-lg-0">
      {% set active_page = 'tiers' %}
      {% include 'admin/_includes/sidebar.html' with context %}
    </div>
    <div class="col-12 col-lg-9">
      <h3 class="mb-3">{{ 'Edit Tier' if tier else 'Create Tier' }}</h3>
      <form method="POST">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <div class="row">
          <div class="col-md-7">
            <div class="card mb-3">
              <div class="card-header">Details</div>
              <div class="card-body">
                <div class="mb-3">
                  <label class="form-label">Name</label>
                  <input class="form-control" name="name" value="{{ tier.name if tier else '' }}" required>
                </div>
                <div class="mb-3">
                  <label class="form-label">Description</label>
                  <textarea class="form-control" rows="2" name="description">{{ tier.description if tier else '' }}</textarea>
                </div>
                <div class="mb-3">
                  <label class="form-label">Monthly Price (USD)</label>
                  <input class="form-control" name="monthly_price" type="number" min="0" step="0.01" placeholder="e.g. 19.99" value="{% if tier and tier.monthly_price_cents is not none %}{{ '%.2f'|format(tier.monthly_price_cents / 100) }}{% endif %}">
                  <div class="form-text">Leave blank for custom/contact pricing. Use 0 for free tier.</div>
                </div>
                <div class="row">
                  <div class="col-md-4 mb-3">
                    <label class="form-label">Max Output Resolution</label>
                    <select class="form-select" name="max_output_resolution">
                      <option value="" {% if not tier or not tier.max_output_resolution %}selected{% endif %}>Unlimited</option>
                      {% set res = (tier.max_output_resolution.lower() if tier and tier.max_output_resolution else '') %}
                      <option value="720p" {% if res == '720p' %}selected{% endif %}>720p</option>
                      <option value="1080p" {% if res == '1080p' %}selected{% endif %}>1080p</option>
                      <option value="1440p" {% if res == '1440p' %}selected{% endif %}>1440p (2K)</option>
                      <option value="2160p" {% if res == '2160p' %}selected{% endif %}>2160p (4K)</option>
                    </select>
                    <div class="form-text">Upper bound for project output resolution.</div>
                  </div>
                  <div class="col-md-4 mb-3">
                    <label class="form-label">Max FPS</label>
                    <input class="form-control" name="max_fps" type="number" min="1" step="1" placeholder="e.g. 30" value="{% if tier and tier.max_fps is not none %}{{ tier.max_fps }}{% endif %}">
                    <div class="form-text">Leave blank for unlimited.</div>
                  </div>
                  <div class="col-md-4 mb-3">
                    <label class="form-label">Max Clips per Project</label>
                    <input class="form-control" name="max_clips_per_project" type="number" min="1" step="1" placeholder="e.g. 20" value="{% if tier and tier.max_clips_per_project is not none %}{{ tier.max_clips_per_project }}{% endif %}">
                    <div class="form-text">Leave blank for unlimited.</div>
                  </div>
                </div>
                <div class="mb-3">
                  <label class="form-label">Storage Limit (MB)</label>
                  <input class="form-control" name="storage_limit_mb" type="number" min="0" step="1" placeholder="e.g. 1024 for 1 GB" value="{% if tier and tier.storage_limit_bytes is not none %}{{ (tier.storage_limit_bytes/1024/1024)|round(0, 'floor')|int }}{% endif %}">
                  <div class="form-text">Leave blank for unlimited. Value is in megabytes.</div>
                </div>
                <div class="mb-3">
                  <label class="form-label">Render Time Limit (minutes per month)</label>
                  <input class="form-control" name="render_time_limit_minutes" type="number" min="0" step="1" placeholder="e.g. 30 for 30 min" value="{% if tier and tier.render_time_limit_seconds is not none %}{{ (tier.render_time_limit_seconds/60)|round(0, 'floor')|int }}{% endif %}">
                  <div class="form-text">Leave blank for unlimited.</div>
                </div>
              </div>
            </div>
          </div>
          <div class="col-md-5">
            <div class="card mb-3">
              <div class="card-header">Policy</div>
              <div class="card-body">
                <div class="form-check mb-2">
                  <input class="form-check-input" type="checkbox" name="apply_watermark" id="apply_watermark" {% if tier and tier.apply_watermark %}checked{% endif %}>
                  <label class="form-check-label" for="apply_watermark">Apply watermark</label>
                </div>
                <div class="form-check mb-2">
                  <input class="form-check-input" type="checkbox" name="is_unlimited" id="is_unlimited" {% if tier and tier.is_unlimited %}checked{% endif %}>
                  <label class="form-check-label" for="is_unlimited">Unlimited (no quotas, no watermark)</label>
                </div>
                <div class="form-check mb-2">
                  <input class="form-check-input" type="checkbox" name="is_active" id="is_active" {% if (tier and tier.is_active) or not tier %}checked{% endif %}>
                  <label class="form-check-label" for="is_active">Active</label>
                </div>
                <div class="form-check mb-2">
                  <input class="form-check-input" type="checkbox" name="is_default" id="is_default" {% if tier and tier.is_default %}checked{% endif %}>
                  <label class="form-check-label" for="is_default"><strong>Default tier for new users</strong></label>
                  <div class="form-text">Only one tier can be default. Setting this will unset all others.</div>
                </div>
                <hr>
                <div class="mb-2">
                  <label class="form-label">Max Teams Owned</label>
                  <input class="form-control" name="max_teams_owned" type="number" min="0" placeholder="e.g. 3" value="{% if tier and tier.max_teams_owned is not none %}{{ tier.max_teams_owned }}{% endif %}">
                  <div class="form-text">Maximum teams a user can own. Leave blank for unlimited.</div>
                </div>
                <div class="mb-2">
                  <label class="form-label">Max Team Members</label>
                  <input class="form-control" name="max_team_members" type="number" min="1" placeholder="e.g. 5" value="{% if tier and tier.max_team_members is not none %}{{ tier.max_team_members }}{% endif %}">
                  <div class="form-text">Maximum members per team. Leave blank for unlimited.</div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="d-flex justify-content-end gap-2">
          <a class="btn btn-secondary" href="{{ url_for('admin.tiers_list') }}">Cancel</a>
          <button class="btn btn-primary" type="submit">Save</button>
        </div>
      </form>
    </div>
  </div>
</div>
{% endblock %}

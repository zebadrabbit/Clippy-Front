{% extends "base.html" %}

{% block content %}
<div class="container py-4">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <div>
      <h2 class="mb-0"><i class="bi bi-folder"></i> {{ project.name }}</h2>
    </div>
    <div>
      <button class="btn btn-outline-primary btn-sm" id="saveAsTemplateBtn">
        <i class="bi bi-file-earmark-code"></i> Save as Template
      </button>
    </div>
  </div>

  {% if project.description %}
  <p class="text-muted">{{ project.description }}</p>
  {% endif %}

  <div class="row g-4">
    <!-- Clips Card -->
    <div class="col-lg-7">
      <div class="card h-100">
        <div class="card-header card-header--primary d-flex justify-content-between align-items-center">
          <strong>Clips</strong>
          <small class="text-muted">
            {% if used_only %}
              {{ used_count }} used of {{ total_clip_count }}
            {% else %}
              {{ total_clip_count }} total
            {% endif %}
          </small>
        </div>
        <div class="card-body">
          {% if clips %}
          <div class="row row-cols-1 row-cols-md-2 g-3">
            {% for c in clips %}
            <div class="col">
              <div class="border rounded p-2 h-100">
                <div class="d-flex align-items-start">
                  {% if c.media_file and c.media_file.thumbnail_path %}
                    <img src="{{ url_for('main.media_thumbnail', media_id=c.media_file.id) }}" class="me-2 rounded" style="width: 96px; height: 54px; object-fit: cover;" alt="thumb">
                  {% endif %}
                  <div class="flex-grow-1">
                    <div class="fw-semibold text-truncate" title="{{ c.title }}">{{ c.title }}</div>
                    <ul class="small text-muted mb-0 ps-3">
                      {% if c.creator_name %}<li><i class="bi bi-person"></i> {{ c.creator_name }}</li>{% endif %}
                      {% if c.game_name %}<li><i class="bi bi-controller"></i> {{ c.game_name }}</li>{% endif %}
                      {% if c.clip_created_at %}<li><i class="bi bi-calendar"></i> {{ c.clip_created_at.strftime('%Y-%m-%d') }}</li>{% endif %}
                      <li><i class="bi bi-clock"></i> {{ c.duration_formatted }}</li>
                      {% if c.source_platform %}
                        <li>Source: {{ c.source_platform }}{% if c.source_url %} · <a href="{{ c.source_url }}" target="_blank">open</a>{% endif %}</li>
                      {% endif %}
                    </ul>
                  </div>
                </div>
              </div>
            </div>
            {% endfor %}
          </div>
          {% else %}
          <p class="text-muted mb-0">No clips yet.</p>
          {% endif %}
        </div>
      </div>
    </div>

    <!-- Compilation Card -->
    <div class="col-lg-5">
      <div class="card h-100">
        <div class="card-header card-header--primary"><strong>Compilation</strong></div>
        <div class="card-body d-flex flex-column">
          {% if project.output_filename %}
            <div class="mb-2">
              <div class="fw-semibold">{{ project.name }}</div>
              <div class="small text-muted">
                {% if compiled_media %}
                  <span class="me-2"><i class="bi bi-clock"></i> {{ compiled_media.duration_formatted }}</span>
                {% endif %}
                {% if project.output_file_size %}
                  <span>Size: {{ '%.1f'|format(project.output_file_size / (1024*1024)) }} MB</span>
                {% endif %}
              </div>
              <div class="small text-muted mt-1">File: {{ project.output_filename }}</div>
            </div>
            <div class="ratio ratio-16x9 mb-3">
              <video controls preload="metadata" {% if compiled_media %}poster="{{ url_for('main.media_thumbnail', media_id=compiled_media.id) }}"{% endif %}>
                <source src="{{ url_for('main.preview_compiled_output_by_public', public_id=project.public_id) if project.public_id else url_for('main.preview_compiled_output', project_id=project.id) }}" type="video/mp4">
                Your browser does not support the video tag.
              </video>
            </div>
            <div class="mt-auto d-flex gap-2">
              {% if download_url %}
                <a class="btn btn-primary" href="{{ download_url }}"><i class="bi bi-download"></i> Download</a>
              {% endif %}
              <button class="btn btn-outline-secondary" disabled title="Coming soon"><i class="bi bi-youtube"></i> Share to YouTube</button>
            </div>
          {% else %}
            <p class="text-muted mb-0">No compiled output yet. Click Compile to start.</p>
          {% endif %}
        </div>
        <div class="card-footer">
          <div class="small text-muted">
            <div class="d-flex align-items-center gap-2 flex-wrap">
              <strong>Intro:</strong>
              {% if intros and intros|length > 0 %}
                {% set m = intros[0] %}
                <a href="#" tabindex="0"
                   data-bs-toggle="popover"
                   data-bs-trigger="hover focus"
                   data-bs-placement="top"
                   data-bs-container="body"
                   data-bs-custom-class="media-popover"
                   data-bs-html="true"
                   data-bs-content="<img src='{{ url_for('main.media_thumbnail', media_id=m.id) }}' alt='preview'>"
                   title="{{ m.original_filename|e }}">
                  <img src="{{ url_for('main.media_thumbnail', media_id=m.id) }}" alt="intro" class="rounded" style="width:40px;height:24px;object-fit:cover;">
                </a>
                <span class="text-truncate" style="max-width: 160px;" title="{{ m.original_filename }}">{{ m.original_filename }}</span>
              {% else %}
                <span>—</span>
              {% endif %}
            </div>
            <div class="d-flex align-items-center gap-2 flex-wrap mt-2">
              <strong>Outro:</strong>
              {% if outros and outros|length > 0 %}
                {% set m = outros[0] %}
                <a href="#" tabindex="0"
                   data-bs-toggle="popover"
                   data-bs-trigger="hover focus"
                   data-bs-placement="top"
                   data-bs-container="body"
                   data-bs-custom-class="media-popover"
                   data-bs-html="true"
                   data-bs-content="<img src='{{ url_for('main.media_thumbnail', media_id=m.id) }}' alt='preview'>"
                   title="{{ m.original_filename|e }}">
                  <img src="{{ url_for('main.media_thumbnail', media_id=m.id) }}" alt="outro" class="rounded" style="width:40px;height:24px;object-fit:cover;">
                </a>
                <span class="text-truncate" style="max-width: 160px;" title="{{ m.original_filename }}">{{ m.original_filename }}</span>
              {% else %}
                <span>—</span>
              {% endif %}
            </div>
            <div class="d-flex align-items-center gap-2 flex-wrap mt-2">
              <strong>Transitions:</strong>
              {% if transitions and transitions|length > 0 %}
                {% for t in transitions %}
                  <a href="#" tabindex="0"
                     data-bs-toggle="popover"
                     data-bs-trigger="hover focus"
                     data-bs-placement="top"
                     data-bs-container="body"
                     data-bs-custom-class="media-popover"
                     data-bs-html="true"
                     data-bs-content="<img src='{{ url_for('main.media_thumbnail', media_id=t.id) }}' alt='preview'>"
                     title="{{ t.original_filename|e }}">
                    <img src="{{ url_for('main.media_thumbnail', media_id=t.id) }}" alt="transition" class="rounded me-1" style="width:40px;height:24px;object-fit:cover;">
                  </a>
                {% endfor %}
              {% else %}
                <span>—</span>
              {% endif %}
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Export Settings -->
  <div class="card mt-4">
    <div class="card-header">
      <strong><i class="bi bi-gear"></i> Export Settings</strong>
    </div>
    <div class="card-body">
      <div class="row g-3">
        <div class="col-md-6">
          <label class="form-label">Platform Preset</label>
          <select class="form-select" id="projectPlatformPreset" data-project-id="{{ project.id }}">
            <option value="custom" {% if project.platform_preset == 'custom' or not project.platform_preset %}selected{% endif %}>Custom</option>
            <!-- Populated dynamically via JavaScript -->
          </select>
          <small class="text-muted">Select a preset to optimize for specific platforms</small>
        </div>
        <div class="col-md-6">
          <div class="alert alert-info mb-0 small">
            <strong>Current Settings:</strong><br>
            Resolution: {{ project.resolution or '1080p' }}<br>
            Format: {{ project.format or 'mp4' }}<br>
            FPS: {{ project.fps or '60' }}
          </div>
        </div>
      </div>
      <div class="mt-3">
        <button class="btn btn-primary" id="applyPresetBtn" disabled>
          <i class="bi bi-check-circle"></i> Apply Preset
        </button>
        <small class="text-muted ms-2" id="presetFeedback"></small>
      </div>
    </div>
  </div>

  <!-- Danger Zone -->
  <div class="card border-danger mt-4">
    <div class="card-header bg-danger bg-opacity-10 border-danger">
      <h5 class="mb-0 text-danger"><i class="bi bi-exclamation-triangle"></i> Danger Zone</h5>
    </div>
    <div class="card-body">
      <div class="d-flex justify-content-between align-items-center">
        <div>
          <h6 class="mb-1">Delete this project</h6>
          <p class="text-muted small mb-0">Once you delete a project, there is no going back. This will delete all clips, media files, and compilation outputs associated with this project.</p>
        </div>
        <form method="POST" action="{{ url_for('main.delete_project', project_id=project.id) }}" onsubmit="return confirm('Are you sure you want to delete {{ project.name }}? This action cannot be undone.');" class="ms-3">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
          <button type="submit" class="btn btn-danger">
            <i class="bi bi-trash"></i> Delete Project
          </button>
        </form>
      </div>
    </div>
  </div>
</div>

<script>
document.getElementById('saveAsTemplateBtn')?.addEventListener('click', async function() {
    const templateName = prompt('Enter a name for this template:', '{{ project.name }} Template');
    if (!templateName) return;

    const description = prompt('Enter a description (optional):');

    try {
        const response = await fetch('/api/templates', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('meta[name="csrf-token"]')?.content || ''
            },
            body: JSON.stringify({
                name: templateName,
                description: description || '',
                project_id: {{ project.id }}
            })
        });

        if (response.ok) {
            alert('Template created successfully!');
            window.location.href = '/templates';
        } else {
            const error = await response.json();
            alert('Error: ' + (error.error || 'Failed to create template'));
        }
    } catch (error) {
        console.error('Error creating template:', error);
        alert('Failed to create template');
    }
});

// Platform Preset Integration for Project Details
(function initProjectPresets() {
    const presetSelect = document.getElementById('projectPlatformPreset');
    const applyBtn = document.getElementById('applyPresetBtn');
    const feedbackEl = document.getElementById('presetFeedback');

    if (!presetSelect || !applyBtn) return;

    const projectId = presetSelect.dataset.projectId;

    // Load available presets
    fetch('/api/presets')
        .then(res => res.json())
        .then(presets => {
            if (!Array.isArray(presets)) return;

            presets.forEach(preset => {
                if (preset.value === 'custom') return; // Already in HTML
                const option = document.createElement('option');
                option.value = preset.value;
                option.textContent = preset.name;
                option.dataset.settings = JSON.stringify(preset.settings);

                // Pre-select if this project has this preset
                if ('{{ project.platform_preset }}' === preset.value) {
                    option.selected = true;
                }

                presetSelect.appendChild(option);
            });
        })
        .catch(err => console.error('Failed to load presets:', err));

    // Enable apply button when preset changes
    presetSelect.addEventListener('change', function() {
        applyBtn.disabled = (this.value === 'custom');
        feedbackEl.textContent = '';
    });

    // Apply preset to project
    applyBtn.addEventListener('click', async function() {
        const selectedPreset = presetSelect.value;
        if (selectedPreset === 'custom') return;

        applyBtn.disabled = true;
        feedbackEl.textContent = 'Applying preset...';
        feedbackEl.className = 'text-muted ms-2';

        try {
            const response = await fetch(`/api/projects/${projectId}/preset`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('meta[name="csrf-token"]')?.content || ''
                },
                body: JSON.stringify({ preset: selectedPreset })
            });

            if (response.ok) {
                const result = await response.json();
                feedbackEl.textContent = `✓ Applied successfully! Reload page to see updated settings.`;
                feedbackEl.className = 'text-success ms-2';

                // Optionally reload page after 2 seconds to show updated settings
                setTimeout(() => window.location.reload(), 2000);
            } else {
                const error = await response.json();
                feedbackEl.textContent = `Error: ${error.error || 'Failed to apply preset'}`;
                feedbackEl.className = 'text-danger ms-2';
                applyBtn.disabled = false;
            }
        } catch (err) {
            console.error('Failed to apply preset:', err);
            feedbackEl.textContent = 'Failed to apply preset';
            feedbackEl.className = 'text-danger ms-2';
            applyBtn.disabled = false;
        }
    });
})();
</script>
{% endblock %}

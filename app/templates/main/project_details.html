{% extends "base.html" %}

{% block styles %}
{{ super() }}
<link rel="stylesheet" href="{{ url_for('static', filename='css/project-details.css') }}">
{% endblock %}

{% block content %}
<div class="container py-4">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <div class="flex-grow-1 me-3">
      <div id="project-header-display">
        <h2 class="mb-0">
          <i class="bi bi-folder"></i>
          <span id="project-name-display">{{ project.name }}</span>
          <button class="btn btn-sm btn-outline-secondary ms-2" id="edit-project-btn" title="Edit project details">
            <i class="bi bi-pencil"></i>
          </button>
        </h2>
        {% if project.tags %}
        <div class="mt-2">
          {% for tag in project.tags.split(',') %}
            <span class="badge bg-secondary">{{ tag.strip() }}</span>
          {% endfor %}
        </div>
        {% endif %}
        {% if project.description %}
        <p class="text-muted mt-2 mb-0">{{ project.description }}</p>
        {% endif %}
      </div>
      <div id="project-header-edit" class="d-none">
        <div class="mb-2">
          <label class="form-label small mb-1">Project Name</label>
          <input type="text" class="form-control" id="project-name-input" value="{{ project.name }}">
        </div>
        <div class="mb-2">
          <label class="form-label small mb-1">Tags <span class="text-muted">(comma-separated)</span></label>
          <input type="text" class="form-control" id="project-tags-input" value="{{ project.tags or '' }}" placeholder="gaming, highlights, funny">
        </div>
        <div class="mb-2">
          <label class="form-label small mb-1">Description</label>
          <textarea class="form-control" id="project-description-input" rows="2">{{ project.description or '' }}</textarea>
        </div>
        <div class="d-flex gap-2">
          <button class="btn btn-sm btn-primary" id="save-project-btn">
            <i class="bi bi-check-lg"></i> Save
          </button>
          <button class="btn btn-sm btn-secondary" id="cancel-edit-btn">
            <i class="bi bi-x-lg"></i> Cancel
          </button>
        </div>
      </div>
    </div>
  </div>

  <div class="row g-4">
    <!-- Clips Card -->
    <div class="col-lg-4">
      <div class="card h-100">
        <div class="card-header card-header--primary d-flex justify-content-between align-items-center">
          <strong>Clips</strong>
          <small class="text-muted">
            {% if used_only %}
              {{ used_count }} used of {{ total_clip_count }}
            {% else %}
              {{ total_clip_count }} total
            {% endif %}
          </small>
        </div>
        <div class="card-body" style="max-height: 600px; overflow-y: auto;">
          {% if clips %}
          <div class="d-flex flex-column gap-3">
            {% for c in clips %}
              <div class="border rounded p-3 clip-card position-relative" data-preview-url="{% if c.media_file %}{{ url_for('main.media_preview', media_id=c.media_file.id) }}{% endif %}">
                <div class="d-flex align-items-start">
                  {% if c.media_file and c.media_file.thumbnail_path %}
                    <div class="position-relative me-3" style="width: 120px; height: 68px;">
                      <img src="{{ url_for('main.media_thumbnail', media_id=c.media_file.id) }}" class="clip-thumb rounded" style="width: 120px; height: 68px; object-fit: cover;" alt="thumb">
                      <video class="position-absolute top-0 start-0 clip-preview d-none rounded" muted loop playsinline preload="metadata" style="width: 120px; height: 68px; object-fit: cover;"></video>
                      {% if c.duration %}
                        {% set mins = (c.duration // 60)|int %}
                        {% set secs = (c.duration % 60)|int %}
                        <span class="badge bg-dark position-absolute bottom-0 end-0 m-1" style="opacity:0.9; font-size:0.7rem;">
                          {{ '%d:%02d' | format(mins, secs) }}
                        </span>
                      {% endif %}
                    </div>
                  {% endif %}
                  <div class="flex-grow-1">
                    <div class="fw-semibold text-truncate mb-1" title="{{ c.title }}">{{ c.title }}</div>
                    <ul class="small text-muted mb-0 list-unstyled">
                      {% if c.creator_name %}<li class="mb-1"><i class="bi bi-person-fill me-1"></i>{{ c.creator_name }}</li>{% endif %}
                      {% if c.clip_created_at %}<li class="mb-1"><i class="bi bi-calendar me-1"></i>{{ c.clip_created_at.strftime('%b %d, %Y') }}</li>{% endif %}
                      {% if c.game_name %}<li class="mb-1"><i class="bi bi-controller me-1"></i>{{ c.game_name }}</li>{% endif %}
                      {% if c.source_platform %}
                        <li><i class="bi bi-box-arrow-up-right me-1"></i>{{ c.source_platform|title }}{% if c.source_url %} · <a href="{{ c.source_url }}" target="_blank" class="text-decoration-none">view</a>{% endif %}</li>
                      {% endif %}
                    </ul>
                  </div>
                </div>
              </div>
            {% endfor %}
          </div>
          {% else %}
          <p class="text-muted mb-0">No clips yet.</p>
          {% endif %}
        </div>
      </div>
    </div>

    <!-- Compilation Card -->
    <div class="col-lg-8">
      <div class="card h-100">
        <div class="card-header card-header--primary"><strong>Compilation</strong></div>
        <div class="card-body d-flex flex-column">
          {% if project.output_filename %}
            <div class="mb-3">
              <div class="fw-semibold mb-2">{{ project.name }}</div>
              <dl class="row small mb-0">
                {% if compiled_media and compiled_media.duration %}
                  {% set mins = (compiled_media.duration // 60)|int %}
                  {% set secs = (compiled_media.duration % 60)|int %}
                  <dt class="col-sm-4 text-muted"><i class="bi bi-clock"></i> Duration:</dt>
                  <dd class="col-sm-8 mb-1">{{ '%d:%02d' | format(mins, secs) }}</dd>
                {% endif %}
                {% if project.output_file_size %}
                  <dt class="col-sm-4 text-muted"><i class="bi bi-file-earmark"></i> File Size:</dt>
                  <dd class="col-sm-8 mb-1">{{ '%.1f'|format(project.output_file_size / (1024*1024)) }} MB</dd>
                {% endif %}
                {% if compiled_media and compiled_media.width and compiled_media.height %}
                  <dt class="col-sm-4 text-muted"><i class="bi bi-aspect-ratio"></i> Resolution:</dt>
                  <dd class="col-sm-8 mb-1">{{ compiled_media.width }}×{{ compiled_media.height }}</dd>
                {% endif %}
                <dt class="col-sm-4 text-muted"><i class="bi bi-file-code"></i> Filename:</dt>
                <dd class="col-sm-8 mb-0 text-break">{{ project.output_filename }}</dd>
              </dl>
            </div>
            <div class="ratio ratio-16x9 mb-3">
              <video controls preload="metadata" {% if compiled_media %}poster="{{ url_for('main.media_thumbnail', media_id=compiled_media.id) }}"{% endif %}>
                <source src="{{ url_for('main.preview_compiled_output_by_public', public_id=project.public_id) if project.public_id else url_for('main.preview_compiled_output', project_id=project.id) }}" type="video/mp4">
                Your browser does not support the video tag.
              </video>
            </div>
            <div class="mt-auto d-flex gap-2">
              <a class="btn btn-outline-primary" href="{{ url_for('main.project_wizard', project_id=project.id, step=3) }}">
                <i class="bi bi-pencil"></i> Edit Timeline
              </a>
              <button class="btn btn-success" id="recompileBtn" data-project-id="{{ project.id }}">
                <i class="bi bi-arrow-clockwise"></i> Recompile
              </button>
            </div>
            <div class="border-top pt-3 mt-3">
              <h6 class="mb-3">Compilation Elements</h6>
              <dl class="row small mb-0">
                <dt class="col-sm-3 text-muted">Intro:</dt>
                <dd class="col-sm-9 mb-2">
                  {% if project.intro_media %}
                    {% set m = project.intro_media %}
                    <div class="d-flex align-items-center gap-2">
                      <a href="#" tabindex="0"
                         data-bs-toggle="popover"
                         data-bs-trigger="hover focus"
                         data-bs-placement="top"
                         data-bs-container="body"
                         data-bs-custom-class="media-popover"
                         data-bs-html="true"
                         data-bs-content="<img src='{{ url_for('main.media_thumbnail', media_id=m.id) }}' alt='preview'>"
                         title="{{ m.original_filename|e }}">
                        <img src="{{ url_for('main.media_thumbnail', media_id=m.id) }}" alt="intro" class="rounded" style="width:60px;height:34px;object-fit:cover;">
                      </a>
                      <span class="text-truncate" title="{{ m.original_filename }}">{{ m.original_filename }}</span>
                    </div>
                  {% else %}
                    <span class="text-muted">None</span>
                  {% endif %}
                </dd>
                <dt class="col-sm-3 text-muted">Outro:</dt>
                <dd class="col-sm-9 mb-2">
                  {% if project.outro_media %}
                    {% set m = project.outro_media %}
                    <div class="d-flex align-items-center gap-2">
                      <a href="#" tabindex="0"
                         data-bs-toggle="popover"
                         data-bs-trigger="hover focus"
                         data-bs-placement="top"
                         data-bs-container="body"
                         data-bs-custom-class="media-popover"
                         data-bs-html="true"
                         data-bs-content="<img src='{{ url_for('main.media_thumbnail', media_id=m.id) }}' alt='preview'>"
                         title="{{ m.original_filename|e }}">
                        <img src="{{ url_for('main.media_thumbnail', media_id=m.id) }}" alt="outro" class="rounded" style="width:60px;height:34px;object-fit:cover;">
                      </a>
                      <span class="text-truncate" title="{{ m.original_filename }}">{{ m.original_filename }}</span>
                    </div>
                  {% else %}
                    <span class="text-muted">None</span>
                  {% endif %}
                </dd>
                <dt class="col-sm-3 text-muted">Transitions:</dt>
                <dd class="col-sm-9 mb-0">
                  {% if project.transition_ids %}
                    {% set transition_list = project.transition_ids.split(',') if project.transition_ids else [] %}
                    {% if transition_list|length > 0 %}
                      <div class="d-flex align-items-center gap-2">
                        <span class="badge bg-success">{{ transition_list|length }} transition{{ 's' if transition_list|length != 1 else '' }}</span>
                        {% if transitions and transitions|length > 0 %}
                          <div class="d-flex flex-wrap gap-1">
                            {% for t in transitions[:5] %}
                              <a href="#" tabindex="0"
                                 data-bs-toggle="popover"
                                 data-bs-trigger="hover focus"
                                 data-bs-placement="top"
                                 data-bs-container="body"
                                 data-bs-custom-class="media-popover"
                                 data-bs-html="true"
                                 data-bs-content="<img src='{{ url_for('main.media_thumbnail', media_id=t.id) }}' alt='preview'>"
                                 title="{{ t.original_filename|e }}">
                                <img src="{{ url_for('main.media_thumbnail', media_id=t.id) }}" alt="transition" class="rounded" style="width:60px;height:34px;object-fit:cover;">
                              </a>
                            {% endfor %}
                            {% if transitions|length > 5 %}
                              <span class="text-muted small align-self-center">+{{ transitions|length - 5 }} more</span>
                            {% endif %}
                          </div>
                        {% endif %}
                      </div>
                    {% else %}
                      <span class="text-muted">None</span>
                    {% endif %}
                  {% else %}
                    <span class="text-muted">None</span>
                  {% endif %}
                </dd>
                <dt class="col-sm-3 text-muted">Background Music:</dt>
                <dd class="col-sm-9 mb-0">
                  {% if project.background_music_id %}
                    {% set music = project.background_music %}
                    <div class="d-flex align-items-center gap-2">
                      <i class="bi bi-music-note-beamed"></i>
                      <span class="text-truncate" title="{{ music.original_filename if music else 'Unknown' }}">
                        {{ music.original_filename if music else 'Music file #' ~ project.background_music_id }}
                      </span>
                      <span class="badge bg-secondary">{{ (project.music_volume * 100)|int }}% volume</span>
                    </div>
                    {% if project.music_start_mode or project.music_end_mode %}
                      <small class="text-muted d-block mt-1">
                        Start: {{ 'after intro' if project.music_start_mode == 'after_intro' else 'with video' }}
                        • End: {{ 'before outro' if project.music_end_mode == 'before_outro' else 'with video' }}
                      </small>
                    {% endif %}
                  {% else %}
                    <span class="text-muted">None</span>
                  {% endif %}
                </dd>
              </dl>
            </div>
          {% else %}
            <div class="d-flex flex-column h-100">
              <p class="text-muted mb-3">No compiled output yet.</p>
              <div class="mt-auto">
                <a class="btn btn-primary w-100 mb-2" href="{{ url_for('main.project_wizard', project_id=project.id, step=3) }}">
                  <i class="bi bi-pencil"></i> Edit Timeline &amp; Compile
                </a>
                <p class="text-muted small mb-0">Arrange your clips and create the compilation</p>
              </div>
            </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>

  <!-- Compilation History -->
  {% if all_compilations and all_compilations|length > 1 %}
  <div class="card mt-4">
    <div class="card-header d-flex justify-content-between align-items-center">
      <strong><i class="bi bi-clock-history"></i> Compilation History</strong>
      <small class="text-muted">{{ all_compilations|length }} version{{ 's' if all_compilations|length > 1 else '' }}</small>
    </div>
    <div class="card-body">
      <div class="row g-3">
        {% for comp in all_compilations %}
        <div class="col-md-6 col-lg-4">
          <div class="card h-100">
            <div class="position-relative" style="cursor: pointer;" onclick="playCompilation({{ comp.id }}, this)">
              {% if comp.thumbnail_path %}
              <img src="{{ url_for('main.media_thumbnail', media_id=comp.id) }}" class="card-img-top compilation-thumbnail" alt="thumbnail" style="height: 180px; object-fit: cover;">
              {% else %}
              <div class="bg-secondary d-flex align-items-center justify-content-center compilation-thumbnail" style="height: 180px;">
                <i class="bi bi-film text-white fs-1"></i>
              </div>
              {% endif %}
              <video class="card-img-top compilation-video d-none" style="height: 180px; object-fit: cover;" controls>
                <source src="{{ url_for('main.media_preview', media_id=comp.id) }}" type="video/mp4">
              </video>
              <div class="position-absolute top-50 start-50 translate-middle compilation-play-overlay">
                <div class="bg-dark bg-opacity-75 rounded-circle p-3">
                  <i class="bi bi-play-fill text-white" style="font-size: 2rem;"></i>
                </div>
              </div>
              {% if comp.duration %}
              {% set mins = (comp.duration // 60)|int %}
              {% set secs = (comp.duration % 60)|int %}
              <span class="badge bg-dark position-absolute bottom-0 end-0 m-2" style="opacity:0.9;">
                {{ '%d:%02d' | format(mins, secs) }}
              </span>
              {% endif %}
              {% if loop.first %}
              <span class="badge bg-success position-absolute top-0 start-0 m-2">Latest</span>
              {% endif %}
            </div>
            <div class="card-body">
              <h6 class="card-title text-truncate mb-2" title="{{ comp.filename }}">{{ comp.filename }}</h6>
              <p class="small text-muted mb-2">
                <i class="bi bi-calendar"></i> {{ comp.uploaded_at.strftime('%b %d, %Y at %I:%M %p') if comp.uploaded_at else 'Unknown' }}
              </p>
              {% if comp.file_size %}
              <p class="small text-muted mb-3">
                <i class="bi bi-file-earmark"></i> {{ '%.1f'|format(comp.file_size / (1024*1024)) }} MB
                {% if comp.width and comp.height %}
                • {{ comp.width }}×{{ comp.height }}
                {% endif %}
              </p>
              {% endif %}
              <div class="d-flex gap-2">
                <a href="{{ url_for('main.media_preview', media_id=comp.id) }}" download="{{ comp.filename }}" class="btn btn-sm btn-outline-success flex-grow-1">
                  <i class="bi bi-download"></i> Download
                </a>
                {% if not loop.first %}
                <button class="btn btn-sm btn-outline-danger" onclick="deleteCompilation({{ comp.id }}, '{{ comp.filename }}')">
                  <i class="bi bi-trash"></i>
                </button>
                {% endif %}
              </div>
            </div>
          </div>
        </div>
        {% endfor %}
      </div>
    </div>
  </div>
  {% endif %}

  <!-- Export & Share -->
  <div class="card mt-4">
    <div class="card-header">
      <strong><i class="bi bi-share"></i> Export & Share</strong>
    </div>
    <div class="card-body">
      <!-- Created For Platform -->
      <div class="mb-4">
        <h6 class="mb-2">Created For</h6>
        <div class="d-flex align-items-center gap-2">
          {% if project.platform_preset and project.platform_preset.value != 'custom' %}
            <span class="badge bg-primary fs-6 px-3 py-2">
              <i class="bi bi-{{ 'youtube' if 'youtube' in project.platform_preset.value else 'tiktok' if project.platform_preset.value == 'tiktok' else 'instagram' if 'instagram' in project.platform_preset.value else 'twitter' if project.platform_preset.value == 'twitter' else 'facebook' if project.platform_preset.value == 'facebook' else 'twitch' if project.platform_preset.value == 'twitch' else 'gear' }}"></i>
              {{ project.platform_preset.display_name }}
            </span>
            <small class="text-muted">
              {{ project.output_resolution or '1080p' }} • {{ project.fps or 30 }} FPS • {{ project.output_format or 'mp4' }}
            </small>
          {% else %}
            <span class="badge bg-secondary fs-6 px-3 py-2">
              <i class="bi bi-gear"></i> Custom
            </span>
            <small class="text-muted">
              {{ project.output_resolution or '1080p' }} • {{ project.fps or 30 }} FPS • {{ project.output_format or 'mp4' }}
            </small>
          {% endif %}
        </div>
      </div>

      {% if project.output_filename %}
        <!-- Download -->
        <div class="mb-4">
          <h6 class="mb-2">Download</h6>
          <a class="btn btn-primary" href="{{ download_url }}" download>
            <i class="bi bi-download"></i> Download Video
          </a>
          {% if project.output_file_size %}
            <small class="text-muted ms-2">{{ '%.1f'|format(project.output_file_size / (1024*1024)) }} MB</small>
          {% endif %}
        </div>

        <!-- Export To Platforms -->
        <div>
          <h6 class="mb-3">Export To Platform</h6>
          <div class="row g-3">
            <!-- YouTube -->
            <div class="col-md-4">
              <button class="btn btn-outline-danger w-100" onclick="exportToYouTube('{{ project.id }}')">
                <i class="bi bi-youtube"></i> YouTube
              </button>
            </div>
            <!-- TikTok -->
            <div class="col-md-4">
              <button class="btn btn-outline-tiktok w-100" onclick="exportToTikTok('{{ project.id }}')">
                <i class="bi bi-tiktok"></i> TikTok
              </button>
            </div>
            <!-- Instagram -->
            <div class="col-md-4">
              <button class="btn btn-outline-primary w-100" onclick="exportToInstagram('{{ project.id }}')">
                <i class="bi bi-instagram"></i> Instagram
              </button>
            </div>
            <!-- Twitter/X -->
            <div class="col-md-4">
              <button class="btn btn-outline-info w-100" onclick="exportToTwitter('{{ project.id }}')">
                <i class="bi bi-twitter-x"></i> Twitter/X
              </button>
            </div>
            <!-- Facebook -->
            <div class="col-md-4">
              <button class="btn btn-outline-primary w-100" onclick="exportToFacebook('{{ project.id }}')">
                <i class="bi bi-facebook"></i> Facebook
              </button>
            </div>
            <!-- Twitch -->
            <div class="col-md-4">
              <button class="btn btn-outline-purple w-100" onclick="exportToTwitch('{{ project.id }}')">
                <i class="bi bi-twitch"></i> Twitch
              </button>
            </div>
          </div>
          <small class="text-muted d-block mt-3">
            <i class="bi bi-info-circle"></i> Platform uploads coming soon! For now, download and upload manually.
          </small>
        </div>
      {% else %}
        <div class="alert alert-info mb-0">
          <i class="bi bi-info-circle"></i>
          Compile your project first to enable download and platform export options.
        </div>
      {% endif %}
    </div>
  </div>

  <!-- Danger Zone -->
  <div class="card border-danger mt-4">
    <div class="card-header bg-danger bg-opacity-10 border-danger">
      <h5 class="mb-0 text-danger"><i class="bi bi-exclamation-triangle"></i> Danger Zone</h5>
    </div>
    <div class="card-body">
      <div class="d-flex justify-content-between align-items-center">
        <div>
          <h6 class="mb-1">Delete this project</h6>
          <p class="text-muted small mb-0">Once you delete a project, there is no going back. This will delete all clips, media files, and compilation outputs associated with this project.</p>
        </div>
        <form method="POST" action="{{ url_for('main.delete_project', project_id=project.id) }}" onsubmit="return confirm('Are you sure you want to delete {{ project.name }}? This action cannot be undone.');" class="ms-3">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
          <button type="submit" class="btn btn-danger">
            <i class="bi bi-trash"></i> Delete Project
          </button>
        </form>
      </div>
    </div>
  </div>
</div>

<script>
// Clip hover preview functionality
(function(){
  const clipCards = document.querySelectorAll('.clip-card');
  clipCards.forEach(function(card){
    const previewUrl = card.getAttribute('data-preview-url');
    if (!previewUrl) return;
    const video = card.querySelector('video.clip-preview');
    const img = card.querySelector('img.clip-thumb');
    if (!video) return;
    let loaded = false;
    function showPreview(){
      try {
        if (!loaded) {
          video.src = previewUrl;
          loaded = true;
        }
        if (img) img.classList.add('d-none');
        video.classList.remove('d-none');
        video.play().catch(function(_){});
      } catch (_) {}
    }
    function hidePreview(){
      try {
        video.pause();
        video.currentTime = 0;
        video.classList.add('d-none');
        if (img) img.classList.remove('d-none');
      } catch (_) {}
    }
    card.addEventListener('mouseenter', showPreview);
    card.addEventListener('mouseleave', hidePreview);
  });
})();

// Platform Export Functions (Stubs for OAuth integration)
function exportToYouTube(projectId) {
    alert('YouTube export coming soon!\n\nWe\'ll add OAuth integration to upload directly to your YouTube channel.');
    // TODO: Implement YouTube OAuth + API upload
    // window.location.href = `/api/projects/${projectId}/export/youtube`;
}

function exportToTikTok(projectId) {
    alert('TikTok export coming soon!\n\nWe\'ll add OAuth integration to upload directly to your TikTok account.');
    // TODO: Implement TikTok OAuth + API upload
    // window.location.href = `/api/projects/${projectId}/export/tiktok`;
}

function exportToInstagram(projectId) {
    alert('Instagram export coming soon!\n\nWe\'ll add OAuth integration to upload directly to your Instagram account.');
    // TODO: Implement Instagram Graph API OAuth + upload
    // window.location.href = `/api/projects/${projectId}/export/instagram`;
}

function exportToTwitter(projectId) {
    alert('Twitter/X export coming soon!\n\nWe\'ll add OAuth integration to upload directly to your Twitter/X account.');
    // TODO: Implement Twitter OAuth + API upload
    // window.location.href = `/api/projects/${projectId}/export/twitter`;
}

function exportToFacebook(projectId) {
    alert('Facebook export coming soon!\n\nWe\'ll add OAuth integration to upload directly to your Facebook page.');
    // TODO: Implement Facebook Graph API OAuth + upload
    // window.location.href = `/api/projects/${projectId}/export/facebook`;
}

function exportToTwitch(projectId) {
    alert('Twitch export coming soon!\n\nWe\'ll add OAuth integration to upload directly to your Twitch channel.');
    // TODO: Implement Twitch OAuth + API upload
    // window.location.href = `/api/projects/${projectId}/export/twitch`;
}

// Project metadata editing
(function() {
    const editBtn = document.getElementById('edit-project-btn');
    const cancelBtn = document.getElementById('cancel-edit-btn');
    const saveBtn = document.getElementById('save-project-btn');
    const displaySection = document.getElementById('project-header-display');
    const editSection = document.getElementById('project-header-edit');
    const nameInput = document.getElementById('project-name-input');
    const tagsInput = document.getElementById('project-tags-input');
    const descInput = document.getElementById('project-description-input');
    const nameDisplay = document.getElementById('project-name-display');

    const projectId = {{ project.id }};

    editBtn?.addEventListener('click', function() {
        displaySection.classList.add('d-none');
        editSection.classList.remove('d-none');
        nameInput.focus();
    });

    cancelBtn?.addEventListener('click', function() {
        editSection.classList.add('d-none');
        displaySection.classList.remove('d-none');
        // Reset values
        nameInput.value = nameDisplay.textContent.trim();
        tagsInput.value = '{{ project.tags or '' }}';
        descInput.value = '{{ project.description or '' }}';
    });

    saveBtn?.addEventListener('click', async function() {
        const name = nameInput.value.trim();
        if (!name) {
            alert('Project name cannot be empty');
            return;
        }

        saveBtn.disabled = true;
        saveBtn.innerHTML = '<i class="bi bi-hourglass"></i> Saving...';

        try {
            const response = await fetch(`/api/projects/${projectId}/metadata`, {
                method: 'PATCH',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('meta[name="csrf-token"]')?.content || ''
                },
                body: JSON.stringify({
                    name: name,
                    tags: tagsInput.value.trim(),
                    description: descInput.value.trim()
                })
            });

            if (response.ok) {
                // Reload to show updated data
                window.location.reload();
            } else {
                const error = await response.json();
                alert(`Error: ${error.error || 'Failed to update project'}`);
                saveBtn.disabled = false;
                saveBtn.innerHTML = '<i class="bi bi-check-lg"></i> Save';
            }
        } catch (err) {
            console.error('Failed to update project:', err);
            alert('Failed to update project');
            saveBtn.disabled = false;
            saveBtn.innerHTML = '<i class="bi bi-check-lg"></i> Save';
        }
    });
})();

// Recompile button handler
document.getElementById('recompileBtn')?.addEventListener('click', async function() {
    const btn = this;
    const projectId = btn.dataset.projectId;

    if (!confirm('Recompile this project? This will create a new compilation with the current settings.')) {
        return;
    }

    const originalHTML = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Starting...';

    try {
        const response = await fetch(`/api/projects/${projectId}/compile`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('meta[name="csrf-token"]')?.content || ''
            }
        });

        if (response.ok) {
            const result = await response.json();
            btn.innerHTML = '<i class="bi bi-check-circle"></i> Compiling...';

            // Show success message
            alert(`Compilation started! Task ID: ${result.task_id || 'N/A'}\n\nYou can monitor progress in the background. The page will show the new compilation when ready.`);

            // Optionally redirect to a task monitoring page or reload after delay
            setTimeout(() => {
                window.location.reload();
            }, 2000);
        } else {
            const error = await response.json();
            alert(`Error: ${error.error || 'Failed to start compilation'}`);
            btn.disabled = false;
            btn.innerHTML = originalHTML;
        }
    } catch (err) {
        console.error('Failed to recompile:', err);
        alert('Failed to start compilation. Please try again.');
        btn.disabled = false;
        btn.innerHTML = originalHTML;
    }
});

// Play compilation inline (replace thumbnail with video player)
function playCompilation(mediaId, cardElement) {
    const thumbnail = cardElement.querySelector('.compilation-thumbnail');
    const video = cardElement.querySelector('.compilation-video');
    const playOverlay = cardElement.querySelector('.compilation-play-overlay');

    if (thumbnail && video && playOverlay) {
        // Hide thumbnail and play overlay
        thumbnail.classList.add('d-none');
        playOverlay.classList.add('d-none');

        // Show and play video
        video.classList.remove('d-none');
        video.play();

        // When video ends, show thumbnail again
        video.addEventListener('ended', function() {
            video.classList.add('d-none');
            thumbnail.classList.remove('d-none');
            playOverlay.classList.remove('d-none');
            video.currentTime = 0;
        });

        // If user pauses, they can click again to resume
        video.addEventListener('pause', function() {
            if (video.currentTime < video.duration) {
                // Video was paused (not ended), allow click to resume
                cardElement.style.cursor = 'pointer';
            }
        });

        video.addEventListener('play', function() {
            cardElement.style.cursor = 'default';
        });
    }
}

async function deleteCompilation(mediaId, filename) {
    if (!confirm(`Delete compilation "${filename}"?\n\nThis action cannot be undone.`)) {
        return;
    }

    try {
        const response = await fetch(`/media/${mediaId}/delete`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('meta[name="csrf-token"]')?.content || ''
            }
        });

        if (response.ok) {
            window.showToast('Compilation deleted successfully', 'success');
            // Reload page to update compilation list
            setTimeout(() => window.location.reload(), 1000);
        } else {
            const error = await response.json();
            window.showToast(`Error: ${error.error || 'Failed to delete compilation'}`, 'error');
        }
    } catch (err) {
        console.error('Delete failed:', err);
        window.showToast('Failed to delete compilation. Please try again.', 'error');
    }
}
</script>
{% endblock %}

{% extends "base.html" %}

{% block styles %}
<style>
/* Media preview popover styling */
.media-popover .popover-body {
    padding: 0;
    border-radius: 0.375rem;
    overflow: hidden;
}
.media-popover .popover-body img {
    display: block;
    max-width: 320px;
    max-height: 180px;
    width: auto;
    height: auto;
    object-fit: contain;
}
</style>
{% endblock %}

{% block content %}
<div class="container py-4">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <div class="flex-grow-1 me-3">
      <div id="project-header-display">
        <h2 class="mb-0">
          <i class="bi bi-folder"></i>
          <span id="project-name-display">{{ project.name }}</span>
          <button class="btn btn-sm btn-outline-secondary ms-2" id="edit-project-btn" title="Edit project details">
            <i class="bi bi-pencil"></i>
          </button>
        </h2>
        {% if project.tags %}
        <div class="mt-2">
          {% for tag in project.tags.split(',') %}
            <span class="badge bg-secondary">{{ tag.strip() }}</span>
          {% endfor %}
        </div>
        {% endif %}
        {% if project.description %}
        <p class="text-muted mt-2 mb-0">{{ project.description }}</p>
        {% endif %}
      </div>
      <div id="project-header-edit" class="d-none">
        <div class="mb-2">
          <label class="form-label small mb-1">Project Name</label>
          <input type="text" class="form-control" id="project-name-input" value="{{ project.name }}">
        </div>
        <div class="mb-2">
          <label class="form-label small mb-1">Tags <span class="text-muted">(comma-separated)</span></label>
          <input type="text" class="form-control" id="project-tags-input" value="{{ project.tags or '' }}" placeholder="gaming, highlights, funny">
        </div>
        <div class="mb-2">
          <label class="form-label small mb-1">Description</label>
          <textarea class="form-control" id="project-description-input" rows="2">{{ project.description or '' }}</textarea>
        </div>
        <div class="d-flex gap-2">
          <button class="btn btn-sm btn-primary" id="save-project-btn">
            <i class="bi bi-check-lg"></i> Save
          </button>
          <button class="btn btn-sm btn-secondary" id="cancel-edit-btn">
            <i class="bi bi-x-lg"></i> Cancel
          </button>
        </div>
      </div>
    </div>
  </div>

  <div class="row g-4">
    <!-- Clips Card -->
    <div class="col-lg-4">
      <div class="card h-100">
        <div class="card-header card-header--primary d-flex justify-content-between align-items-center">
          <strong>Clips</strong>
          <small class="text-muted">
            {% if used_only %}
              {{ used_count }} used of {{ total_clip_count }}
            {% else %}
              {{ total_clip_count }} total
            {% endif %}
          </small>
        </div>
        <div class="card-body" style="max-height: 600px; overflow-y: auto;">
          {% if clips %}
          <div class="d-flex flex-column gap-3">
            {% for c in clips %}
              <div class="border rounded p-3 clip-card position-relative" data-preview-url="{% if c.media_file %}{{ url_for('main.media_preview', media_id=c.media_file.id) }}{% endif %}">
                <div class="d-flex align-items-start">
                  {% if c.media_file and c.media_file.thumbnail_path %}
                    <div class="position-relative me-3" style="width: 120px; height: 68px;">
                      <img src="{{ url_for('main.media_thumbnail', media_id=c.media_file.id) }}" class="clip-thumb rounded" style="width: 120px; height: 68px; object-fit: cover;" alt="thumb">
                      <video class="position-absolute top-0 start-0 clip-preview d-none rounded" muted loop playsinline preload="metadata" style="width: 120px; height: 68px; object-fit: cover;"></video>
                      {% if c.duration %}
                        {% set mins = (c.duration // 60)|int %}
                        {% set secs = (c.duration % 60)|int %}
                        <span class="badge bg-dark position-absolute bottom-0 end-0 m-1" style="opacity:0.9; font-size:0.7rem;">
                          {{ '%d:%02d' | format(mins, secs) }}
                        </span>
                      {% endif %}
                    </div>
                  {% endif %}
                  <div class="flex-grow-1">
                    <div class="fw-semibold text-truncate mb-1" title="{{ c.title }}">{{ c.title }}</div>
                    <ul class="small text-muted mb-0 list-unstyled">
                      {% if c.creator_name %}<li class="mb-1"><i class="bi bi-person-fill me-1"></i>{{ c.creator_name }}</li>{% endif %}
                      {% if c.clip_created_at %}<li class="mb-1"><i class="bi bi-calendar me-1"></i>{{ c.clip_created_at.strftime('%b %d, %Y') }}</li>{% endif %}
                      {% if c.game_name %}<li class="mb-1"><i class="bi bi-controller me-1"></i>{{ c.game_name }}</li>{% endif %}
                      {% if c.source_platform %}
                        <li><i class="bi bi-box-arrow-up-right me-1"></i>{{ c.source_platform|title }}{% if c.source_url %} · <a href="{{ c.source_url }}" target="_blank" class="text-decoration-none">view</a>{% endif %}</li>
                      {% endif %}
                    </ul>
                  </div>
                </div>
              </div>
            {% endfor %}
          </div>
          {% else %}
          <p class="text-muted mb-0">No clips yet.</p>
          {% endif %}
        </div>
      </div>
    </div>

    <!-- Compilation Card -->
    <div class="col-lg-8">
      <div class="card h-100">
        <div class="card-header card-header--primary"><strong>Compilation</strong></div>
        <div class="card-body d-flex flex-column">
          {% if project.output_filename %}
            <div class="mb-3">
              <div class="fw-semibold mb-2">{{ project.name }}</div>
              <dl class="row small mb-0">
                {% if compiled_media and compiled_media.duration %}
                  {% set mins = (compiled_media.duration // 60)|int %}
                  {% set secs = (compiled_media.duration % 60)|int %}
                  <dt class="col-sm-4 text-muted"><i class="bi bi-clock"></i> Duration:</dt>
                  <dd class="col-sm-8 mb-1">{{ '%d:%02d' | format(mins, secs) }}</dd>
                {% endif %}
                {% if project.output_file_size %}
                  <dt class="col-sm-4 text-muted"><i class="bi bi-file-earmark"></i> File Size:</dt>
                  <dd class="col-sm-8 mb-1">{{ '%.1f'|format(project.output_file_size / (1024*1024)) }} MB</dd>
                {% endif %}
                {% if compiled_media and compiled_media.width and compiled_media.height %}
                  <dt class="col-sm-4 text-muted"><i class="bi bi-aspect-ratio"></i> Resolution:</dt>
                  <dd class="col-sm-8 mb-1">{{ compiled_media.width }}×{{ compiled_media.height }}</dd>
                {% endif %}
                <dt class="col-sm-4 text-muted"><i class="bi bi-file-code"></i> Filename:</dt>
                <dd class="col-sm-8 mb-0 text-break">{{ project.output_filename }}</dd>
              </dl>
            </div>
            <div class="ratio ratio-16x9 mb-3">
              <video controls preload="metadata" {% if compiled_media %}poster="{{ url_for('main.media_thumbnail', media_id=compiled_media.id) }}"{% endif %}>
                <source src="{{ url_for('main.preview_compiled_output_by_public', public_id=project.public_id) if project.public_id else url_for('main.preview_compiled_output', project_id=project.id) }}" type="video/mp4">
                Your browser does not support the video tag.
              </video>
            </div>
            <div class="mt-auto d-flex gap-2">
              <a class="btn btn-outline-primary" href="{{ url_for('main.project_wizard', project_id=project.id, step=3) }}">
                <i class="bi bi-pencil"></i> Edit Timeline
              </a>
              {% if download_url %}
                <a class="btn btn-primary" href="{{ download_url }}"><i class="bi bi-download"></i> Download</a>
              {% endif %}
              <button class="btn btn-success" id="recompileBtn" data-project-id="{{ project.id }}">
                <i class="bi bi-arrow-clockwise"></i> Recompile
              </button>
            </div>
            <div class="border-top pt-3 mt-3">
              <h6 class="mb-3">Compilation Elements</h6>
              <dl class="row small mb-0">
                <dt class="col-sm-3 text-muted">Intro:</dt>
                <dd class="col-sm-9 mb-2">
                  {% if project.intro_media %}
                    {% set m = project.intro_media %}
                    <div class="d-flex align-items-center gap-2">
                      <a href="#" tabindex="0"
                         data-bs-toggle="popover"
                         data-bs-trigger="hover focus"
                         data-bs-placement="top"
                         data-bs-container="body"
                         data-bs-custom-class="media-popover"
                         data-bs-html="true"
                         data-bs-content="<img src='{{ url_for('main.media_thumbnail', media_id=m.id) }}' alt='preview'>"
                         title="{{ m.original_filename|e }}">
                        <img src="{{ url_for('main.media_thumbnail', media_id=m.id) }}" alt="intro" class="rounded" style="width:60px;height:34px;object-fit:cover;">
                      </a>
                      <span class="text-truncate" title="{{ m.original_filename }}">{{ m.original_filename }}</span>
                    </div>
                  {% else %}
                    <span class="text-muted">None</span>
                  {% endif %}
                </dd>
                <dt class="col-sm-3 text-muted">Outro:</dt>
                <dd class="col-sm-9 mb-2">
                  {% if project.outro_media %}
                    {% set m = project.outro_media %}
                    <div class="d-flex align-items-center gap-2">
                      <a href="#" tabindex="0"
                         data-bs-toggle="popover"
                         data-bs-trigger="hover focus"
                         data-bs-placement="top"
                         data-bs-container="body"
                         data-bs-custom-class="media-popover"
                         data-bs-html="true"
                         data-bs-content="<img src='{{ url_for('main.media_thumbnail', media_id=m.id) }}' alt='preview'>"
                         title="{{ m.original_filename|e }}">
                        <img src="{{ url_for('main.media_thumbnail', media_id=m.id) }}" alt="outro" class="rounded" style="width:60px;height:34px;object-fit:cover;">
                      </a>
                      <span class="text-truncate" title="{{ m.original_filename }}">{{ m.original_filename }}</span>
                    </div>
                  {% else %}
                    <span class="text-muted">None</span>
                  {% endif %}
                </dd>
                <dt class="col-sm-3 text-muted">Transitions:</dt>
                <dd class="col-sm-9 mb-0">
                  {% if project.transition_ids %}
                    {% set transition_list = project.transition_ids.split(',') if project.transition_ids else [] %}
                    {% if transition_list|length > 0 %}
                      <div class="d-flex align-items-center gap-2">
                        <span class="badge bg-success">{{ transition_list|length }} transition{{ 's' if transition_list|length != 1 else '' }}</span>
                        {% if transitions and transitions|length > 0 %}
                          <div class="d-flex flex-wrap gap-1">
                            {% for t in transitions[:5] %}
                              <a href="#" tabindex="0"
                                 data-bs-toggle="popover"
                                 data-bs-trigger="hover focus"
                                 data-bs-placement="top"
                                 data-bs-container="body"
                                 data-bs-custom-class="media-popover"
                                 data-bs-html="true"
                                 data-bs-content="<img src='{{ url_for('main.media_thumbnail', media_id=t.id) }}' alt='preview'>"
                                 title="{{ t.original_filename|e }}">
                                <img src="{{ url_for('main.media_thumbnail', media_id=t.id) }}" alt="transition" class="rounded" style="width:60px;height:34px;object-fit:cover;">
                              </a>
                            {% endfor %}
                            {% if transitions|length > 5 %}
                              <span class="text-muted small align-self-center">+{{ transitions|length - 5 }} more</span>
                            {% endif %}
                          </div>
                        {% endif %}
                      </div>
                    {% else %}
                      <span class="text-muted">None</span>
                    {% endif %}
                  {% else %}
                    <span class="text-muted">None</span>
                  {% endif %}
                </dd>
                <dt class="col-sm-3 text-muted">Background Music:</dt>
                <dd class="col-sm-9 mb-0">
                  {% if project.background_music_id %}
                    {% set music = project.background_music %}
                    <div class="d-flex align-items-center gap-2">
                      <i class="bi bi-music-note-beamed"></i>
                      <span class="text-truncate" title="{{ music.original_filename if music else 'Unknown' }}">
                        {{ music.original_filename if music else 'Music file #' ~ project.background_music_id }}
                      </span>
                      <span class="badge bg-secondary">{{ (project.music_volume * 100)|int }}% volume</span>
                    </div>
                    {% if project.music_start_mode or project.music_end_mode %}
                      <small class="text-muted d-block mt-1">
                        Start: {{ 'after intro' if project.music_start_mode == 'after_intro' else 'with video' }}
                        • End: {{ 'before outro' if project.music_end_mode == 'before_outro' else 'with video' }}
                      </small>
                    {% endif %}
                  {% else %}
                    <span class="text-muted">None</span>
                  {% endif %}
                </dd>
              </dl>
            </div>
          {% else %}
            <div class="d-flex flex-column h-100">
              <p class="text-muted mb-3">No compiled output yet.</p>
              <div class="mt-auto">
                <a class="btn btn-primary w-100 mb-2" href="{{ url_for('main.project_wizard', project_id=project.id, step=3) }}">
                  <i class="bi bi-pencil"></i> Edit Timeline &amp; Compile
                </a>
                <p class="text-muted small mb-0">Arrange your clips and create the compilation</p>
              </div>
            </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>

  <!-- Export Settings -->
  <div class="card mt-4">
    <div class="card-header">
      <strong><i class="bi bi-gear"></i> Export Settings</strong>
    </div>
    <div class="card-body">
      <div class="row g-3">
        <div class="col-md-6">
          <label class="form-label">Platform Preset</label>
          <select class="form-select" id="projectPlatformPreset" data-project-id="{{ project.id }}">
            <option value="custom" {% if project.platform_preset == 'custom' or not project.platform_preset %}selected{% endif %}>Custom</option>
            <!-- Populated dynamically via JavaScript -->
          </select>
          <small class="text-muted">Select a preset to optimize for specific platforms</small>
        </div>
        <div class="col-md-6">
          <div class="alert alert-info mb-0 small">
            <strong>Current Settings:</strong><br>
            Resolution: {{ project.resolution or '1080p' }}<br>
            Format: {{ project.format or 'mp4' }}<br>
            FPS: {{ project.fps or '60' }}
          </div>
        </div>
      </div>
      <div class="mt-3">
        <button class="btn btn-primary" id="applyPresetBtn" disabled>
          <i class="bi bi-check-circle"></i> Apply Preset
        </button>
        <small class="text-muted ms-2" id="presetFeedback"></small>
      </div>
    </div>
  </div>

  <!-- Danger Zone -->
  <div class="card border-danger mt-4">
    <div class="card-header bg-danger bg-opacity-10 border-danger">
      <h5 class="mb-0 text-danger"><i class="bi bi-exclamation-triangle"></i> Danger Zone</h5>
    </div>
    <div class="card-body">
      <div class="d-flex justify-content-between align-items-center">
        <div>
          <h6 class="mb-1">Delete this project</h6>
          <p class="text-muted small mb-0">Once you delete a project, there is no going back. This will delete all clips, media files, and compilation outputs associated with this project.</p>
        </div>
        <form method="POST" action="{{ url_for('main.delete_project', project_id=project.id) }}" onsubmit="return confirm('Are you sure you want to delete {{ project.name }}? This action cannot be undone.');" class="ms-3">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
          <button type="submit" class="btn btn-danger">
            <i class="bi bi-trash"></i> Delete Project
          </button>
        </form>
      </div>
    </div>
  </div>
</div>

<script>
// Clip hover preview functionality
(function(){
  const clipCards = document.querySelectorAll('.clip-card');
  clipCards.forEach(function(card){
    const previewUrl = card.getAttribute('data-preview-url');
    if (!previewUrl) return;
    const video = card.querySelector('video.clip-preview');
    const img = card.querySelector('img.clip-thumb');
    if (!video) return;
    let loaded = false;
    function showPreview(){
      try {
        if (!loaded) {
          video.src = previewUrl;
          loaded = true;
        }
        if (img) img.classList.add('d-none');
        video.classList.remove('d-none');
        video.play().catch(function(_){});
      } catch (_) {}
    }
    function hidePreview(){
      try {
        video.pause();
        video.currentTime = 0;
        video.classList.add('d-none');
        if (img) img.classList.remove('d-none');
      } catch (_) {}
    }
    card.addEventListener('mouseenter', showPreview);
    card.addEventListener('mouseleave', hidePreview);
  });
})();

// Platform Preset Integration for Project Details
(function initProjectPresets() {
    const presetSelect = document.getElementById('projectPlatformPreset');
    const applyBtn = document.getElementById('applyPresetBtn');
    const feedbackEl = document.getElementById('presetFeedback');

    if (!presetSelect || !applyBtn) return;

    const projectId = presetSelect.dataset.projectId;

    // Load available presets
    fetch('/api/presets')
        .then(res => res.json())
        .then(presets => {
            if (!Array.isArray(presets)) return;

            presets.forEach(preset => {
                if (preset.value === 'custom') return; // Already in HTML
                const option = document.createElement('option');
                option.value = preset.value;
                option.textContent = preset.name;
                option.dataset.settings = JSON.stringify(preset.settings);

                // Pre-select if this project has this preset
                if ('{{ project.platform_preset }}' === preset.value) {
                    option.selected = true;
                }

                presetSelect.appendChild(option);
            });
        })
        .catch(err => console.error('Failed to load presets:', err));

    // Enable apply button when preset changes
    presetSelect.addEventListener('change', function() {
        applyBtn.disabled = (this.value === 'custom');
        feedbackEl.textContent = '';
    });

    // Apply preset to project
    applyBtn.addEventListener('click', async function() {
        const selectedPreset = presetSelect.value;
        if (selectedPreset === 'custom') return;

        applyBtn.disabled = true;
        feedbackEl.textContent = 'Applying preset...';
        feedbackEl.className = 'text-muted ms-2';

        try {
            const response = await fetch(`/api/projects/${projectId}/preset`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('meta[name="csrf-token"]')?.content || ''
                },
                body: JSON.stringify({ preset: selectedPreset })
            });

            if (response.ok) {
                const result = await response.json();
                feedbackEl.textContent = `✓ Applied successfully! Reload page to see updated settings.`;
                feedbackEl.className = 'text-success ms-2';

                // Optionally reload page after 2 seconds to show updated settings
                setTimeout(() => window.location.reload(), 2000);
            } else {
                const error = await response.json();
                feedbackEl.textContent = `Error: ${error.error || 'Failed to apply preset'}`;
                feedbackEl.className = 'text-danger ms-2';
                applyBtn.disabled = false;
            }
        } catch (err) {
            console.error('Failed to apply preset:', err);
            feedbackEl.textContent = 'Failed to apply preset';
            feedbackEl.className = 'text-danger ms-2';
            applyBtn.disabled = false;
        }
    });
})();

// Project metadata editing
(function() {
    const editBtn = document.getElementById('edit-project-btn');
    const cancelBtn = document.getElementById('cancel-edit-btn');
    const saveBtn = document.getElementById('save-project-btn');
    const displaySection = document.getElementById('project-header-display');
    const editSection = document.getElementById('project-header-edit');
    const nameInput = document.getElementById('project-name-input');
    const tagsInput = document.getElementById('project-tags-input');
    const descInput = document.getElementById('project-description-input');
    const nameDisplay = document.getElementById('project-name-display');

    const projectId = {{ project.id }};

    editBtn?.addEventListener('click', function() {
        displaySection.classList.add('d-none');
        editSection.classList.remove('d-none');
        nameInput.focus();
    });

    cancelBtn?.addEventListener('click', function() {
        editSection.classList.add('d-none');
        displaySection.classList.remove('d-none');
        // Reset values
        nameInput.value = nameDisplay.textContent.trim();
        tagsInput.value = '{{ project.tags or '' }}';
        descInput.value = '{{ project.description or '' }}';
    });

    saveBtn?.addEventListener('click', async function() {
        const name = nameInput.value.trim();
        if (!name) {
            alert('Project name cannot be empty');
            return;
        }

        saveBtn.disabled = true;
        saveBtn.innerHTML = '<i class="bi bi-hourglass"></i> Saving...';

        try {
            const response = await fetch(`/api/projects/${projectId}/metadata`, {
                method: 'PATCH',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('meta[name="csrf-token"]')?.content || ''
                },
                body: JSON.stringify({
                    name: name,
                    tags: tagsInput.value.trim(),
                    description: descInput.value.trim()
                })
            });

            if (response.ok) {
                // Reload to show updated data
                window.location.reload();
            } else {
                const error = await response.json();
                alert(`Error: ${error.error || 'Failed to update project'}`);
                saveBtn.disabled = false;
                saveBtn.innerHTML = '<i class="bi bi-check-lg"></i> Save';
            }
        } catch (err) {
            console.error('Failed to update project:', err);
            alert('Failed to update project');
            saveBtn.disabled = false;
            saveBtn.innerHTML = '<i class="bi bi-check-lg"></i> Save';
        }
    });
})();

// Recompile button handler
document.getElementById('recompileBtn')?.addEventListener('click', async function() {
    const btn = this;
    const projectId = btn.dataset.projectId;

    if (!confirm('Recompile this project? This will create a new compilation with the current settings.')) {
        return;
    }

    const originalHTML = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Starting...';

    try {
        const response = await fetch(`/api/projects/${projectId}/compile`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('meta[name="csrf-token"]')?.content || ''
            }
        });

        if (response.ok) {
            const result = await response.json();
            btn.innerHTML = '<i class="bi bi-check-circle"></i> Compiling...';

            // Show success message
            alert(`Compilation started! Task ID: ${result.task_id || 'N/A'}\n\nYou can monitor progress in the background. The page will show the new compilation when ready.`);

            // Optionally redirect to a task monitoring page or reload after delay
            setTimeout(() => {
                window.location.reload();
            }, 2000);
        } else {
            const error = await response.json();
            alert(`Error: ${error.error || 'Failed to start compilation'}`);
            btn.disabled = false;
            btn.innerHTML = originalHTML;
        }
    } catch (err) {
        console.error('Failed to recompile:', err);
        alert('Failed to start compilation. Please try again.');
        btn.disabled = false;
        btn.innerHTML = originalHTML;
    }
});
</script>
{% endblock %}

{% extends "base.html" %}

{% block content %}
<div class="container py-4">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <div>
      <h2 class="mb-0"><i class="bi bi-folder"></i> {{ project.name }}</h2>
    </div>
    <div>
      <button class="btn btn-outline-primary btn-sm" id="saveAsTemplateBtn">
        <i class="bi bi-file-earmark-code"></i> Save as Template
      </button>
    </div>
  </div>

  {% if project.description %}
  <p class="text-muted">{{ project.description }}</p>
  {% endif %}

  <div class="row g-4">
    <!-- Clips Card -->
    <div class="col-lg-7">
      <div class="card h-100">
        <div class="card-header card-header--primary d-flex justify-content-between align-items-center">
          <strong>Clips</strong>
          <small class="text-muted">
            {% if used_only %}
              {{ used_count }} used of {{ total_clip_count }}
            {% else %}
              {{ total_clip_count }} total
            {% endif %}
          </small>
        </div>
        <div class="card-body">
          {% if clips %}
          <div class="row row-cols-1 row-cols-md-2 g-3">
            {% for c in clips %}
            <div class="col">
              <div class="border rounded p-3 h-100 clip-card position-relative" data-preview-url="{% if c.media_file %}{{ url_for('main.media_preview', media_id=c.media_file.id) }}{% endif %}">
                <div class="d-flex align-items-start">
                  {% if c.media_file and c.media_file.thumbnail_path %}
                    <div class="position-relative me-3" style="width: 120px; height: 68px;">
                      <img src="{{ url_for('main.media_thumbnail', media_id=c.media_file.id) }}" class="clip-thumb rounded" style="width: 120px; height: 68px; object-fit: cover;" alt="thumb">
                      <video class="position-absolute top-0 start-0 clip-preview d-none rounded" muted loop playsinline preload="metadata" style="width: 120px; height: 68px; object-fit: cover;"></video>
                      {% if c.duration %}
                        {% set mins = (c.duration // 60)|int %}
                        {% set secs = (c.duration % 60)|int %}
                        <span class="badge bg-dark position-absolute bottom-0 end-0 m-1" style="opacity:0.9; font-size:0.7rem;">
                          {{ '%d:%02d' | format(mins, secs) }}
                        </span>
                      {% endif %}
                    </div>
                  {% endif %}
                  <div class="flex-grow-1">
                    <div class="fw-semibold text-truncate mb-1" title="{{ c.title }}">{{ c.title }}</div>
                    <ul class="small text-muted mb-0 list-unstyled">
                      {% if c.creator_name %}<li class="mb-1"><i class="bi bi-person-fill me-1"></i>{{ c.creator_name }}</li>{% endif %}
                      {% if c.clip_created_at %}<li class="mb-1"><i class="bi bi-calendar me-1"></i>{{ c.clip_created_at.strftime('%b %d, %Y') }}</li>{% endif %}
                      {% if c.game_name %}<li class="mb-1"><i class="bi bi-controller me-1"></i>{{ c.game_name }}</li>{% endif %}
                      {% if c.source_platform %}
                        <li><i class="bi bi-box-arrow-up-right me-1"></i>{{ c.source_platform|title }}{% if c.source_url %} · <a href="{{ c.source_url }}" target="_blank" class="text-decoration-none">view</a>{% endif %}</li>
                      {% endif %}
                    </ul>
                  </div>
                </div>
              </div>
            </div>
            {% endfor %}
          </div>
          {% else %}
          <p class="text-muted mb-0">No clips yet.</p>
          {% endif %}
        </div>
      </div>
    </div>

    <!-- Compilation Card -->
    <div class="col-lg-5">
      <div class="card h-100">
        <div class="card-header card-header--primary"><strong>Compilation</strong></div>
        <div class="card-body d-flex flex-column">
          {% if project.output_filename %}
            <div class="mb-3">
              <div class="fw-semibold mb-2">{{ project.name }}</div>
              <dl class="row small mb-0">
                {% if compiled_media and compiled_media.duration %}
                  {% set mins = (compiled_media.duration // 60)|int %}
                  {% set secs = (compiled_media.duration % 60)|int %}
                  <dt class="col-sm-4 text-muted"><i class="bi bi-clock"></i> Duration:</dt>
                  <dd class="col-sm-8 mb-1">{{ '%d:%02d' | format(mins, secs) }}</dd>
                {% endif %}
                {% if project.output_file_size %}
                  <dt class="col-sm-4 text-muted"><i class="bi bi-file-earmark"></i> File Size:</dt>
                  <dd class="col-sm-8 mb-1">{{ '%.1f'|format(project.output_file_size / (1024*1024)) }} MB</dd>
                {% endif %}
                {% if compiled_media and compiled_media.width and compiled_media.height %}
                  <dt class="col-sm-4 text-muted"><i class="bi bi-aspect-ratio"></i> Resolution:</dt>
                  <dd class="col-sm-8 mb-1">{{ compiled_media.width }}×{{ compiled_media.height }}</dd>
                {% endif %}
                <dt class="col-sm-4 text-muted"><i class="bi bi-file-code"></i> Filename:</dt>
                <dd class="col-sm-8 mb-0 text-break">{{ project.output_filename }}</dd>
              </dl>
            </div>
            <div class="ratio ratio-16x9 mb-3">
              <video controls preload="metadata" {% if compiled_media %}poster="{{ url_for('main.media_thumbnail', media_id=compiled_media.id) }}"{% endif %}>
                <source src="{{ url_for('main.preview_compiled_output_by_public', public_id=project.public_id) if project.public_id else url_for('main.preview_compiled_output', project_id=project.id) }}" type="video/mp4">
                Your browser does not support the video tag.
              </video>
            </div>
            <div class="mt-auto d-flex gap-2">
              {% if download_url %}
                <a class="btn btn-primary" href="{{ download_url }}"><i class="bi bi-download"></i> Download</a>
              {% endif %}
              <button class="btn btn-outline-secondary" disabled title="Coming soon"><i class="bi bi-youtube"></i> Share to YouTube</button>
            </div>
            <div class="border-top pt-3 mt-3">
              <h6 class="mb-3">Compilation Elements</h6>
              <dl class="row small mb-0">
                <dt class="col-sm-3 text-muted">Intro:</dt>
                <dd class="col-sm-9 mb-2">
                  {% if intros and intros|length > 0 %}
                    {% set m = intros[0] %}
                    <div class="d-flex align-items-center gap-2">
                      <a href="#" tabindex="0"
                         data-bs-toggle="popover"
                         data-bs-trigger="hover focus"
                         data-bs-placement="top"
                         data-bs-container="body"
                         data-bs-custom-class="media-popover"
                         data-bs-html="true"
                         data-bs-content="<img src='{{ url_for('main.media_thumbnail', media_id=m.id) }}' alt='preview'>"
                         title="{{ m.original_filename|e }}">
                        <img src="{{ url_for('main.media_thumbnail', media_id=m.id) }}" alt="intro" class="rounded" style="width:60px;height:34px;object-fit:cover;">
                      </a>
                      <span class="text-truncate" title="{{ m.original_filename }}">{{ m.original_filename }}</span>
                    </div>
                  {% else %}
                    <span class="text-muted">None</span>
                  {% endif %}
                </dd>
                <dt class="col-sm-3 text-muted">Outro:</dt>
                <dd class="col-sm-9 mb-2">
                  {% if outros and outros|length > 0 %}
                    {% set m = outros[0] %}
                    <div class="d-flex align-items-center gap-2">
                      <a href="#" tabindex="0"
                         data-bs-toggle="popover"
                         data-bs-trigger="hover focus"
                         data-bs-placement="top"
                         data-bs-container="body"
                         data-bs-custom-class="media-popover"
                         data-bs-html="true"
                         data-bs-content="<img src='{{ url_for('main.media_thumbnail', media_id=m.id) }}' alt='preview'>"
                         title="{{ m.original_filename|e }}">
                        <img src="{{ url_for('main.media_thumbnail', media_id=m.id) }}" alt="outro" class="rounded" style="width:60px;height:34px;object-fit:cover;">
                      </a>
                      <span class="text-truncate" title="{{ m.original_filename }}">{{ m.original_filename }}</span>
                    </div>
                  {% else %}
                    <span class="text-muted">None</span>
                  {% endif %}
                </dd>
                <dt class="col-sm-3 text-muted">Transitions:</dt>
                <dd class="col-sm-9 mb-0">
                  {% if transitions and transitions|length > 0 %}
                    <div class="d-flex flex-wrap gap-2">
                      {% for t in transitions %}
                        <a href="#" tabindex="0"
                           data-bs-toggle="popover"
                           data-bs-trigger="hover focus"
                           data-bs-placement="top"
                           data-bs-container="body"
                           data-bs-custom-class="media-popover"
                           data-bs-html="true"
                           data-bs-content="<img src='{{ url_for('main.media_thumbnail', media_id=t.id) }}' alt='preview'>"
                           title="{{ t.original_filename|e }}">
                          <img src="{{ url_for('main.media_thumbnail', media_id=t.id) }}" alt="transition" class="rounded" style="width:60px;height:34px;object-fit:cover;">
                        </a>
                      {% endfor %}
                    </div>
                  {% else %}
                    <span class="text-muted">None</span>
                  {% endif %}
                </dd>
              </dl>
            </div>
          {% else %}
            <p class="text-muted mb-0">No compiled output yet. Click Compile to start.</p>
          {% endif %}
        </div>
      </div>
    </div>
  </div>

  <!-- Export Settings -->
  <div class="card mt-4">
    <div class="card-header">
      <strong><i class="bi bi-gear"></i> Export Settings</strong>
    </div>
    <div class="card-body">
      <div class="row g-3">
        <div class="col-md-6">
          <label class="form-label">Platform Preset</label>
          <select class="form-select" id="projectPlatformPreset" data-project-id="{{ project.id }}">
            <option value="custom" {% if project.platform_preset == 'custom' or not project.platform_preset %}selected{% endif %}>Custom</option>
            <!-- Populated dynamically via JavaScript -->
          </select>
          <small class="text-muted">Select a preset to optimize for specific platforms</small>
        </div>
        <div class="col-md-6">
          <div class="alert alert-info mb-0 small">
            <strong>Current Settings:</strong><br>
            Resolution: {{ project.resolution or '1080p' }}<br>
            Format: {{ project.format or 'mp4' }}<br>
            FPS: {{ project.fps or '60' }}
          </div>
        </div>
      </div>
      <div class="mt-3">
        <button class="btn btn-primary" id="applyPresetBtn" disabled>
          <i class="bi bi-check-circle"></i> Apply Preset
        </button>
        <small class="text-muted ms-2" id="presetFeedback"></small>
      </div>
    </div>
  </div>

  <!-- Danger Zone -->
  <div class="card border-danger mt-4">
    <div class="card-header bg-danger bg-opacity-10 border-danger">
      <h5 class="mb-0 text-danger"><i class="bi bi-exclamation-triangle"></i> Danger Zone</h5>
    </div>
    <div class="card-body">
      <div class="d-flex justify-content-between align-items-center">
        <div>
          <h6 class="mb-1">Delete this project</h6>
          <p class="text-muted small mb-0">Once you delete a project, there is no going back. This will delete all clips, media files, and compilation outputs associated with this project.</p>
        </div>
        <form method="POST" action="{{ url_for('main.delete_project', project_id=project.id) }}" onsubmit="return confirm('Are you sure you want to delete {{ project.name }}? This action cannot be undone.');" class="ms-3">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
          <button type="submit" class="btn btn-danger">
            <i class="bi bi-trash"></i> Delete Project
          </button>
        </form>
      </div>
    </div>
  </div>
</div>

<script>
// Clip hover preview functionality
(function(){
  const clipCards = document.querySelectorAll('.clip-card');
  clipCards.forEach(function(card){
    const previewUrl = card.getAttribute('data-preview-url');
    if (!previewUrl) return;
    const video = card.querySelector('video.clip-preview');
    const img = card.querySelector('img.clip-thumb');
    if (!video) return;
    let loaded = false;
    function showPreview(){
      try {
        if (!loaded) {
          video.src = previewUrl;
          loaded = true;
        }
        if (img) img.classList.add('d-none');
        video.classList.remove('d-none');
        video.play().catch(function(_){});
      } catch (_) {}
    }
    function hidePreview(){
      try {
        video.pause();
        video.currentTime = 0;
        video.classList.add('d-none');
        if (img) img.classList.remove('d-none');
      } catch (_) {}
    }
    card.addEventListener('mouseenter', showPreview);
    card.addEventListener('mouseleave', hidePreview);
  });
})();

document.getElementById('saveAsTemplateBtn')?.addEventListener('click', async function() {
    const templateName = prompt('Enter a name for this template:', '{{ project.name }} Template');
    if (!templateName) return;

    const description = prompt('Enter a description (optional):');

    try {
        const response = await fetch('/api/templates', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('meta[name="csrf-token"]')?.content || ''
            },
            body: JSON.stringify({
                name: templateName,
                description: description || '',
                project_id: {{ project.id }}
            })
        });

        if (response.ok) {
            alert('Template created successfully!');
            window.location.href = '/templates';
        } else {
            const error = await response.json();
            alert('Error: ' + (error.error || 'Failed to create template'));
        }
    } catch (error) {
        console.error('Error creating template:', error);
        alert('Failed to create template');
    }
});

// Platform Preset Integration for Project Details
(function initProjectPresets() {
    const presetSelect = document.getElementById('projectPlatformPreset');
    const applyBtn = document.getElementById('applyPresetBtn');
    const feedbackEl = document.getElementById('presetFeedback');

    if (!presetSelect || !applyBtn) return;

    const projectId = presetSelect.dataset.projectId;

    // Load available presets
    fetch('/api/presets')
        .then(res => res.json())
        .then(presets => {
            if (!Array.isArray(presets)) return;

            presets.forEach(preset => {
                if (preset.value === 'custom') return; // Already in HTML
                const option = document.createElement('option');
                option.value = preset.value;
                option.textContent = preset.name;
                option.dataset.settings = JSON.stringify(preset.settings);

                // Pre-select if this project has this preset
                if ('{{ project.platform_preset }}' === preset.value) {
                    option.selected = true;
                }

                presetSelect.appendChild(option);
            });
        })
        .catch(err => console.error('Failed to load presets:', err));

    // Enable apply button when preset changes
    presetSelect.addEventListener('change', function() {
        applyBtn.disabled = (this.value === 'custom');
        feedbackEl.textContent = '';
    });

    // Apply preset to project
    applyBtn.addEventListener('click', async function() {
        const selectedPreset = presetSelect.value;
        if (selectedPreset === 'custom') return;

        applyBtn.disabled = true;
        feedbackEl.textContent = 'Applying preset...';
        feedbackEl.className = 'text-muted ms-2';

        try {
            const response = await fetch(`/api/projects/${projectId}/preset`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('meta[name="csrf-token"]')?.content || ''
                },
                body: JSON.stringify({ preset: selectedPreset })
            });

            if (response.ok) {
                const result = await response.json();
                feedbackEl.textContent = `✓ Applied successfully! Reload page to see updated settings.`;
                feedbackEl.className = 'text-success ms-2';

                // Optionally reload page after 2 seconds to show updated settings
                setTimeout(() => window.location.reload(), 2000);
            } else {
                const error = await response.json();
                feedbackEl.textContent = `Error: ${error.error || 'Failed to apply preset'}`;
                feedbackEl.className = 'text-danger ms-2';
                applyBtn.disabled = false;
            }
        } catch (err) {
            console.error('Failed to apply preset:', err);
            feedbackEl.textContent = 'Failed to apply preset';
            feedbackEl.className = 'text-danger ms-2';
            applyBtn.disabled = false;
        }
    });
})();
</script>
{% endblock %}

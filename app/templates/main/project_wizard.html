{% extends "base.html" %}

{% block styles %}
{{ super() }}
<link rel="stylesheet" href="{{ url_for('static', filename='css/wizard.css') }}">
<style>
  /* Larger checkbox for timeline confirmation */
  #arranged-confirm {
    width: 1.5em;
    height: 1.5em;
    cursor: pointer;
  }
  #arranged-confirm + label {
    cursor: pointer;
    font-size: 1.1rem;
    font-weight: 500;
    margin-left: 0.5rem;
  }
  .timeline-confirm-box {
    background: var(--bs-secondary-bg);
    border: none;
    border-radius: 2rem;
    padding: 1.25rem 2rem;
    text-align: center;
    transition: all 0.2s ease;
    display: inline-block;
    max-width: fit-content;
    margin: 0 auto;
  }
  .timeline-confirm-box:hover {
    background: var(--bs-secondary);
    color: white;
  }
  .timeline-confirm-box:hover #arranged-confirm + label {
    color: white;
  }
  .timeline-confirm-box .form-check {
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0;
  }
  .timeline-confirm-box .form-check-label {
    font-size: 1.3rem;
    font-weight: 600;
    margin-bottom: 0;
  }
</style>
{% endblock %}

{% block content %}
<!-- Celebration canvas overlay (hidden by default) -->
<canvas id="celebration-canvas" style="position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; pointer-events: none; z-index: 9999; display: none;"></canvas>

<div class="container py-4">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h2 class="mb-0 d-flex align-items-center">
      <i class="bi bi-magic"></i>
      {% if existing_project %}
        Edit Project: {{ existing_project.name }}
      {% else %}
        New Project Wizard
      {% endif %}
      <button type="button" class="btn btn-sm btn-link text-muted p-0 ms-2"
              data-bs-toggle="popover"
              data-bs-placement="bottom"
              data-bs-title="Quick Start: Creating Projects"
              data-bs-html="true"
              data-bs-content='<p class="mb-2">The wizard guides you through 4 simple steps:</p>
                               <ol class="small mb-2">
                                 <li><strong>Setup:</strong> Choose source and configure settings</li>
                                 <li><strong>Get Clips:</strong> Fetch videos from Twitch/Discord</li>
                                 <li><strong>Arrange:</strong> Build your timeline</li>
                                 <li><strong>Compile:</strong> Render the final video</li>
                               </ol>
                               <div class="mt-2 pt-2 border-top">
                                 <a href="{{ url_for("help.topic", topic="creating-projects") }}" class="btn btn-sm btn-outline-primary w-100">
                                   <i class="bi bi-book me-1"></i> Full Guide
                                 </a>
                               </div>'>
        <i class="bi bi-question-circle-fill"></i>
      </button>
    </h2>
  <a class="btn btn-outline-secondary" href="{% if existing_project %}{{ url_for('main.project_details_by_public', public_id=existing_project.public_id) }}{% else %}{{ url_for('main.projects') }}{% endif %}">
    {% if existing_project %}Back to Project{% else %}Back to Projects{% endif %}
  </a>
  </div>

  <div class="card">
    <div class="card-header card-header--primary mb-3">Project Wizard</div>
    <div class="card-body">
      <!-- Wizard chevron progress: 1) Setup 2) Get Clips 3) Arrange 4) Compile -->
      <div class="chevron-steps mb-3">
        <ul class="progress" id="wizard-chevrons">
          <li data-step="1" class="active"><a href="#">Setup</a></li>
          <li data-step="2"><a href="#">Get Clips</a></li>
          <li data-step="3"><a href="#">Arrange</a></li>
          <li data-step="4"><a href="#">Compile</a></li>
        </ul>
      </div>
  <div id="wizard-data" data-user-has-twitch="{{ '1' if current_user.is_authenticated and current_user.twitch_username else '0' }}" data-date-format="{{ current_user.date_format if current_user.is_authenticated else 'auto' }}" class="d-none"></div>
      <!-- Step 1: Setup -->
      {% include 'main/wizard/step_setup.html' %}

      <!-- Step 2: Get Clips -->
      {% include 'main/wizard/step_clips.html' %}

      <!-- Step 3: Arrange -->
      {% include 'main/wizard/step_arrange.html' %}

      <!-- Step 4: Compile -->
      <div class="wizard-step d-none" data-step="4">
        <!-- Keyboard Shortcuts Help -->
        <div class="alert alert-light border d-flex justify-content-between align-items-center mb-3">
          <div>
            <strong><i class="bi bi-keyboard"></i> Keyboard Shortcuts:</strong>
            <span class="ms-2 small text-muted">
              <kbd>Ctrl+Enter</kbd> Start compilation
            </span>
          </div>
        </div>

        <!-- Render summary/details -->
        <div id="compile-details" class="mb-3"></div>

        <!-- Compilation Controls -->
        <div class="d-flex gap-2 align-items-center mb-3">
          <button class="btn btn-primary btn-shadow-dark" id="start-compile">
            <i class="bi bi-play-circle"></i> Start Compilation
          </button>
          <button class="btn btn-outline-danger" id="cancel-compile" disabled>
            <i class="bi bi-x-circle"></i> Cancel
          </button>
        </div>

        <!-- Progress Bar -->
        <div class="mb-3">
          <p id="compile-progress-label" data-value="0">Ready.</p>
          <progress id="compile-progress-bar" max="100" value="0" class="compile">
            <div class="progress-bar">
              <span style="width: 0%">0%</span>
            </div>
          </progress>
        </div>

        <!-- Compile Log -->
        <div class="card">
          <div class="card-header">
            <strong><i class="bi bi-terminal"></i> Compilation Log</strong>
          </div>
          <div class="card-body p-0">
            <pre class="bg-dark text-light p-3 m-0 rounded-bottom" id="compile-log" style="min-height: 140px; max-height: 280px; overflow: auto; font-size: 0.85rem;">Ready to compile your video.</pre>
          </div>
        </div>

        <!-- Navigation -->
        <div class="d-flex justify-content-between wizard-nav mt-4">
          <button class="btn btn-outline-secondary" data-prev="3">
            <i class="bi bi-arrow-left"></i> Back: Arrange
          </button>
          <button class="btn btn-success btn-glow btn-shadow-dark" id="next-4" disabled>
            <i class="bi bi-check-circle"></i> View Project
          </button>
        </div>

        <!-- Preview Section (hidden by default) -->
        <div class="position-relative mt-3 d-none" id="compilation-preview">
          <div class="text-center">
            <div class="spinner-border spinner-border-sm mb-2" role="status">
              <span class="visually-hidden">Loading...</span>
            </div>
            <div class="small">Loading preview...</div>
          </div>
          <img class="compilation-preview-img img-fluid rounded border"
               alt="Compilation Preview"
               style="max-width: 100%; max-height: 300px; display: none; width: 100%;">
          <video class="compilation-preview-video img-fluid rounded border"
                 style="max-width: 100%; max-height: 300px; display: none; width: 100%;"
                 controls muted loop playsinline></video>
          <div class="preview-placeholder bg-dark border rounded d-flex align-items-center justify-content-center text-muted" style="position: absolute; top: 0; left: 0; right: 0; height: 160px; display: flex;">
            <div class="text-center">
              <div class="spinner-border spinner-border-sm mb-2" role="status">
                <span class="visually-hidden">Loading...</span>
              </div>
              <div class="small">Loading preview...</div>
            </div>
          </div>
        </div>
      </div>


    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
  // Initialize wizard with existing project if provided
  {% if existing_project %}
  window.wizardExistingProject = {
    id: {{ existing_project.id }},
    name: {{ existing_project.name|tojson }},
    description: {{ existing_project.description|tojson if existing_project.description else 'null' }},
    initialStep: {{ initial_step }}
  };
  {% endif %}
</script>
{# Feature flag: use new modular wizard if enabled #}
{% if config.get('USE_NEW_WIZARD', False) %}
<script type="module">
  import { initWizard } from "{{ url_for('static', filename='js/wizard/core.js') }}";
  document.addEventListener('DOMContentLoaded', initWizard);
</script>
{% else %}
{# Legacy monolithic wizard #}
<script src="{{ url_for('static', filename='js/wizard.js') }}"></script>
{% endif %}
{% endblock %}

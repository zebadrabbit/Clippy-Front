{% extends "base.html" %}

{% block styles %}
{{ super() }}
<link rel="stylesheet" href="{{ url_for('static', filename='css/wizard.css') }}">
<style>
  /* Larger checkbox for timeline confirmation */
  #arranged-confirm {
    width: 1.5em;
    height: 1.5em;
    cursor: pointer;
  }
  #arranged-confirm + label {
    cursor: pointer;
    font-size: 1.1rem;
    font-weight: 500;
    margin-left: 0.5rem;
  }
  .timeline-confirm-box {
    background: var(--bs-secondary-bg);
    border: none;
    border-radius: 2rem;
    padding: 1.25rem 2rem;
    text-align: center;
    transition: all 0.2s ease;
    display: inline-block;
    max-width: fit-content;
    margin: 0 auto;
  }
  .timeline-confirm-box:hover {
    background: var(--bs-secondary);
    color: white;
  }
  .timeline-confirm-box:hover #arranged-confirm + label {
    color: white;
  }
  .timeline-confirm-box .form-check {
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0;
  }
  .timeline-confirm-box .form-check-label {
    font-size: 1.3rem;
    font-weight: 600;
    margin-bottom: 0;
  }
</style>
{% endblock %}

{% block content %}
<!-- Celebration canvas overlay (hidden by default) -->
<canvas id="celebration-canvas" style="position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; pointer-events: none; z-index: 9999; display: none;"></canvas>

<div class="container py-4">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h2 class="mb-0 d-flex align-items-center">
      <i class="bi bi-magic"></i>
      {% if existing_project %}
        Edit Project: {{ existing_project.name }}
      {% else %}
        New Project Wizard
      {% endif %}
      <button type="button" class="btn btn-sm btn-link text-muted p-0 ms-2"
              data-bs-toggle="popover"
              data-bs-placement="bottom"
              data-bs-title="Quick Start: Creating Projects"
              data-bs-html="true"
              data-bs-content='<p class="mb-2">The wizard guides you through 4 simple steps:</p>
                               <ol class="small mb-2">
                                 <li><strong>Setup:</strong> Choose source and configure settings</li>
                                 <li><strong>Get Clips:</strong> Fetch videos from Twitch/Discord</li>
                                 <li><strong>Arrange:</strong> Build your timeline</li>
                                 <li><strong>Compile:</strong> Render the final video</li>
                               </ol>
                               <div class="mt-2 pt-2 border-top">
                                 <a href="{{ url_for("help.topic", topic="creating-projects") }}" class="btn btn-sm btn-outline-primary w-100">
                                   <i class="bi bi-book me-1"></i> Full Guide
                                 </a>
                               </div>'>
        <i class="bi bi-question-circle-fill"></i>
      </button>
    </h2>
  <a class="btn btn-outline-secondary" href="{% if existing_project %}{{ url_for('main.project_details_by_public', public_id=existing_project.public_id) }}{% else %}{{ url_for('main.projects') }}{% endif %}">
    {% if existing_project %}Back to Project{% else %}Back to Projects{% endif %}
  </a>
  </div>

  <div class="card">
    <div class="card-header card-header--primary mb-3">Project Wizard</div>
    <div class="card-body">
      <!-- Wizard chevron progress: 1) Setup 2) Get Clips 3) Arrange 4) Compile -->
      <div class="chevron-steps mb-3">
        <ul class="progress" id="wizard-chevrons">
          <li data-step="1" class="active"><a href="#">Setup</a></li>
          <li data-step="2"><a href="#">Get Clips</a></li>
          <li data-step="3"><a href="#">Arrange</a></li>
          <li data-step="4"><a href="#">Compile</a></li>
        </ul>
      </div>
  <div id="wizard-data" data-user-has-twitch="{{ '1' if current_user.is_authenticated and current_user.twitch_username else '0' }}" data-date-format="{{ current_user.date_format if current_user.is_authenticated else 'auto' }}" class="d-none"></div>
      <!-- Step 1: Setup -->
      {% include 'main/wizard/step_setup.html' %}

      <!-- Step 2: Get Clips -->
      {% include 'main/wizard/step_clips.html' %}

      <!-- Step 3: Arrange -->
      {% include 'main/wizard/step_arrange.html' %}

      <!-- Step 4: Compile -->
      {% include 'main/wizard/step_compile.html' %}


    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
  // Initialize wizard with existing project if provided
  {% if existing_project %}
  window.wizardExistingProject = {
    id: {{ existing_project.id }},
    name: {{ existing_project.name|tojson }},
    description: {{ existing_project.description|tojson if existing_project.description else 'null' }},
    initialStep: {{ initial_step }}
  };
  {% endif %}
</script>
{# Feature flag: use new modular wizard if enabled #}
{% if config.get('USE_NEW_WIZARD', False) %}
<script type="module">
  import { initWizard } from "{{ url_for('static', filename='js/wizard/core.js') }}";
  document.addEventListener('DOMContentLoaded', initWizard);
</script>
{% else %}
{# Legacy monolithic wizard #}
<script src="{{ url_for('static', filename='js/wizard.js') }}"></script>
{% endif %}
{% endblock %}

{% extends "base.html" %}

{% block styles %}
{{ super() }}
<link rel="stylesheet" href="{{ url_for('static', filename='css/wizard.css') }}">
{% endblock %}

{% block content %}
<div class="container py-4">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h2 class="mb-0"><i class="bi bi-magic"></i> New Project Wizard</h2>
  <a class="btn btn-outline-secondary" href="{{ url_for('main.projects') }}">Back to Projects</a>
  </div>

  <div class="card">
    <div class="card-header card-header--primary mb-3">Project Wizard</div>
    <div class="card-body">
      <!-- Wizard chevron progress: 1) Setup 2) Get Clips 3) Arrange 4) Compile 5) Export -->
      <div class="chevron-steps mb-3">
        <ul class="progress" id="wizard-chevrons">
          <li data-step="1" class="active"><a href="#">Setup</a></li>
          <li data-step="2"><a href="#">Get Clips</a></li>
          <li data-step="3"><a href="#">Arrange</a></li>
          <li data-step="4"><a href="#">Compile</a></li>
          <li data-step="5"><a href="#">Export</a></li>
        </ul>
      </div>
  <div id="wizard-data" data-user-has-twitch="{{ '1' if current_user.is_authenticated and current_user.twitch_username else '0' }}" data-date-format="{{ current_user.date_format if current_user.is_authenticated else 'auto' }}" class="d-none"></div>
      <!-- Step 1: Setup -->
      <div class="wizard-step" data-step="1">
        <form id="setup-form" class="row g-3">
          <div class="col-md-4">
            <label class="form-label">Route</label>
            <select class="form-select" name="route" id="route-select">
              <option value="twitch" selected>Twitch</option>
              <option value="discord">Discord</option>
            </select>
          </div>
          <div class="row g-2">
          <div class="col-12">
            <div class="alert alert-warning d-none" id="twitch-warning">
              <strong>Twitch not connected.</strong> Add your Twitch username to unlock fetching clips.
              <a href="{{ url_for('auth.profile') }}" class="alert-link">Open your profile</a>.
            </div>
          </div>
          <div class="col-12">
            <div class="row g-3 align-items-stretch">
              <div class="col-md-6">
                <label class="form-label">Project Name</label>
                <input class="form-control" name="name" placeholder="My Compilation">
                <label class="form-label mt-3">Description (optional)</label>
                <textarea class="form-control" name="description" rows="4" placeholder="Short description..."></textarea>
              </div>
              <div class="col-md-5 offset-md-1">
                <div class="card audio-norm-card">
                  <div class="card-header card-header--accent d-flex align-items-center justify-content-between">
                    <div class="d-flex align-items-center gap-2 audio-norm-head">
                      <input class="form-check-input" type="checkbox" id="audio-norm-enabled">
                      <label class="form-label mb-0" for="audio-norm-enabled">Audio Normalization</label>
                    </div>
                    <span class="small" style="opacity: .85;">optional</span>
                  </div>
                  <div class="card-body">
                    <div class="opt-slider" id="audio-norm-slider" data-count="4">
                      <input type="radio" name="audio_norm_profile" id="an-music" value="music" data-db="-1">
                      <label for="an-music" data-label="Music (-1 dB)"></label>
                      <input type="radio" name="audio_norm_profile" id="an-podcast" value="podcast" data-db="-3">
                      <label for="an-podcast" data-label="Podcasts (-3 dB)"></label>
                      <input type="radio" name="audio_norm_profile" id="an-broadcast" value="broadcast" data-db="-2">
                      <label for="an-broadcast" data-label="Broadcast (-2 dB)"></label>
                      <input type="radio" name="audio_norm_profile" id="an-gaming" value="gaming" data-db="-4" checked>
                      <label for="an-gaming" data-label="Gaming (-4 dB)"></label>
                      <div class="pos" aria-hidden="true"></div>
                    </div>
                    <input type="hidden" name="audio_norm_db" id="audio_norm_db" value="-4">
                  </div>
                </div>
              </div>
            </div>
          </div>
          </div>
          <div class="row g-2">
          <div class="col-4">
            <label class="form-label">Output</label>
            <div class="row g-2">
              <div class="col-md-4">
                <select class="form-select" name="resolution">
                  <option value="720p">720p</option>
                  <option value="1080p" selected>1080p</option>
                  <option value="1440p">1440p</option>
                </select>
              </div>
              <div class="col-md-4">
                <select class="form-select" name="format">
                  <option value="mp4" selected>MP4</option>
                  <option value="webm">WebM</option>
                </select>
              </div>
              <div class="col-md-4">
                <select class="form-select" name="fps">
                  <option value="30">30 fps</option>
                  <option value="60" selected>60 fps</option>
                  <option value="120">120 fps</option>
                </select>
              </div>
            </div>
          </div>
          </div>

          <div class="row g-2">
          <div class="col-8">
            <label class="form-label">Search Parameters</label>
            <div class="row g-2">
              <div class="col-md-3">
                <label class="form-label">Max Clips</label>
                <input type="number" min="1" max="500" step="1" class="form-control" name="max_clips" value="10">
              </div>
              <div class="col-md-3">
                <label class="form-label">Min Clip Length (sec)</label>
                <input type="number" min="1" max="600" step="1" class="form-control" name="min_len" value="5">
              </div>
              <div class="col-md-3">
                <label class="form-label">Min Views (optional)</label>
                <input type="number" class="form-control" name="min_views" placeholder="e.g. 1000">
              </div>
            </div>
          </div>
          <div class="col-4">
            <label class="form-label">Date Range (Optional)</label>
            <div class="row g-2">
              <div class="col-md-6">
                <label class="form-label">Start Date</label>
                <input type="date" class="form-control" name="start_date">
              </div>
              <div class="col-md-6">
                <label class="form-label">End Date</label>
                <input type="date" class="form-control" name="end_date">
              </div>
            </div>
          </div>
          </div>
        </form>
        <div class="d-flex justify-content-end wizard-nav mt-4">
          <div class="d-flex gap-2">
            <button class="btn btn-accent btn-glow btn-shadow-dark" id="save-as-task" type="button"><i class="bi bi-save"></i> Save as task</button>
            <button class="btn btn-primary btn-glow btn-shadow-dark" id="next-1" type="button">Next: Get Clips</button>
          </div>
        </div>
      </div>

  <!-- Step 2: Get Clips (consolidates Fetch + Parse + Download) -->
      <div class="wizard-step d-none" data-step="2">
        <div class="chevron-progress">
          <div class="chevron-label" id="gc-status">Warming up the clippersâ€¦</div>
          <div class="chevron-steps">
            <ul class="progress" id="gc-steps">
              <li data-key="fetch" class="active"><a href="#">Fetch</a></li>
              <li data-key="extract"><a href="#">Parse</a></li>
              <li data-key="download"><a href="#">Download</a></li>
              <li data-key="import"><a href="#">Import</a></li>
              <li data-key="done"><a href="#">Done</a></li>
            </ul>
          </div>
        </div>
        <div class="mt-4 d-flex justify-content-between wizard-nav">
          <button class="btn btn-outline-secondary" data-prev="1">Back: Setup</button>
          <div class="d-flex gap-2">
            <button class="btn btn-outline-danger d-none" id="gc-cancel">Cancel</button>
            <button class="btn btn-primary btn-glow btn-shadow-dark" id="next-2" disabled>Next: Arrange Timeline</button>
          </div>
        </div>
      </div>

      <!-- Step 3: Arrange -->
      <div class="wizard-step d-none" data-step="3">
        <!-- Ingest banner (shown while auto-importing rsynced clips) -->
        <div id="arrange-ingest-banner" class="alert alert-info d-none d-flex align-items-center gap-2 mb-3" role="status" aria-live="polite">
          <div class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></div>
          <div id="arrange-ingest-text">Importing rsynced raw clipsâ€¦</div>
        </div>
        <!-- Timeline on top -->
        <div class="mb-3">
          <div class="card">
            <div class="card-header">Timeline</div>
            <div class="card-body" id="timeline">
              <div id="timeline-info" class="mb-2"></div>
              <div class="timeline-drop-indicator" id="timeline-drop-top"></div>
              <div class="timeline-list" id="timeline-list"></div>
              <div class="timeline-drop-indicator" id="timeline-drop-bottom"></div>
            </div>
          </div>
        </div>

        <!-- Downloaded Clips next (collapsible) -->
        <div class="mb-3">
          <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
              <button class="btn btn-sm btn-outline-secondary" data-bs-toggle="collapse" data-bs-target="#clips-collapse" aria-expanded="true" aria-controls="clips-collapse">Downloaded Clips</button>
              <small class="text-muted" id="clips-remaining"></small>
            </div>
            <div id="clips-collapse" class="collapse show">
              <div class="card-body" id="clips-grid" style="min-height: 220px;">
                <div class="text-muted">No clips yet. Download first.</div>
              </div>
            </div>
          </div>
        </div>

        <!-- Collapsible Intro & Outro together -->
        <div class="row g-3">
          <div class="col-12">
            <div class="card h-100">
              <div class="card-header d-flex justify-content-between align-items-center">
                <button class="btn btn-sm btn-outline-secondary" data-bs-toggle="collapse" data-bs-target="#inout-collapse" aria-expanded="false" aria-controls="inout-collapse">Intro &amp; Outro (optional)</button>
              </div>
              <div id="inout-collapse" class="collapse">
                <div class="card-body">
                  <div class="row g-3">
                    <div class="col-md-6">
                      <div class="fw-semibold mb-2">Intro</div>
                      <div id="intro-list" class="d-flex flex-wrap gap-2">
                        <div class="text-muted">No intros found. Upload one under Upload Media.</div>
                      </div>
                    </div>
                    <div class="col-md-6">
                      <div class="fw-semibold mb-2">Outro</div>
                      <div id="outro-list" class="d-flex flex-wrap gap-2">
                        <div class="text-muted">No outros found. Upload one under Upload Media.</div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="col-12">
            <div class="card mb-2">
              <div class="card-header d-flex justify-content-between align-items-center">
                <button class="btn btn-sm btn-outline-secondary" data-bs-toggle="collapse" data-bs-target="#transitions-collapse" aria-expanded="false" aria-controls="transitions-collapse">Transitions (optional)</button>
                <div class="d-flex align-items-center gap-2">
                  <div class="form-check form-switch m-0">
                    <input class="form-check-input" type="checkbox" id="transitions-randomize">
                    <label class="form-check-label" for="transitions-randomize">Randomize</label>
                  </div>
                  <button class="btn btn-sm btn-outline-primary" id="select-all-transitions">Select All</button>
                  <button class="btn btn-sm btn-outline-danger" id="clear-all-transitions">Clear All</button>
                </div>
              </div>
              <div id="transitions-collapse" class="collapse">
                <div class="card-body">
                  <div id="transition-list" class="d-flex flex-wrap gap-2">
                    <div class="text-muted">No transitions found. Upload under Upload Media.</div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="form-check mt-3">
          <input class="form-check-input" type="checkbox" id="arranged-confirm">
          <label class="form-check-label" for="arranged-confirm">I have arranged my timeline</label>
        </div>
        <div class="d-flex justify-content-between wizard-nav mt-4">
          <button class="btn btn-outline-secondary" data-prev="2">Back: Get Clips</button>
          <button class="btn btn-primary btn-glow btn-shadow-dark" id="next-3" disabled>Next: Compile</button>
        </div>
      </div>

      <!-- Step 4: Compile -->
      <div class="wizard-step d-none" data-step="4">
        <!-- Auto-start compile option removed -->
        <div class="mt-3">
          <button class="btn btn-primary btn-shadow-dark" id="start-compile"><i class="bi bi-play-circle"></i> Start Compile</button>
          <button class="btn btn-outline-danger" id="cancel-compile" disabled>Cancel</button>
        </div>
  <!-- Render summary/details -->
  <div id="compile-details" class="mt-3"></div>
  <div class="progress mt-3 compile-progress" role="progressbar" aria-label="Compile" aria-valuemin="0" aria-valuemax="100" style="height: 25px"><div class="progress-bar" id="compile-progress" style="width: 0%">0%</div></div>
        <div class="mt-3"><pre class="bg-dark p-3 rounded" id="compile-log" style="min-height: 140px; max-height: 240px; overflow:auto;">Ready to roll.</pre></div>
  <div class="d-flex justify-content-between wizard-nav mt-4"><button class="btn btn-outline-secondary" data-prev="3">Back: Arrange</button><button class="btn btn-primary btn-glow btn-shadow-dark" id="next-4" disabled>Next: Export</button></div>
      </div>

      <!-- Step 5: Export -->
      <div class="wizard-step d-none" data-step="5">
        <!-- Export ingest banner (shown while importing final render) -->
        <div id="export-ingest-banner" class="alert alert-info d-none d-flex align-items-center gap-2 mb-3" role="status" aria-live="polite">
          <div class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></div>
          <div id="export-ingest-text">Importing final renderâ€¦</div>
        </div>
                <!-- Success banner with celebration -->
        <div class="alert alert-success d-none border-0 shadow-sm mb-4" id="export-ready">
          <div class="d-flex align-items-center gap-3">
            <div style="font-size: 3rem; line-height: 1;">ðŸŽ‰</div>
            <div>
              <h4 class="alert-heading mb-1">Your Compilation is Ready!</h4>
              <p class="mb-0">Watch it below, download it, or share it with the world.</p>
            </div>
          </div>
        </div>

        <!-- Export layout: video preview + details + actions -->
        <div class="export-pane mt-2">
          <div class="export-left">
            <div class="position-relative">
              <video id="export-video" class="export-video" controls poster="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='800' height='600'%3E%3Crect width='800' height='600' fill='%23000'/%3E%3Ctext x='400' y='300' font-family='Arial' font-size='24' fill='%23666' text-anchor='middle'%3ELoading video...%3C/text%3E%3C/svg%3E"></video>
            </div>
          </div>
          <div class="export-right d-flex flex-column">
            <div class="flex-grow-1">
              <h5 class="mb-3 d-flex align-items-center gap-2">
                <i class="bi bi-info-circle"></i>
                Compilation Details
              </h5>
              <ul class="list-unstyled export-details" id="export-details">
                <li class="text-muted"><i class="bi bi-hourglass-split"></i> Loading project information...</li>
              </ul>
            </div>
            <div class="mt-auto pt-3 border-top">
              <h6 class="mb-2 text-muted">Actions</h6>
              <div class="d-flex flex-wrap gap-2">
                <a class="btn btn-success btn-lg disabled" aria-disabled="true" id="download-output">
                  <i class="bi bi-download"></i> Download Video
                </a>
                <button class="btn btn-outline-danger disabled" id="upload-youtube" aria-disabled="true" title="Coming soon">
                  <i class="bi bi-youtube"></i> Upload to YouTube
                </button>
                <button class="btn btn-outline-primary disabled" id="upload-discord" aria-disabled="true" title="Coming soon">
                  <i class="bi bi-discord"></i> Upload to Discord
                </button>
              </div>
            </div>
          </div>
        </div>
          <div class="d-flex justify-content-between mt-3">
          <button class="btn btn-outline-secondary" data-prev="4">Back: Compile</button>
          <a class="btn btn-primary btn-shadow-dark" href="{{ url_for('main.projects') }}">Finish</a>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script src="{{ url_for('static', filename='js/wizard.js') }}"></script>
{% endblock %}

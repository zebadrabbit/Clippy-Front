{% extends "base.html" %}

{% block styles %}
{{ super() }}
<link rel="stylesheet" href="{{ url_for('static', filename='css/wizard.css') }}">
<style>
  /* Larger checkbox for timeline confirmation */
  #arranged-confirm {
    width: 1.5em;
    height: 1.5em;
    cursor: pointer;
  }
  #arranged-confirm + label {
    cursor: pointer;
    font-size: 1.1rem;
    font-weight: 500;
    margin-left: 0.5rem;
  }
  .timeline-confirm-box {
    background: var(--bs-secondary-bg);
    border: none;
    border-radius: 2rem;
    padding: 1.25rem 2rem;
    text-align: center;
    transition: all 0.2s ease;
    display: inline-block;
    max-width: fit-content;
    margin: 0 auto;
  }
  .timeline-confirm-box:hover {
    background: var(--bs-secondary);
    color: white;
  }
  .timeline-confirm-box:hover #arranged-confirm + label {
    color: white;
  }
  .timeline-confirm-box .form-check {
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0;
  }
  .timeline-confirm-box .form-check-label {
    font-size: 1.3rem;
    font-weight: 600;
    margin-bottom: 0;
  }
</style>
{% endblock %}

{% block content %}
<!-- Celebration canvas overlay (hidden by default) -->
<canvas id="celebration-canvas" style="position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; pointer-events: none; z-index: 9999; display: none;"></canvas>

<div class="container py-4">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h2 class="mb-0 d-flex align-items-center">
      <i class="bi bi-magic"></i>
      {% if existing_project %}
        Edit Project: {{ existing_project.name }}
      {% else %}
        New Project Wizard
      {% endif %}
      <button type="button" class="btn btn-sm btn-link text-muted p-0 ms-2"
              data-bs-toggle="popover"
              data-bs-placement="bottom"
              data-bs-title="Quick Start: Creating Projects"
              data-bs-html="true"
              data-bs-content='<p class="mb-2">The wizard guides you through 4 simple steps:</p>
                               <ol class="small mb-2">
                                 <li><strong>Setup:</strong> Choose source and configure settings</li>
                                 <li><strong>Get Clips:</strong> Fetch videos from Twitch/Discord</li>
                                 <li><strong>Arrange:</strong> Build your timeline</li>
                                 <li><strong>Compile:</strong> Render the final video</li>
                               </ol>
                               <div class="mt-2 pt-2 border-top">
                                 <a href="{{ url_for("help.topic", topic="creating-projects") }}" class="btn btn-sm btn-outline-primary w-100">
                                   <i class="bi bi-book me-1"></i> Full Guide
                                 </a>
                               </div>'>
        <i class="bi bi-question-circle-fill"></i>
      </button>
    </h2>
  <a class="btn btn-outline-secondary" href="{% if existing_project %}{{ url_for('main.project_details_by_public', public_id=existing_project.public_id) }}{% else %}{{ url_for('main.projects') }}{% endif %}">
    {% if existing_project %}Back to Project{% else %}Back to Projects{% endif %}
  </a>
  </div>

  <div class="card">
    <div class="card-header card-header--primary mb-3">Project Wizard</div>
    <div class="card-body">
      <!-- Wizard chevron progress: 1) Setup 2) Get Clips 3) Arrange 4) Compile -->
      <div class="chevron-steps mb-3">
        <ul class="progress" id="wizard-chevrons">
          <li data-step="1" class="active"><a href="#">Setup</a></li>
          <li data-step="2"><a href="#">Get Clips</a></li>
          <li data-step="3"><a href="#">Arrange</a></li>
          <li data-step="4"><a href="#">Compile</a></li>
        </ul>
      </div>
  <div id="wizard-data" data-user-has-twitch="{{ '1' if current_user.is_authenticated and current_user.twitch_username else '0' }}" data-date-format="{{ current_user.date_format if current_user.is_authenticated else 'auto' }}" class="d-none"></div>
      <!-- Step 1: Setup -->
      <div class="wizard-step" data-step="1">
        <form id="setup-form" class="row g-3">
          <div class="col-md-4">
            <label class="form-label d-flex align-items-center">
              Route
              <i class="bi bi-question-circle text-muted ms-1 help-icon"
                 data-bs-toggle="tooltip"
                 data-bs-placement="top"
                 data-bs-html="true"
                 title="<strong>Twitch:</strong> Fetch clips from your Twitch channel<br><strong>Discord:</strong> Download videos from Discord messages"></i>
            </label>
            <select class="form-select" name="route" id="route-select">
              <option value="twitch" selected>Twitch</option>
              <option value="discord">Discord</option>
            </select>
          </div>

          <!-- Hidden Discord channel ID from profile -->
          <input type="hidden" id="discord-channel-id" name="discord_channel_id" value="{{ discord_channel_id or '' }}">

          <div class="row g-2">
          <div class="col-12">
            <div class="alert alert-warning d-none" id="twitch-warning">
              <strong>Twitch not connected.</strong> Add your Twitch username to unlock fetching clips.
              <a href="{{ url_for('main.profile') }}" class="alert-link">Open your profile</a>.
            </div>
          </div>
          <div class="col-12">
            <div class="row g-3 align-items-stretch">
              <div class="col-md-6">
                <label class="form-label">Project Name</label>
                <input class="form-control" name="name" placeholder="My Compilation">
                <label class="form-label mt-3">Tags <span class="text-muted">(comma-separated, optional)</span></label>
                <input class="form-control" name="tags" placeholder="gaming, highlights, funny">
                <label class="form-label mt-3">Description (optional)</label>
                <textarea class="form-control" name="description" rows="3" placeholder="Short description..."></textarea>
              </div>
              <div class="col-md-5 offset-md-1">
                <div class="card audio-norm-card">
                  <div class="card-header card-header--accent d-flex align-items-center justify-content-between">
                    <div class="d-flex align-items-center gap-2 audio-norm-head">
                      <input class="form-check-input" type="checkbox" id="audio-norm-enabled">
                      <label class="form-label mb-0" for="audio-norm-enabled">Audio Normalization</label>
                      <i class="bi bi-question-circle text-light ms-1 help-icon"
                         data-bs-toggle="tooltip"
                         data-bs-placement="top"
                         data-bs-html="true"
                         title="Ensures consistent volume across all clips. Recommended for compilations with clips from different sources."></i>
                    </div>
                    <span class="small" style="opacity: .85;">optional</span>
                  </div>
                  <div class="card-body">
                    <div class="opt-slider" id="audio-norm-slider" data-count="4">
                      <input type="radio" name="audio_norm_profile" id="an-music" value="music" data-db="-1">
                      <label for="an-music" data-label="Music (-1 dB)"></label>
                      <input type="radio" name="audio_norm_profile" id="an-podcast" value="podcast" data-db="-3">
                      <label for="an-podcast" data-label="Podcasts (-3 dB)"></label>
                      <input type="radio" name="audio_norm_profile" id="an-broadcast" value="broadcast" data-db="-2">
                      <label for="an-broadcast" data-label="Broadcast (-2 dB)"></label>
                      <input type="radio" name="audio_norm_profile" id="an-gaming" value="gaming" data-db="-4" checked>
                      <label for="an-gaming" data-label="Gaming (-4 dB)"></label>
                      <div class="pos" aria-hidden="true"></div>
                    </div>
                    <input type="hidden" name="audio_norm_db" id="audio_norm_db" value="-4">
                  </div>
                </div>
              </div>
            </div>
          </div>
          </div>
          <div class="row g-2 mb-3">
          <div class="col-md-6">
            <label class="form-label">Platform Preset</label>
            <select class="form-select" id="platformPreset" name="platform_preset">
              <option value="youtube" selected>YouTube (1080p 16:9)</option>
              <option value="youtube_shorts">YouTube Shorts (1080p 9:16 vertical)</option>
              <option value="tiktok">TikTok (1080p 9:16 vertical)</option>
              <option value="instagram_feed">Instagram Feed (1080p 1:1 square)</option>
              <option value="instagram_reel">Instagram Reels (1080p 9:16 vertical)</option>
              <option value="instagram_story">Instagram Stories (1080p 9:16 vertical)</option>
              <option value="twitter">Twitter/X (1080p 16:9)</option>
              <option value="facebook">Facebook (1080p 16:9)</option>
              <option value="twitch">Twitch Clips (1080p 16:9)</option>
            </select>
            <small class="text-muted">Automatically configure export settings for specific platforms</small>
          </div>
          </div>

          <!-- Vertical Video Controls (9:16 presets only) -->
          <div class="row g-2 mb-3 d-none" id="verticalVideoControls">
            <div class="col-md-12">
              <div class="alert alert-info mb-3">
                <i class="bi bi-info-circle"></i> <strong>Vertical Video Mode:</strong> Converting 16:9 clips to 9:16 format
              </div>
            </div>
            <div class="col-md-6">
              <label class="form-label">Zoom Level</label>
              <div class="d-flex align-items-center gap-2">
                <input type="range" class="form-range" id="verticalZoom" name="vertical_zoom" min="100" max="120" value="100" step="1">
                <span id="verticalZoomDisplay" class="text-muted small" style="min-width: 3.5rem;">100%</span>
              </div>
              <small class="text-muted">Zoom into 16:9 clips to fill vertical frame (100% = fit width, 120% = max zoom)</small>
            </div>
            <div class="col-md-6">
              <label class="form-label">Horizontal Alignment</label>
              <select class="form-select" id="verticalAlign" name="vertical_align">
                <option value="center" selected>Center</option>
                <option value="left">Left</option>
                <option value="right">Right</option>
              </select>
              <small class="text-muted">Horizontal position when zoomed in</small>
            </div>
          </div>

          <div class="row g-2 d-none">
          <div class="col-4">
            <label class="form-label">Output</label>
            <div class="row g-2">
              <div class="col-md-4">
                <select class="form-select" name="orientation" id="orientation">
                  <option value="landscape" selected>Landscape</option>
                  <option value="portrait">Portrait</option>
                  <option value="square">Square</option>
                </select>
              </div>
              <div class="col-md-3">
                <select class="form-select" name="resolution" id="resolution">
                  <option value="720p">720p</option>
                  <option value="1080p" selected>1080p</option>
                  <option value="1440p">1440p</option>
                </select>
              </div>
              <div class="col-md-2">
                <select class="form-select" name="format" id="format">
                  <option value="mp4" selected>MP4</option>
                  <option value="webm">WebM</option>
                </select>
              </div>
              <div class="col-md-3">
                <select class="form-select" name="fps" id="fps">
                  <option value="30">30 fps</option>
                  <option value="60" selected>60 fps</option>
                  <option value="120">120 fps</option>
                </select>
              </div>
            </div>
          </div>
          </div>

          <div class="row g-2">
          <div class="col-8">
            <label class="form-label">Search Parameters</label>
            <div class="row g-2">
              <div class="col-md-3">
                <label class="form-label">Compilation Length</label>
                <select class="form-select" name="compilation_length" id="compilation-length">
                  <option value="auto" selected>Auto (all clips)</option>
                  <option value="60">1 minute</option>
                  <option value="120">2 minutes</option>
                  <option value="180">3 minutes</option>
                  <option value="300">5 minutes</option>
                  <option value="600">10 minutes</option>
                  <option value="900">15 minutes</option>
                  <option value="1200">20 minutes</option>
                </select>
                <small class="text-muted">Fetches enough clips to reach target length</small>
              </div>
              <div class="col-md-2">
                <label class="form-label">Max Clips</label>
                <input type="number" min="1" max="500" step="1" class="form-control" name="max_clips" value="5">
              </div>
              <!-- Discord-specific parameters (hidden by default) -->
              <div class="col-md-3 d-none" id="discord-min-reactions">
                <label class="form-label"><i class="bi bi-discord"></i> Minimum Reactions</label>
                <input type="number" class="form-control" id="min-reactions" name="min_reactions" value="0" min="0" max="100">
                <small class="text-muted">Messages with at least this many reactions</small>
              </div>
              <div class="col-md-4 d-none" id="discord-emoji">
                <label class="form-label"><i class="bi bi-discord"></i> Reaction Emoji (optional)</label>
                <select class="form-select" id="reaction-emoji" name="reaction_emoji">
                  <option value="">Any reaction</option>
                  <option value="üëç">üëç Thumbs Up</option>
                  <option value="‚ù§Ô∏è">‚ù§Ô∏è Heart</option>
                  <option value="üòÇ">üòÇ Laughing</option>
                  <option value="üòÆ">üòÆ Surprised</option>
                  <option value="üò¢">üò¢ Sad</option>
                  <option value="üò°">üò° Angry</option>
                  <option value="üéâ">üéâ Party</option>
                  <option value="üî•">üî• Fire</option>
                  <option value="‚≠ê">‚≠ê Star</option>
                  <option value="‚úÖ">‚úÖ Check</option>
                </select>
                <small class="text-muted">Filter by specific emoji</small>
              </div>
            </div>
            <!-- Discord setup alert (shown when Discord is selected and channel ID is missing) -->
            <div class="alert alert-info mt-3 mb-0 d-none" id="discord-setup-alert">
              <i class="bi bi-info-circle"></i> <strong>Discord Setup Required:</strong>
              {% if not discord_channel_id %}
                Set your Discord channel ID in your <a href="{{ url_for('main.profile') }}" class="alert-link">profile settings</a> to fetch clips.
              {% else %}
                Channel ID configured in your <a href="{{ url_for('main.profile') }}" class="alert-link">profile</a>.
              {% endif %}
            </div>
          </div>
          <div class="col-4">
            <label class="form-label">Date Range (Optional)</label>
            <div class="row g-2">
              <div class="col-md-6">
                <label class="form-label">Start Date</label>
                <input type="date" class="form-control" name="start_date">
              </div>
              <div class="col-md-6">
                <label class="form-label">End Date</label>
                <input type="date" class="form-control" name="end_date">
              </div>
            </div>
          </div>
          </div>
        </form>
        <div class="d-flex justify-content-end wizard-nav mt-4">
          <div class="d-flex gap-2">
            <button class="btn btn-accent btn-glow btn-shadow-dark" id="save-as-task" type="button"><i class="bi bi-save"></i> Save as task</button>
            <button class="btn btn-primary btn-glow btn-shadow-dark" id="next-1" type="button">Next: Get Clips</button>
          </div>
        </div>
      </div>

  <!-- Step 2: Get Clips (consolidates Fetch + Parse + Download) -->
      <div class="wizard-step d-none" data-step="2">
        <div class="chevron-progress">
          <div class="chevron-label" id="gc-status">Warming up the clippers‚Ä¶</div>
          <div class="chevron-steps">
            <ul class="progress" id="gc-steps">
              <li data-key="fetch" class="active"><a href="#">Fetch</a></li>
              <li data-key="extract"><a href="#">Parse</a></li>
              <li data-key="download"><a href="#">Download</a></li>
              <li data-key="import"><a href="#">Import</a></li>
              <li data-key="done"><a href="#">Done</a></li>
            </ul>
          </div>
        </div>
        <div class="mt-4 d-flex justify-content-between wizard-nav">
          <button class="btn btn-outline-secondary" data-prev="1">Back: Setup</button>
          <div class="d-flex gap-2">
            <button class="btn btn-outline-danger d-none" id="gc-cancel">Cancel</button>
            <button class="btn btn-primary btn-glow btn-shadow-dark" id="next-2" disabled>Next: Arrange Timeline</button>
          </div>
        </div>
      </div>

      <!-- Step 3: Arrange -->
      <div class="wizard-step d-none" data-step="3">
        <!-- Ingest banner (shown while auto-importing rsynced clips) -->
        <div id="arrange-ingest-banner" class="alert alert-info d-none d-flex align-items-center gap-2 mb-3" role="status" aria-live="polite">
          <div class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></div>
          <div id="arrange-ingest-text">Importing rsynced raw clips‚Ä¶</div>
        </div>

        <!-- Keyboard Shortcuts Help -->
        <div class="alert alert-light border d-flex justify-content-between align-items-center mb-3 d-none">
          <div>
            <strong><i class="bi bi-keyboard"></i> Keyboard Shortcuts:</strong>
            <span class="ms-2 small text-muted">
              <kbd>‚Üë</kbd>/<kbd>‚Üì</kbd> Navigate clips ‚Ä¢
              <kbd>Delete</kbd> Remove ‚Ä¢
              <kbd>Ctrl+S</kbd> Save ‚Ä¢
              <kbd>Ctrl+Z</kbd>/<kbd>Ctrl+Y</kbd> Undo/Redo
            </span>
          </div>
        </div>

        <!-- Timeline at top (always visible) -->
        <div class="mb-3">
          <div class="card">
            <div class="card-header">Timeline</div>
            <div class="card-body" id="timeline">
              <div class="timeline-drop-indicator" id="timeline-drop-top"></div>
              <div class="timeline-list" id="timeline-list"></div>
              <div class="timeline-drop-indicator" id="timeline-drop-bottom"></div>
            </div>
            <div class="card-footer bg-dark border-top d-flex justify-content-between align-items-center">
              <div id="timeline-info"></div>
              <div class="text-muted small">
                <i class="bi bi-keyboard"></i>
                <kbd>‚Üë</kbd>/<kbd>‚Üì</kbd> Navigate ‚Ä¢
                <kbd>Delete</kbd> Remove ‚Ä¢
                <kbd>Ctrl+S</kbd> Save ‚Ä¢
                <kbd>Ctrl+Z</kbd>/<kbd>Ctrl+Y</kbd> Undo/Redo
              </div>
            </div>
          </div>
        </div>

        <!-- Two-column layout: sidebar navigation + content -->
        <div class="arrange-layout">
          <!-- Left sidebar navigation -->
          <div class="arrange-sidebar">
            <div class="list-group list-group-flush">
              <a href="#" class="list-group-item list-group-item-action active" data-arrange-tab="clips">
                <i class="bi bi-film"></i> Clips
                <span class="badge bg-secondary ms-auto" id="clips-count-badge">0</span>
              </a>
              <a href="#" class="list-group-item list-group-item-action" data-arrange-tab="intros">
                <i class="bi bi-play-circle"></i> Intros
              </a>
              <a href="#" class="list-group-item list-group-item-action" data-arrange-tab="outros">
                <i class="bi bi-stop-circle"></i> Outros
              </a>
              <a href="#" class="list-group-item list-group-item-action" data-arrange-tab="transitions">
                <i class="bi bi-arrows-angle-contract"></i> Transitions
              </a>
              <a href="#" class="list-group-item list-group-item-action" data-arrange-tab="music">
                <i class="bi bi-music-note-beamed"></i> Music
              </a>
            </div>
          </div>

          <!-- Right content area -->
          <div class="arrange-content">
            <!-- Clips tab -->
            <div class="arrange-tab-content active" data-tab="clips">
              <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="mb-0">Downloaded Clips</h5>
                <div class="d-flex align-items-center gap-2">
                  <small class="text-muted" id="clips-remaining"></small>
                  <button class="btn btn-sm btn-primary" id="add-all-clips" title="Add all clips to timeline">
                    <i class="bi bi-plus-circle"></i> Add All to Timeline
                  </button>
                </div>
              </div>
              <div id="clips-grid" style="min-height: 220px;">
                <div class="text-muted">No clips yet. Download first.</div>
              </div>
            </div>

            <!-- Intros tab -->
            <div class="arrange-tab-content" data-tab="intros">
              <h5 class="mb-3">Intro Videos</h5>
              <div id="intro-list" class="media-grid">
                <div class="text-muted">No intros found. Upload one under Upload Media.</div>
              </div>
            </div>

            <!-- Outros tab -->
            <div class="arrange-tab-content" data-tab="outros">
              <h5 class="mb-3">Outro Videos</h5>
              <div id="outro-list" class="media-grid">
                <div class="text-muted">No outros found. Upload one under Upload Media.</div>
              </div>
            </div>

            <!-- Transitions tab -->
            <div class="arrange-tab-content" data-tab="transitions">
              <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="mb-0">Transition Effects</h5>
                <div class="d-flex align-items-center gap-2">
                  <div class="form-check form-switch m-0">
                    <input class="form-check-input" type="checkbox" id="transitions-randomize">
                    <label class="form-check-label" for="transitions-randomize">Randomize</label>
                  </div>
                  <button class="btn btn-sm btn-outline-primary" id="select-all-transitions">Select All</button>
                  <button class="btn btn-sm btn-outline-danger" id="clear-all-transitions">Clear All</button>
                </div>
              </div>
              <div id="transition-list" class="media-grid">
                <div class="text-muted">No transitions found. Upload under Upload Media.</div>
              </div>
            </div>

            <!-- Music tab -->
            <div class="arrange-tab-content" data-tab="music">
              <h5 class="mb-3">Background Music</h5>
              <div class="mb-4">
                <div class="fw-semibold mb-2">Select Music Track</div>
                <div id="music-list" class="media-grid">
                  <div class="text-muted">No music tracks found. Upload under Upload Media.</div>
                </div>
              </div>
              <div class="card bg-dark">
                <div class="card-header">Music Settings</div>
                <div class="card-body">
                  <div class="row g-3">
                    <div class="col-md-4">
                      <label for="music-volume" class="form-label">Volume</label>
                      <div class="d-flex align-items-center gap-2">
                        <input type="range" class="form-range" id="music-volume" min="0" max="100" value="30" step="1">
                        <span id="music-volume-display" class="text-muted small" style="min-width: 3rem;">30%</span>
                      </div>
                    </div>
                    <div class="col-md-4">
                      <label for="music-start-mode" class="form-label">Start Music</label>
                      <select class="form-select" id="music-start-mode">
                        <option value="start">From beginning</option>
                        <option value="after_intro" selected>After intro</option>
                      </select>
                    </div>
                    <div class="col-md-4">
                      <label for="music-end-mode" class="form-label">End Music</label>
                      <select class="form-select" id="music-end-mode">
                        <option value="before_outro" selected>Before outro</option>
                        <option value="end">At the end</option>
                      </select>
                    </div>
                  </div>

                  <!-- Advanced Ducking Settings (Collapsible) -->
                  <div class="mt-3">
                    <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#ducking-settings" aria-expanded="false" aria-controls="ducking-settings">
                      <i class="bi bi-sliders"></i> Advanced: Audio Ducking
                    </button>
                    <div class="collapse mt-3" id="ducking-settings">
                      <div class="card card-body bg-dark border-secondary">
                        <p class="small text-muted mb-3">
                          <i class="bi bi-info-circle"></i> Audio ducking automatically lowers background music volume when clip audio is present. Adjust these parameters to fine-tune the effect.
                        </p>
                        <div class="row g-3">
                          <div class="col-md-6">
                            <label for="duck-threshold" class="form-label">
                              Threshold
                              <span class="text-muted small">(when to start ducking)</span>
                            </label>
                            <div class="d-flex align-items-center gap-2">
                              <input type="range" class="form-range" id="duck-threshold" min="0" max="100" value="2" step="1">
                              <span id="duck-threshold-display" class="text-muted small" style="min-width: 4rem;">0.02</span>
                            </div>
                            <small class="text-muted">Lower = more sensitive (ducks with quieter audio)</small>
                          </div>
                          <div class="col-md-6">
                            <label for="duck-ratio" class="form-label">
                              Ratio
                              <span class="text-muted small">(how much to reduce)</span>
                            </label>
                            <div class="d-flex align-items-center gap-2">
                              <input type="range" class="form-range" id="duck-ratio" min="1" max="20" value="20" step="1">
                              <span id="duck-ratio-display" class="text-muted small" style="min-width: 4rem;">20:1</span>
                            </div>
                            <small class="text-muted">Higher = more aggressive reduction</small>
                          </div>
                          <div class="col-md-6">
                            <label for="duck-attack" class="form-label">
                              Attack
                              <span class="text-muted small">(how fast to duck)</span>
                            </label>
                            <div class="d-flex align-items-center gap-2">
                              <input type="range" class="form-range" id="duck-attack" min="1" max="100" value="10" step="1">
                              <span id="duck-attack-display" class="text-muted small" style="min-width: 4rem;">1.0ms</span>
                            </div>
                            <small class="text-muted">Lower = faster response (instant ducking)</small>
                          </div>
                          <div class="col-md-6">
                            <label for="duck-release" class="form-label">
                              Release
                              <span class="text-muted small">(how fast to recover)</span>
                            </label>
                            <div class="d-flex align-items-center gap-2">
                              <input type="range" class="form-range" id="duck-release" min="10" max="1000" value="250" step="10">
                              <span id="duck-release-display" class="text-muted small" style="min-width: 4rem;">250ms</span>
                            </div>
                            <small class="text-muted">Higher = smoother fade-back</small>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="text-center mt-3">
          <div class="timeline-confirm-box">
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="arranged-confirm">
              <label class="form-check-label" for="arranged-confirm">I have arranged my timeline</label>
            </div>
          </div>
        </div>
        <div class="d-flex justify-content-between wizard-nav mt-4">
          <button class="btn btn-outline-secondary" data-prev="2">Back: Get Clips</button>
          <button class="btn btn-primary btn-glow btn-shadow-dark" id="next-3" disabled>Next: Compile</button>
        </div>
      </div>

      <!-- Step 4: Compile -->
      <div class="wizard-step d-none" data-step="4">
        <!-- Keyboard Shortcuts Help -->
        <div class="alert alert-light border d-flex justify-content-between align-items-center mb-3">
          <div>
            <strong><i class="bi bi-keyboard"></i> Keyboard Shortcuts:</strong>
            <span class="ms-2 small text-muted">
              <kbd>Ctrl+Enter</kbd> Start compilation
            </span>
          </div>
        </div>

        <!-- Render summary/details -->
        <div id="compile-details" class="mb-3"></div>

        <!-- Compilation Controls -->
        <div class="d-flex gap-2 align-items-center mb-3">
          <button class="btn btn-primary btn-shadow-dark" id="start-compile">
            <i class="bi bi-play-circle"></i> Start Compilation
          </button>
          <button class="btn btn-outline-danger" id="cancel-compile" disabled>
            <i class="bi bi-x-circle"></i> Cancel
          </button>
        </div>

        <!-- Progress Bar -->
        <div class="mb-3">
          <p id="compile-progress-label" data-value="0">Ready.</p>
          <progress id="compile-progress-bar" max="100" value="0" class="compile">
            <div class="progress-bar">
              <span style="width: 0%">0%</span>
            </div>
          </progress>
        </div>

        <!-- Compile Log -->
        <div class="card">
          <div class="card-header">
            <strong><i class="bi bi-terminal"></i> Compilation Log</strong>
          </div>
          <div class="card-body p-0">
            <pre class="bg-dark text-light p-3 m-0 rounded-bottom" id="compile-log" style="min-height: 140px; max-height: 280px; overflow: auto; font-size: 0.85rem;">Ready to compile your video.</pre>
          </div>
        </div>

        <!-- Navigation -->
        <div class="d-flex justify-content-between wizard-nav mt-4">
          <button class="btn btn-outline-secondary" data-prev="3">
            <i class="bi bi-arrow-left"></i> Back: Arrange
          </button>
          <button class="btn btn-success btn-glow btn-shadow-dark" id="next-4" disabled>
            <i class="bi bi-check-circle"></i> View Project
          </button>
        </div>

        <!-- Preview Section (hidden by default) -->
        <div class="mt-3 d-none" id="compilation-preview">
          <img class="compilation-preview-img img-fluid rounded border"
               alt="Compilation Preview"
               style="max-width: 100%; max-height: 300px; display: none; width: 100%;">
          <video class="compilation-preview-video img-fluid rounded border"
                 style="max-width: 100%; max-height: 300px; display: none; width: 100%;"
                 controls muted loop playsinline></video>
          <div class="preview-placeholder bg-dark border rounded d-flex align-items-center justify-content-center text-muted" style="height: 160px;">
            <div class="text-center">
              <div class="spinner-border spinner-border-sm mb-2" role="status">
                <span class="visually-hidden">Loading...</span>
              </div>
              <div class="small">Loading preview...</div>
            </div>
          </div>
        </div>
      </div>


    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
  // Initialize wizard with existing project if provided
  {% if existing_project %}
  window.wizardExistingProject = {
    id: {{ existing_project.id }},
    name: {{ existing_project.name|tojson }},
    description: {{ existing_project.description|tojson if existing_project.description else 'null' }},
    initialStep: {{ initial_step }}
  };
  {% endif %}
</script>
<script src="{{ url_for('static', filename='js/wizard.js') }}"></script>
{% endblock %}

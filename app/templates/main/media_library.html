{% extends "base.html" %}

{% block content %}
<div class="container py-4">
  <div id="media-config"
       data-upload-url="{{ url_for('main.media_upload') }}"
       data-bulk-url="{{ url_for('main.media_bulk') }}"
       data-delete-url-template="{{ url_for('main.media_delete', media_id=0) }}"
       data-update-url-template="{{ url_for('main.media_update', media_id=0) }}"
       data-preview-url-template="{{ url_for('main.media_preview', media_id=0) }}"
       data-thumbnail-url-template="{{ url_for('main.media_thumbnail', media_id=0) }}"
       class="d-none"></div>
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h2 class="mb-0"><i class="bi bi-collection-play"></i> Media Library</h2>
  </div>

  <!-- Upload Zone (Dropzone) -->
  <div class="card mb-4">
    <div class="card-header card-header--primary">
      <strong>Upload Media</strong>
    </div>
    <div class="card-body">
      <div class="row g-3 align-items-center">
        <div class="col-lg-3">
          <div class="mb-2"><span class="h4 mb-0 d-block">Media Type</span></div>
          <select id="dz-media-type" class="form-select">
            <option value="auto">Auto-detect</option>
            {% for t in media_types %}
              {% if t.name in ('INTRO','OUTRO','TRANSITION','MUSIC') %}
                <option value="{{ t.value }}" {% if t.value == 'transition' %}selected{% endif %}>{{ t.name.title() }}</option>
              {% endif %}
            {% endfor %}
          </select>
          <div class="form-text">Auto-detect or manually choose type. Videos default to Transition.</div>
        </div>
        <div class="col-lg-9">
          <form action="{{ url_for('main.media_upload') }}" class="dropzone dropzone-accent" id="media-dropzone">
            <div class="dz-message">Drop files here or click to upload</div>
            <div class="dz-previews mt-3"></div>
          </form>
          <small class="text-muted">Images and videos are supported.</small>
        </div>
      </div>
    </div>
  </div>

  <!-- Bulk actions toolbar -->
  <div id="bulk-toolbar" class="alert alert-secondary py-2 d-none">
    <div class="d-flex align-items-center gap-2 flex-wrap">
      <div><strong id="bulk-count">0</strong> selected</div>
      <button id="bulk-select-all" type="button" class="btn btn-sm btn-outline-secondary">Select all</button>
      <button id="bulk-clear" type="button" class="btn btn-sm btn-outline-secondary">Clear</button>
      <div class="vr"></div>
      <select id="bulk-type" class="form-select form-select-sm" style="width:auto">
        <option value="">Change typeâ€¦</option>
        {% for t in media_types %}
          <option value="{{ t.value }}">{{ t.name.title() }}</option>
        {% endfor %}
      </select>
      <button id="bulk-apply-type" type="button" class="btn btn-sm btn-primary">Apply</button>
      <div class="vr"></div>
      <input id="bulk-tags" class="form-control form-control-sm" placeholder="Set tags (comma-separated)" style="width: 260px;" />
      <button id="bulk-apply-tags" type="button" class="btn btn-sm btn-primary">Set tags</button>
      <button id="bulk-delete" type="button" class="btn btn-sm btn-danger">Delete</button>
    </div>
  </div>

  <form class="mb-3" method="GET" action="{{ url_for('main.media_library') }}">
    <div class="row g-2 align-items-end">
      <div class="col-auto">
        <label class="form-label">Type</label>
        <select class="form-select" name="type">
          <option value="">All</option>
          {% for t in media_types %}
            {% if t.name in ('INTRO','OUTRO','TRANSITION','MUSIC') %}
              <option value="{{ t.value }}" {% if type_filter==t.value %}selected{% endif %}>{{ t.name.title() }}</option>
            {% endif %}
          {% endfor %}
        </select>
      </div>
      <div class="col-auto">
        <label class="form-label">Tags</label>
        <input type="text" class="form-control" id="tagFilterInput" placeholder="Filter by tags..." style="min-width: 200px;">
        <input type="hidden" name="tags" id="tagFilterHidden" value="">
      </div>
      <div class="col-auto">
        <label class="form-label">Search</label>
        <input type="text" class="form-control" name="q" placeholder="Search files..." value="{{ request.args.get('q', '') }}">
      </div>
      <div class="col-auto">
        <button class="btn btn-primary" type="submit">Filter</button>
      </div>
      <div class="col-auto">
        <a href="{{ url_for('main.media_library') }}" class="btn btn-outline-secondary">Clear</a>
      </div>
    </div>
    <div id="selectedTags" class="mt-2"></div>
  </form>

  {% if media_files %}
  <div id="media-grid" class="row row-cols-1 row-cols-sm-2 row-cols-md-3 row-cols-lg-5 g-3">
    {% for m in media_files %}
    <div class="col">
      <div class="card h-100 position-relative media-card" data-id="{{ m.id }}" data-mime="{{ m.mime_type }}" data-type="{{ m.media_type.value if m.media_type else '' }}" data-name="{{ m.original_filename }}" data-tags="{{ m.tags or '' }}">
        <div class="position-absolute top-0 start-0 p-2">
          <input class="form-check-input media-select" type="checkbox" value="{{ m.id }}">
        </div>
        {% if m.mime_type.startswith('image') %}
          <img src="{{ url_for('main.media_preview', media_id=m.id) }}" class="card-img-top media-thumb" alt="{{ m.original_filename }}">
        {% elif m.mime_type.startswith('video') %}
          <button type="button" class="btn p-0 border-0 text-start w-100 video-open position-relative" data-id="{{ m.id }}" style="background: var(--bs-card-bg);">
            <img src="{{ url_for('main.media_thumbnail', media_id=m.id) }}" class="img-fluid media-thumb" alt="{{ m.original_filename }}">
            <i class="bi bi-play-circle-fill position-absolute top-50 start-50 translate-middle" style="font-size:2.5rem; opacity:0.85;"></i>
          </button>
        {% elif m.mime_type.startswith('audio') %}
          <div class="card-img-top d-flex align-items-center justify-content-center media-thumb" style="height:140px; background: var(--bs-card-bg);">
            <i class="bi bi-music-note-beamed" style="font-size:3rem;"></i>
          </div>
        {% else %}
          <div class="card-img-top d-flex align-items-center justify-content-center media-thumb" style="height:140px; background: var(--bs-card-bg);">
            <i class="bi bi-file-earmark-text" style="font-size:2rem;"></i>
          </div>
        {% endif %}
        <div class="card-body">
          <div class="fw-semibold text-truncate" title="{{ m.original_filename }}">{{ m.original_filename }}</div>
          {% set type_val = m.media_type.value if m.media_type else '' %}
          {% set type_name = (m.media_type.name.title() if m.media_type and m.media_type.name else type_val) %}
          {% set src_url = (m.clips|selectattr('source_url')|map(attribute='source_url')|first) %}
          <ul class="list-unstyled small mb-0 mt-2">
            {% if type_val %}
            <li>
              <span class="badge text-bg-{{ type_val }}" data-role="type-badge">{{ type_name }}</span>
            </li>
            {% endif %}
            <li><span class="text-muted" data-role="size">{{ '%.1f'|format(m.file_size_mb) }} MB</span></li>
        {# Show duration for all video media types. For intros/outros/transitions/compilations, assume video.
          For clips, rely on MIME check to avoid showing for image clips. #}
        {% set is_video = (m.mime_type and m.mime_type.startswith('video')) or type_val in ('intro','outro','transition','compilation') %}
        {% if is_video %}
        <li><span class="text-muted" data-role="duration"><i class="bi bi-clock"></i> {{ m.duration_formatted }}</span></li>
        {% endif %}
            {% if src_url %}
            <li><a class="text-decoration-none" href="{{ src_url }}" target="_blank" rel="noopener"><i class="bi bi-box-arrow-up-right"></i> Original</a></li>
            {% endif %}
            {% if m.tags %}
            <li>
              {% for tag in m.tags.split(',') %}
                {% set t = tag.strip() %}
                {% if t %}<span class="badge bg-secondary me-1">{{ t }}</span>{% endif %}
              {% endfor %}
            </li>
            {% endif %}
          </ul>
        </div>
        <div class="card-footer d-flex justify-content-between align-items-center">
          <button type="button" class="btn btn-sm btn-outline-secondary media-edit" data-id="{{ m.id }}">Edit</button>
          <button type="button" class="btn btn-sm btn-outline-danger media-delete" data-id="{{ m.id }}">Delete</button>
        </div>
      </div>
    </div>
    {% endfor %}
  </div>
  {% else %}
    <p class="text-muted">No media files yet.</p>
  {% endif %}

  {% if pagination and pagination.pages > 1 %}
  <nav class="mt-3">
    <ul class="pagination">
      {% if pagination.has_prev %}
      <li class="page-item"><a class="page-link" href="{{ url_for('main.media_library', page=pagination.prev_num, type=type_filter) }}">Previous</a></li>
      {% endif %}
      <li class="page-item disabled"><span class="page-link">Page {{ pagination.page }} of {{ pagination.pages }}</span></li>
      {% if pagination.has_next %}
      <li class="page-item"><a class="page-link" href="{{ url_for('main.media_library', page=pagination.next_num, type=type_filter) }}">Next</a></li>
      {% endif %}
    </ul>
  </nav>
  {% endif %}
</div>

<script>
// Tag autocomplete functionality
let availableTags = [];
let selectedTagIds = [];

// Load tags on page load
async function loadTags() {
    try {
        const response = await fetch('/api/tags?limit=100');
        const data = await response.json();
        availableTags = data.tags || [];
    } catch (error) {
        console.error('Error loading tags:', error);
    }
}

// Tag autocomplete
function setupTagAutocomplete() {
    const input = document.getElementById('tagFilterInput');
    const container = document.getElementById('selectedTags');

    if (!input || !container) return;

    input.addEventListener('keydown', async function(e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            const query = this.value.trim().toLowerCase();

            if (!query) return;

            // Find matching tag
            const tag = availableTags.find(t =>
                t.name.toLowerCase() === query ||
                t.slug.toLowerCase() === query
            );

            if (tag && !selectedTagIds.includes(tag.id)) {
                selectedTagIds.push(tag.id);
                renderSelectedTags();
                this.value = '';
            } else if (tag) {
                alert('Tag already selected');
                this.value = '';
            } else {
                // Offer to create new tag
                if (confirm(`Tag "${query}" not found. Create it?`)) {
                    await createTag(query);
                }
            }
        }
    });
}

async function createTag(name) {
    try {
        const response = await fetch('/api/tags', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('meta[name="csrf-token"]')?.content || ''
            },
            body: JSON.stringify({ name: name })
        });

        if (response.ok) {
            const tag = await response.json();
            availableTags.push(tag);
            selectedTagIds.push(tag.id);
            renderSelectedTags();
            document.getElementById('tagFilterInput').value = '';
        } else {
            const error = await response.json();
            alert('Error: ' + (error.error || 'Failed to create tag'));
        }
    } catch (error) {
        console.error('Error creating tag:', error);
        alert('Failed to create tag');
    }
}

function renderSelectedTags() {
    const container = document.getElementById('selectedTags');
    const hiddenInput = document.getElementById('tagFilterHidden');

    if (!container || !hiddenInput) return;

    hiddenInput.value = selectedTagIds.join(',');

    if (selectedTagIds.length === 0) {
        container.innerHTML = '';
        return;
    }

    const tags = selectedTagIds.map(id => availableTags.find(t => t.id === id)).filter(Boolean);

    container.innerHTML = '<small class="text-muted">Filtering by:</small> ' + tags.map(tag => `
        <span class="badge me-1" style="background-color: ${tag.color}; cursor: pointer;" onclick="removeTag(${tag.id})">
            ${tag.name} <i class="bi bi-x"></i>
        </span>
    `).join('');
}

function removeTag(tagId) {
    selectedTagIds = selectedTagIds.filter(id => id !== tagId);
    renderSelectedTags();
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', async function() {
    await loadTags();
    setupTagAutocomplete();
});
</script>
{% endblock %}

{% block styles %}
  {{ super() }}
  <link rel="stylesheet" href="{{ url_for('static', filename='vendor/dropzone/dropzone.css') }}" />
  <link href="{{ url_for('static', filename='vendor/videojs/video-js.css') }}" rel="stylesheet" />
{% endblock %}

{% block scripts %}
  {{ super() }}
  <script src="{{ url_for('static', filename='vendor/dropzone/dropzone.min.js') }}"></script>
  <script src="{{ url_for('static', filename='vendor/videojs/video.min.js') }}"></script>
  <script src="{{ url_for('static', filename='js/media_library.js') }}"></script>
{% endblock %}

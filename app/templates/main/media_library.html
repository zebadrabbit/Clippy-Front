{% extends "base.html" %}

{% block content %}
<div class="container py-4">
  <div id="media-config"
       data-upload-url="{{ url_for('main.media_upload') }}"
       data-bulk-url="{{ url_for('main.media_bulk') }}"
       data-delete-url-template="{{ url_for('main.media_delete', media_id=0) }}"
       data-update-url-template="{{ url_for('main.media_update', media_id=0) }}"
       data-preview-url-template="{{ url_for('main.media_preview', media_id=0) }}"
       data-thumbnail-url-template="{{ url_for('main.media_thumbnail', media_id=0) }}"
       class="d-none"></div>
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h2 class="mb-0"><i class="bi bi-collection-play"></i> Media Library</h2>
    <a class="btn btn-outline-primary" href="{{ url_for('main.projects') }}">Go to Projects</a>
  </div>

  <!-- Upload Zone (Dropzone) -->
  <div class="card mb-4">
    <div class="card-header d-flex justify-content-between align-items-center">
      <strong>Upload Media</strong>
      <div class="d-flex gap-2 align-items-center">
        <select id="dz-media-type" class="form-select form-select-sm" style="width:auto">
          {% for t in media_types %}
            <option value="{{ t.value }}">{{ t.name.title() }}</option>
          {% endfor %}
        </select>
      </div>
    </div>
    <div class="card-body">
      <form action="{{ url_for('main.media_upload') }}" class="dropzone" id="media-dropzone">
        <div class="dz-message">Drop files here or click to upload</div>
        <div class="dz-previews mt-3"></div>
      </form>
      <small class="text-muted">Images and videos are supported.</small>
    </div>
  </div>

  <!-- Bulk actions toolbar -->
  <div id="bulk-toolbar" class="alert alert-secondary py-2 d-none">
    <div class="d-flex align-items-center gap-2 flex-wrap">
      <div><strong id="bulk-count">0</strong> selected</div>
      <button id="bulk-select-all" type="button" class="btn btn-sm btn-outline-secondary">Select all</button>
      <button id="bulk-clear" type="button" class="btn btn-sm btn-outline-secondary">Clear</button>
      <div class="vr"></div>
      <select id="bulk-type" class="form-select form-select-sm" style="width:auto">
        <option value="">Change type…</option>
        {% for t in media_types %}
          <option value="{{ t.value }}">{{ t.name.title() }}</option>
        {% endfor %}
      </select>
      <button id="bulk-apply-type" type="button" class="btn btn-sm btn-primary">Apply</button>
      <div class="vr"></div>
      <input id="bulk-tags" class="form-control form-control-sm" placeholder="Set tags (comma-separated)" style="width: 260px;" />
      <button id="bulk-apply-tags" type="button" class="btn btn-sm btn-primary">Set tags</button>
      <button id="bulk-delete" type="button" class="btn btn-sm btn-danger">Delete</button>
    </div>
  </div>

  <form class="mb-3" method="GET" action="{{ url_for('main.media_library') }}">
    <div class="row g-2 align-items-end">
      <div class="col-auto">
        <label class="form-label">Type</label>
        <select class="form-select" name="type">
          <option value="">All</option>
          {% for t in media_types %}
            <option value="{{ t.value }}" {% if type_filter==t.value %}selected{% endif %}>{{ t.name.title() }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-auto">
        <button class="btn btn-primary" type="submit">Filter</button>
      </div>
    </div>
  </form>

  {% if media_files %}
  <div id="media-grid" class="row row-cols-1 row-cols-sm-2 row-cols-md-3 row-cols-lg-4 g-3">
    {% for m in media_files %}
    <div class="col">
      <div class="card h-100 position-relative media-card" data-id="{{ m.id }}" data-mime="{{ m.mime_type }}" data-type="{{ m.media_type.value if m.media_type else '' }}" data-name="{{ m.original_filename }}" data-tags="{{ m.tags or '' }}">
        <div class="position-absolute top-0 start-0 p-2">
          <input class="form-check-input media-select" type="checkbox" value="{{ m.id }}">
        </div>
        {% if m.mime_type.startswith('image') %}
          <img src="{{ url_for('main.media_preview', media_id=m.id) }}" class="card-img-top" alt="{{ m.original_filename }}">
        {% elif m.mime_type.startswith('video') %}
          <button type="button" class="btn p-0 border-0 text-start w-100 video-open position-relative" data-id="{{ m.id }}" style="background:#0d1117;">
            <img src="{{ url_for('main.media_thumbnail', media_id=m.id) }}" class="img-fluid" alt="{{ m.original_filename }}">
            <i class="bi bi-play-circle-fill position-absolute top-50 start-50 translate-middle" style="font-size:2.5rem; opacity:0.85;"></i>
          </button>
        {% else %}
          <div class="card-img-top d-flex align-items-center justify-content-center" style="height:160px; background:#0d1117;">
            <i class="bi bi-file-earmark-text" style="font-size:2rem;"></i>
          </div>
        {% endif %}
        <div class="card-body">
          <div class="fw-semibold text-truncate" title="{{ m.original_filename }}">{{ m.original_filename }}</div>
          <small class="text-muted">{{ m.media_type.value if m.media_type else '' }} • {{ '%.1f'|format(m.file_size_mb) }} MB</small>
          {% if m.tags %}
            <div class="mt-1 small">
              {% for tag in m.tags.split(',') %}
                {% set t = tag.strip() %}
                {% if t %}<span class="badge bg-secondary me-1">{{ t }}</span>{% endif %}
              {% endfor %}
            </div>
          {% endif %}
        </div>
        <div class="card-footer d-flex justify-content-between align-items-center">
          <button type="button" class="btn btn-sm btn-outline-secondary media-edit" data-id="{{ m.id }}">Edit</button>
          <button type="button" class="btn btn-sm btn-outline-danger media-delete" data-id="{{ m.id }}">Delete</button>
        </div>
      </div>
    </div>
    {% endfor %}
  </div>
  {% else %}
    <p class="text-muted">No media files yet.</p>
  {% endif %}

  {% if pagination and pagination.pages > 1 %}
  <nav class="mt-3">
    <ul class="pagination">
      {% if pagination.has_prev %}
      <li class="page-item"><a class="page-link" href="{{ url_for('main.media_library', page=pagination.prev_num, type=type_filter) }}">Previous</a></li>
      {% endif %}
      <li class="page-item disabled"><span class="page-link">Page {{ pagination.page }} of {{ pagination.pages }}</span></li>
      {% if pagination.has_next %}
      <li class="page-item"><a class="page-link" href="{{ url_for('main.media_library', page=pagination.next_num, type=type_filter) }}">Next</a></li>
      {% endif %}
    </ul>
  </nav>
  {% endif %}
</div>
{% endblock %}

{% block styles %}
  {{ super() }}
  <link rel="stylesheet" href="{{ url_for('static', filename='vendor/dropzone/dropzone.css') }}" />
  <link href="{{ url_for('static', filename='vendor/videojs/video-js.css') }}" rel="stylesheet" />
{% endblock %}

{% block scripts %}
  {{ super() }}
  <script src="{{ url_for('static', filename='vendor/dropzone/dropzone.min.js') }}"></script>
  <script src="{{ url_for('static', filename='vendor/videojs/video.min.js') }}"></script>
  <script src="{{ url_for('static', filename='js/media_library.js') }}"></script>
{% endblock %}

{# Step 3: Arrange - Timeline management and media selection #}
<div class="wizard-step d-none" data-step="3">
  <!-- Ingest banner (shown while auto-importing rsynced clips) -->
  <div id="arrange-ingest-banner" class="alert alert-info d-none d-flex align-items-center gap-2 mb-3" role="status" aria-live="polite">
    <div class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></div>
    <div id="arrange-ingest-text">Importing rsynced raw clips…</div>
  </div>

  <!-- Keyboard Shortcuts Help -->
  <div class="alert alert-light border d-flex justify-content-between align-items-center mb-3 d-none">
    <div>
      <strong><i class="bi bi-keyboard"></i> Keyboard Shortcuts:</strong>
      <span class="ms-2 small text-muted">
        <kbd>↑</kbd>/<kbd>↓</kbd> Navigate clips •
        <kbd>Delete</kbd> Remove •
        <kbd>Ctrl+Z</kbd>/<kbd>Ctrl+Y</kbd> Undo/Redo
      </span>
    </div>
  </div>

  <!-- Timeline at top (always visible) -->
  <div class="mb-3">
    <div class="card">
      <div class="card-header">Timeline</div>
      <div class="card-body" id="timeline">
        <div class="timeline-drop-indicator" id="timeline-drop-top"></div>
        <div class="timeline-list" id="timeline-list"></div>
        <div class="timeline-drop-indicator" id="timeline-drop-bottom"></div>
      </div>
      <div class="card-footer bg-dark border-top d-flex justify-content-between align-items-center">
        <div id="timeline-info"></div>
        <div class="text-muted small">
          <i class="bi bi-keyboard"></i>
          <kbd>↑</kbd>/<kbd>↓</kbd> Navigate •
          <kbd>Delete</kbd> Remove •
          <kbd>Ctrl+Z</kbd>/<kbd>Ctrl+Y</kbd> Undo/Redo
        </div>
      </div>
    </div>
  </div>

  <!-- Two-column layout: sidebar navigation + content -->
  <div class="arrange-layout">
    <!-- Left sidebar navigation -->
    <div class="arrange-sidebar">
      <div class="list-group list-group-flush">
        <a href="#" class="list-group-item list-group-item-action active" data-arrange-tab="clips">
          <i class="bi bi-film"></i> Clips
          <span class="badge bg-secondary ms-auto" id="clips-count-badge">0</span>
        </a>
        <a href="#" class="list-group-item list-group-item-action" data-arrange-tab="details">
          <i class="bi bi-gear"></i> Details
        </a>
        <a href="#" class="list-group-item list-group-item-action" data-arrange-tab="intros">
          <i class="bi bi-play-circle"></i> Intros
        </a>
        <a href="#" class="list-group-item list-group-item-action" data-arrange-tab="outros">
          <i class="bi bi-stop-circle"></i> Outros
        </a>
        <a href="#" class="list-group-item list-group-item-action" data-arrange-tab="transitions">
          <i class="bi bi-arrows-angle-contract"></i> Transitions
        </a>
        <a href="#" class="list-group-item list-group-item-action" data-arrange-tab="music">
          <i class="bi bi-music-note-beamed"></i> Music
        </a>
      </div>
    </div>

    <!-- Right content area -->
    <div class="arrange-content">
      <!-- Clips tab -->
      <div class="arrange-tab-content active" data-tab="clips">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h5 class="mb-0">Downloaded Clips</h5>
          <div class="d-flex align-items-center gap-2">
            <small class="text-muted" id="clips-remaining"></small>
            <button class="btn btn-sm btn-primary" id="add-all-clips" title="Add all clips to timeline">
              <i class="bi bi-plus-circle"></i> Add All to Timeline
            </button>
          </div>
        </div>
        <div id="clips-grid" style="min-height: 220px;">
          <div class="text-muted">No clips yet. Download first.</div>
        </div>
      </div>

      <!-- Details tab -->
      <div class="arrange-tab-content" data-tab="details">
        <h5 class="mb-3">Project Details</h5>
        <form id="project-details-form">
          <div class="row g-3">
            <!-- Platform Preset, Format, and FPS on same line -->
            <div class="col-md-6">
              <label class="form-label">Platform Preset</label>
              <select class="form-select" id="details-platform-preset" name="platform_preset">
                <option value="youtube">YouTube (1080p 16:9)</option>
                <option value="youtube_shorts">YouTube Shorts (1080p 9:16 vertical)</option>
                <option value="tiktok">TikTok (1080p 9:16 vertical)</option>
                <option value="instagram_feed">Instagram Feed (1080p 1:1 square)</option>
                <option value="instagram_reel">Instagram Reels (1080p 9:16 vertical)</option>
                <option value="instagram_story">Instagram Stories (1080p 9:16 vertical)</option>
                <option value="twitter">Twitter/X (1080p 16:9)</option>
                <option value="facebook">Facebook (1080p 16:9)</option>
                <option value="twitch">Twitch Clips (1080p 16:9)</option>
              </select>
              <small class="text-muted">Automatically configure export settings</small>
            </div>

            <div class="col-md-3">
              <label class="form-label">Format</label>
              <select class="form-select" id="details-output-format" name="output_format">
                <option value="mp4">MP4</option>
                <option value="webm">WebM</option>
                <option value="mov">MOV</option>
              </select>
            </div>

            <div class="col-md-3">
              <label class="form-label">FPS</label>
              <select class="form-select" id="details-fps" name="fps">
                <option value="24">24</option>
                <option value="30" selected>30</option>
                <option value="60">60</option>
              </select>
            </div>

            <!-- Audio Normalization -->
            <div class="col-12">
              <label class="form-label">Audio Normalization</label>
              <div class="audio-norm-toggle">
                <input type="radio" name="audio_norm_profile" id="details-an-off" value="off">
                <label for="details-an-off">Off</label>
                <input type="radio" name="audio_norm_profile" id="details-an-podcast" value="podcast" data-db="-16">
                <label for="details-an-podcast">Podcast (-16 dB)</label>
                <input type="radio" name="audio_norm_profile" id="details-an-broadcast" value="broadcast" data-db="-2">
                <label for="details-an-broadcast">Broadcast (-2 dB)</label>
                <input type="radio" name="audio_norm_profile" id="details-an-gaming" value="gaming" data-db="-4" checked>
                <label for="details-an-gaming">Gaming (-4 dB)</label>
                <div class="pos" aria-hidden="true"></div>
              </div>
              <input type="hidden" name="audio_norm_db" id="details-audio-norm-db" value="-4">
              <small class="text-muted">Normalize audio levels across all clips</small>
            </div>

            <!-- Tags -->
            <div class="col-12">
              <label class="form-label">Tags</label>
              <input type="text" class="form-control" id="details-tags" name="tags" placeholder="gaming, highlights, twitch">
              <small class="text-muted">Comma-separated tags for organization</small>
            </div>

            <!-- Description -->
            <div class="col-12">
              <label class="form-label">Description</label>
              <textarea class="form-control" id="details-description" name="description" rows="3" placeholder="Project description..."></textarea>
            </div>

            <!-- Save Button -->
            <div class="col-12">
              <button type="submit" class="btn btn-primary">
                <i class="bi bi-save"></i> Save Changes
              </button>
            </div>
          </div>
        </form>
      </div>

      <!-- Intros tab -->
      <div class="arrange-tab-content" data-tab="intros">
        <h5 class="mb-3">Intro Videos</h5>
        <div id="intro-list" class="media-grid">
          <div class="text-muted">No intros found. Upload one under Upload Media.</div>
        </div>
      </div>

      <!-- Outros tab -->
      <div class="arrange-tab-content" data-tab="outros">
        <h5 class="mb-3">Outro Videos</h5>
        <div id="outro-list" class="media-grid">
          <div class="text-muted">No outros found. Upload one under Upload Media.</div>
        </div>
      </div>

      <!-- Transitions tab -->
      <div class="arrange-tab-content" data-tab="transitions">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h5 class="mb-0">Transition Effects</h5>
          <div class="d-flex align-items-center gap-2">
            <div class="form-check form-switch m-0">
              <input class="form-check-input" type="checkbox" id="transitions-randomize">
              <label class="form-check-label" for="transitions-randomize">Randomize</label>
            </div>
            <button class="btn btn-sm btn-outline-primary" id="select-all-transitions">Select All</button>
            <button class="btn btn-sm btn-outline-danger" id="clear-all-transitions">Clear All</button>
          </div>
        </div>
        <div id="transition-list" class="media-grid">
          <div class="text-muted">No transitions found. Upload under Upload Media.</div>
        </div>
      </div>

      <!-- Music tab -->
      <div class="arrange-tab-content" data-tab="music">
        <h5 class="mb-3">Background Music</h5>
        <div class="mb-4">
          <div class="fw-semibold mb-2">Select Music Track</div>
          <div id="music-list" class="media-grid">
            <div class="text-muted">No music tracks found. Upload under Upload Media.</div>
          </div>
        </div>
        <div class="card bg-dark">
          <div class="card-header">Music Settings</div>
          <div class="card-body">
            <div class="row g-3">
              <div class="col-md-4">
                <label for="music-volume" class="form-label">Volume</label>
                <div class="d-flex align-items-center gap-2">
                  <input type="range" class="form-range" id="music-volume" min="0" max="100" value="30" step="1">
                  <span id="music-volume-display" class="text-muted small" style="min-width: 3rem;">30%</span>
                </div>
              </div>
              <div class="col-md-4">
                <label for="music-start-mode" class="form-label">Start Music</label>
                <select class="form-select" id="music-start-mode">
                  <option value="start">From beginning</option>
                  <option value="after_intro" selected>After intro</option>
                </select>
              </div>
              <div class="col-md-4">
                <label for="music-end-mode" class="form-label">End Music</label>
                <select class="form-select" id="music-end-mode">
                  <option value="before_outro" selected>Before outro</option>
                  <option value="end">At the end</option>
                </select>
              </div>
            </div>

            <!-- Advanced Ducking Settings (Collapsible) -->
            <div class="mt-3">
              <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#ducking-settings" aria-expanded="false" aria-controls="ducking-settings">
                <i class="bi bi-sliders"></i> Advanced: Audio Ducking
              </button>
              <div class="collapse mt-3" id="ducking-settings">
                <div class="card card-body bg-dark border-secondary">
                  <p class="small text-muted mb-3">
                    <i class="bi bi-info-circle"></i> Audio ducking automatically lowers background music volume when clip audio is present. Adjust these parameters to fine-tune the effect.
                  </p>
                  <div class="row g-3">
                    <div class="col-md-6">
                      <label for="duck-threshold" class="form-label">
                        Threshold
                        <span class="text-muted small">(when to start ducking)</span>
                      </label>
                      <div class="d-flex align-items-center gap-2">
                        <input type="range" class="form-range" id="duck-threshold" min="0" max="100" value="2" step="1">
                        <span id="duck-threshold-display" class="text-muted small" style="min-width: 4rem;">0.02</span>
                      </div>
                      <small class="text-muted">Lower = more sensitive (ducks with quieter audio)</small>
                    </div>
                    <div class="col-md-6">
                      <label for="duck-ratio" class="form-label">
                        Ratio
                        <span class="text-muted small">(how much to reduce)</span>
                      </label>
                      <div class="d-flex align-items-center gap-2">
                        <input type="range" class="form-range" id="duck-ratio" min="1" max="20" value="20" step="1">
                        <span id="duck-ratio-display" class="text-muted small" style="min-width: 4rem;">20:1</span>
                      </div>
                      <small class="text-muted">Higher = more aggressive reduction</small>
                    </div>
                    <div class="col-md-6">
                      <label for="duck-attack" class="form-label">
                        Attack
                        <span class="text-muted small">(how fast to duck)</span>
                      </label>
                      <div class="d-flex align-items-center gap-2">
                        <input type="range" class="form-range" id="duck-attack" min="1" max="100" value="10" step="1">
                        <span id="duck-attack-display" class="text-muted small" style="min-width: 4rem;">1.0ms</span>
                      </div>
                      <small class="text-muted">Lower = faster response (instant ducking)</small>
                    </div>
                    <div class="col-md-6">
                      <label for="duck-release" class="form-label">
                        Release
                        <span class="text-muted small">(how fast to recover)</span>
                      </label>
                      <div class="d-flex align-items-center gap-2">
                        <input type="range" class="form-range" id="duck-release" min="10" max="1000" value="250" step="10">
                        <span id="duck-release-display" class="text-muted small" style="min-width: 4rem;">250ms</span>
                      </div>
                      <small class="text-muted">Higher = smoother fade-back</small>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="text-center mt-3">
    <div class="timeline-confirm-box">
      <div class="form-check">
        <input class="form-check-input" type="checkbox" id="arranged-confirm">
        <label class="form-check-label" for="arranged-confirm">I have arranged my timeline</label>
      </div>
    </div>
  </div>
  <div class="d-flex justify-content-between wizard-nav mt-4">
    <button class="btn btn-outline-secondary" data-prev="2">
      <i class="bi bi-arrow-left"></i> Back: Get Clips
    </button>
    <button class="btn btn-success btn-glow btn-shadow-dark" id="mark-ready-btn" disabled>
      <i class="bi bi-check-circle"></i> Mark Ready & Continue to Compile
    </button>
  </div>
</div>

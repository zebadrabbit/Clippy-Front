# Worker Environment Configuration
# Copy this to .env and fill in your values

# ============================================================================
# REQUIRED: Celery Configuration
# ============================================================================

# Redis/Celery broker and result backend
# Must match the main Flask app's broker
CELERY_BROKER_URL=redis://your-redis-host:6379/0
CELERY_RESULT_BACKEND=redis://your-redis-host:6379/0

# ============================================================================
# REQUIRED: Database Access
# ============================================================================

# Workers currently require database access to function
# See WORKER_API_MIGRATION.md for long-term plan to eliminate this dependency
#
# SECURITY NOTE: Workers run outside the DMZ. Mitigate risk by:
# - Using a read-write DB user with minimal privileges
# - Restricting access via VPN/firewall
# - Monitoring worker DB queries
DATABASE_URL=postgresql://clippy_worker:CHANGEME@db-host:5432/clippy_front

# ============================================================================
# Worker Configuration
# ============================================================================

# Worker concurrency (number of parallel tasks)
# For downloads: 4-8 (I/O bound)
# For compilation with GPU: 1-2 (GPU/CPU intensive)
CELERY_CONCURRENCY=4

# Queues this worker listens to (comma-separated)
# Options: gpu, cpu, celery
CELERY_QUEUES=gpu,celery

# Use GPU queue for compilation tasks
USE_GPU_QUEUE=true

# ============================================================================
# Storage Configuration
# ============================================================================

# Path to shared instance storage (must match Flask app)
# This should be a shared volume or network mount
HOST_INSTANCE_PATH=/mnt/clippyfront

# Instance path inside container
CLIPPY_INSTANCE_PATH=/app/instance

# Require instance mount to be present (fail if missing)
REQUIRE_INSTANCE_MOUNT=1

# Temp directory (keep on instance filesystem to avoid EXDEV errors)
TMPDIR=/app/instance/tmp

# ============================================================================
# Artifact Export Configuration (Optional)
# ============================================================================

# Enable artifact export to push final renders to ingest server
# See docs/gpu-worker.md for setup instructions

# Worker identifier (used as subdirectory on ingest server)
WORKER_ID=gpu-worker-01

# Ingest server connection details
INGEST_HOST=your-ingest-host.com
INGEST_USER=ingest
INGEST_PORT=22
INGEST_PATH=/srv/ingest

# Rsync push interval (seconds)
PUSH_INTERVAL=60

# Watch mode: auto (inotify + periodic), inotify, periodic
WATCH_MODE=auto

# Cleanup mode after successful push: none, move, delete
CLEANUP_MODE=none

# Rsync bandwidth limit (KB/s, optional)
# RSYNC_BWLIMIT=10000

# ============================================================================
# Worker API Configuration (Future Use)
# ============================================================================

# These will be used when workers migrate to API-based communication
# Currently optional - see WORKER_API_MIGRATION.md

# Flask app URL for API calls
FLASK_APP_URL=https://your-flask-server.com

# Shared secret for worker authentication
# Generate with: python -c "import secrets; print(secrets.token_urlsafe(32))"
# WORKER_API_KEY=your-secure-key-here

# ============================================================================
# Optional: Binary Paths
# ============================================================================

# Usually auto-detected, only set if needed
# FFMPEG_BINARY=ffmpeg
# YT_DLP_BINARY=yt-dlp

# ============================================================================
# Optional: Delivery Webhooks
# ============================================================================

# Webhook to call after successful artifact delivery
# DELIVERY_WEBHOOK_URL=https://your-webhook.com/notify
# DELIVERY_WEBHOOK_TOKEN=your-webhook-secret
# DELIVERY_WEBHOOK_TIMEOUT=5

# ============================================================================
# Optional: Retention/Cleanup
# ============================================================================

# Days to retain artifacts before cleanup
# RETENTION_DAYS=30

# Minimum free space (GB) to maintain on artifact volume
# MIN_FREE_GB=10

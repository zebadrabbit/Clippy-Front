# Repository structure and directory guide

Updated: 2025-10-30

This guide explains what each directory is for and what you can do there. It lists directories that currently contain more than two files, plus a few key runtime folders for context. Paths are relative to the repository root.

Notes
- “More than two files” is counted at that directory level (not recursively). Subdirectories are mentioned where useful.
- Runtime/generated folders (e.g., logs, instance/tmp, __pycache__) are explained briefly and usually don’t require manual edits.

## app/
Flask application package with blueprints, models, tasks, assets, and templates.

- You’ll typically add business logic, routes, and background tasks here.
- Key subfolders (with >2 files) are documented below.

### app/auth/
Authentication blueprint.
- Purpose: Login/register, profile, and account settings.
- Do here: Modify auth routes and forms, extend account settings, enforce security policies.
- Files: `__init__.py`, `routes.py`, `forms.py`.

### app/tasks/
Celery tasks and helpers.
- Purpose: Background jobs such as clip downloads, compilation, automation scheduler, maintenance.
- Do here: Add/change Celery tasks, tune queue behavior, and task utilities.
- Notable files: `celery_app.py`, `video_processing.py`, `automation.py`, `media_maintenance.py`, `tier_limits.py`, `path_utils.py`.

### app/templates/admin/
Admin UI templates.
- Purpose: Admin dashboards, system info, themes CRUD, project/user management.
- Do here: Adjust admin views and forms, add pages for new admin features.
- Examples: `dashboard.html`, `system_info.html`, `projects.html`, `users.html`, `themes_form.html`, `tiers_list.html`.

### app/templates/main/
Main UI templates.
- Purpose: Project wizard, media library, projects, public pages, docs.
- Do here: Update the wizard flow and pages like `media_library.html`, `project_wizard.html`, `projects.html`.
- Examples: `index.html`, `project_wizard.html`, `media_library.html`, `projects.html`, `automation.html`, `project_details.html`.

### app/templates/auth/
Auth-related templates.
- Purpose: Login, register, profile, account settings.
- Do here: Modify forms and layouts for authentication and profile pages.
- Examples: `login.html`, `register.html`, `profile.html`, `account_settings.html`.

### app/templates/errors/
Error pages.
- Purpose: Pretty error views for common HTTP errors.
- Do here: Customize error messaging and support links.
- Examples: `404.html`, `429.html`, `500.html`.

### app/static/js/
Front-end JavaScript for the UI.
- Purpose: Behavior for the media library, wizard, admin panels, toasts, and general UI.
- Do here: Add/adjust JS modules; keep logic modular and page-scoped.
- Examples: `wizard.js`, `media_library.js`, `admin_theme_form.js`, `ui.js`, `toasts.js`.

### app/static/vendor/
Locally served, third-party assets (CSP-friendly).
- Purpose: Bootstrap colorpicker, Dropzone, jQuery, Video.js, etc.
- Do here: Refresh vendor assets via `scripts/fetch_vendor_assets.sh`; avoid hotlinking CDNs.
- Subfolders: `bootstrap-colorpicker/`, `dropzone/`, `jquery/`, `videojs/`.

## bin/
Bundled helper binaries (optional convenience).
- Purpose: Local ffmpeg/ffprobe/yt-dlp for development or controlled deployments.
- Do here: Replace or update binaries; point env vars (`FFMPEG_BINARY`, `YT_DLP_BINARY`) to prefer these.
- Files: `ffmpeg`, `ffprobe`, `yt-dlp`.

## docker/
Container build and compose helpers for workers.
- Purpose: GPU worker images and compose variants (single or multi-container worker+sync).
- Do here: Build worker images, adjust compose files for your environment and GPU runtime.
- Files: `worker.Dockerfile`, `worker-combined.Dockerfile`, `docker-compose.gpu-worker.yml`, `docker-compose.gpu-worker-sync.yml`, `docker-compose.gpu-worker.example.yml`.

## docs/
Documentation for workers, networking, storage, tiers.
- Purpose: How-tos and deployment guides.
- Do here: Add/update design docs and runbooks.
- Files: `workers.md`, `gpu-worker.md`, `wireguard.md`, `samba-and-mounts.md`, `tiers-and-quotas.md`.

## logs/
Runtime logs (if running locally).
- Purpose: Application, worker, and beat logs for debugging.
- Do here: Tail or rotate logs; avoid committing large logs.
- Files: `app.log`, `worker.log`, `beat.log`.

## migrations/
Database migration scaffolding (Flask-Migrate/Alembic).
- Purpose: Migration environment and templates.
- Do here: Manage Alembic env and templates; most work happens in `migrations/versions/`.
- Files: `alembic.ini`, `env.py`, `script.py.mako`, `README`.

### migrations/versions/
Individual migration scripts.
- Purpose: Schema changes tracked over time.
- Do here: Add new migration files via Flask-Migrate; review autogenerated diffs.
- Files: Multiple migration scripts like `084c3bc02dc5_*.py`, `b7f1c2d3e4f5_*.py`.

## scripts/
Utilities and operational scripts.
- Purpose: Setup, vendor assets, DB utilities, health checks, worker helpers.
- Do here: Automate repetitive tasks and ops actions.
- Examples: `fetch_vendor_assets.sh`, `install_local_binaries.sh`, `cleanup_avatars.py`, `reindex_media.py`, `check_nvenc.py`, `wg_*`.

### scripts/worker/
Worker-side sync and deployment helpers.
- Purpose: Artifact scanner/pusher (rsync over SSH), retention, supervisor configs, and a deployment helper.
- Do here: Operate the rsync sidecar, smoke test artifacts, or provision workers.
- Key files: `clippy-scan.sh`, `clippy-push.sh`, `clippy-retain.sh`, `supervisord.conf`, `smoke-artifact.sh`, `deploy_gpu_worker.sh`.

## tests/
Pytest suite.
- Purpose: API, media, project flows, quotas/tiers, compile selection, signed media.
- Do here: Add tests for new features and bug fixes; keep fast and focused.
- Files: `test_api.py`, `test_media.py`, `test_projects.py`, `test_quotas.py`, `test_tier_limits.py`, `test_signed_media.py`, etc.

## secrets/
Local secrets for the worker sync stack (Docker secrets source).
- Purpose: SSH key and known_hosts for artifact sync.
- Do here: Create/manage `rsync_key` (ED25519) and `known_hosts` via `ssh-keyscan`. Public key (`rsync_key.pub`) is for `authorized_keys` on the ingest host.
- Files: `rsync_key`, `rsync_key.pub`, `known_hosts`.

---

## Other notable paths (may have ≤2 files but important)
- app/: Additional modules like `models.py`, `storage.py`, `ffmpeg_config.py`, `logging_config.py`, and blueprint packages (`admin/`, `api/`, `main/`, `integrations/`, `security/`). See `.github/copilot-instructions.md` for an architecture overview.
- app/templates/: Top-level layout `base.html` and subfolders listed above.
- app/static/css/: Base styles (two files): `base.css`, `wizard.css`.
- instance/: Runtime data root (outside of git in production). Includes `assets/` (e.g., `static.mp4`, avatars), `data/`, `uploads/`, `logs/`, `tmp/`. See `instance/data-structure.md`.
- compose.worker.yaml: Compose stack for worker + artifact sync (named volume `artifacts` and Docker secrets for SSH).
- Dockerfile.worker: Sidecar image for artifact scanning and pushing.
- README.md: Project overview and Worker Setup.

## See also
- docs/workers.md for broader worker patterns and storage/networking.
- docs/gpu-worker.md for GPU worker + artifact sync deployment.
- .github/copilot-instructions.md for architecture and development guardrails.
